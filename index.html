<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="I kown today that i am i">
<meta property="og:type" content="website">
<meta property="og:title" content="YangL">
<meta property="og:url" content="http://www.lwfby.cn/index.html">
<meta property="og:site_name" content="YangL">
<meta property="og:description" content="I kown today that i am i">
<meta property="article:author" content="YangL">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.lwfby.cn/"/>





  <title>YangL</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YangL</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Write good code</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="æœç´¢..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lwfby.cn/2020/12/27/mybatis/mybatis-springboot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YangL">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YangL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/27/mybatis/mybatis-springboot/" itemprop="url">mybatis-springboot</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-12-27T22:10:47+08:00">
                2020-12-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MyBatis/" itemprop="url" rel="index">
                    <span itemprop="name">MyBatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  3.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  14
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h4><p>â€‹    MyBatis ä¸ SpringBoot æ•´åˆæ“ä½œ.  åœ¨è¿™æ¬¡æ•´åˆçš„è¿‡ç¨‹ä¸­,å†æ¬¡æ˜ç™½è‡ªå·±æ¯«æ— ç–‘é—®çš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ‰‹æ®‹çš„åŒå­¦äº†.</p>
<p>â€‹    è¿™é‡Œæˆ‘ä»¬æ˜¯åŸºäº sql è¯­å¥å†™åœ¨ xml é‡Œé¢è¿›è¡Œæ•´åˆçš„æ“ä½œ.</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h4><p>â€‹      è¿™é‡Œè¯´ä¸‹åˆ›å»ºä¸€ä¸ª å…¥é—¨ é¡¹ç›®çš„å¤§è‡´æµç¨‹.</p>
<p>â€‹       å…ˆåˆ›å»ºä¸€ä¸ª SpringBoot é¡¹ç›® ,  å¼•å…¥ä¾èµ– :   <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/pom.xml" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/pom.xml</a></p>
<p>â€‹        åˆ›å»º MyBatis çš„é…ç½®æ–‡ä»¶ä¿¡æ¯ :     <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/mybatis-config.xml" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/mybatis-config.xml</a></p>
<p>â€‹        åˆ›å»ºæŸ¥è¯¢çš„ sql è¯­å¥ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ mapper æ–‡ä»¶ : <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-boot-hello/src/main/resources/mapper" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-boot-hello/src/main/resources/mapper</a></p>
<p>â€‹       application.properties :  <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/application.properties" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/resources/application.properties</a></p>
<p>â€‹      æ‰«æ mapper æ¥å£ :  @MapperScan(basePackages = {â€œcom.iyang.mybatis.springboot.hello.mapperâ€})  <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/java/com/iyang/mybatis/springboot/hello/MybatisSpringBootHelloApplication.java" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-boot-hello/src/main/java/com/iyang/mybatis/springboot/hello/MybatisSpringBootHelloApplication.java</a></p>
<p>è¿™é‡Œæ˜¯æ²¡æœ‰å¼•å…¥ web ä¾èµ–çš„ , ç›´æ¥å¯åŠ¨ main æ–¹æ³• ,  ç„¶åå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æŸ¥è¯¢å‡ºæ¥çš„ç»“æœäº†.</p>
<p>å¦‚æœä½ ç†Ÿæ‚‰ SpringBoot æºç çš„è¯ï¼Œå°±ä¼šæ™“å¾—æœ‰ä¸€ä¸ªè‡ªåŠ¨è£…é…çš„æ“ä½œ.</p>
<p>å¦‚æœä¸ç†Ÿæ‚‰çš„è¯ï¼Œé‚£ä¹ˆå°±åªèƒ½é€šè¿‡ @MapperScan(basePackages =  {â€œcom.iyang.mybatis.springboot.hello.mapperâ€}) å»çœ‹ ,  è¿™æ ·æœ‰äº›æ˜¯ä¾èµ–è‡ªåŠ¨è£…é…ï¼ˆspring.factoriesï¼‰ ä¸­çš„é…ç½®åŠ è½½çš„,  æ‰€ä»¥è¿™é‡Œå»ºè®®åœ¨çœ‹ä¹‹å‰ï¼Œå¦‚æœæ˜¯æœ‰ä¸€ç‚¹ SpringBoot  æ‰©å±•çš„çŸ¥è¯†äº†è§£æ˜¯å¾ˆå¥½çš„ã€‚å¦‚æœæ²¡æœ‰æ€ä¹ˆåŠå‘¢ï¼Ÿæ²¡æœ‰å°±æ¥çœ‹æˆ‘æ¥ä¸‹æ¥çš„å†…å®¹ã€‚</p>
<p>å…¶å®è¿™ä¸ªåœ°æ–¹ä½ ä»”ç»†æƒ³ä¸‹ï¼Œåœ¨ MyBatis ä¸ Spring æ•´åˆçš„æ—¶å€™ï¼Œé€šè¿‡ xml çš„æ–¹å¼ç»™ MyBatis çš„bean å·²ç»  mybatis-spring ä¸­è‡ªå·±å†™çš„æ‰«æç±»ï¼Œæœ€åå°†æ‰«æå‡ºæ¥çš„ bd åœ¨è¿˜æ²¡åˆå§‹åŒ–ä¹‹å‰ï¼Œå°†bd çš„beanClass æ›¿æ¢ä¸ºæˆ‘ä»¬çš„ä»£ç†ç±».</p>
<p>é‚£ä¹ˆï¼ŒSpringBoot ä¸ MyBatis æ•´åˆçš„æ—¶å€™ï¼Œæœ€åè¦åšçš„äº‹æƒ…æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯å°† MyBatis çš„ä¿¡æ¯æ³¨å…¥åˆ° SpringBoot æ¥å‘¢ï¼Ÿåªä¸è¿‡ï¼ŒSpringBoot å°±ä¸åƒ Spring ä¸€æ ·äº†ï¼Œè¿˜å°† bean çš„ä¿¡æ¯é…ç½®åˆ° xml æ–‡ä»¶ä¸­.</p>
<p>äºæ˜¯ï¼Œæ¥ä¸‹æ¥è·Ÿæˆ‘çš„é˜…è¯»&amp;åˆ†ææ¥ä¸€æ­¥ä¸€æ­¥çš„å¾€ä¸‹çœ‹.</p>
<h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><h4 id="æ–¹æ³•åˆ†æ"><a href="#æ–¹æ³•åˆ†æ" class="headerlink" title="æ–¹æ³•åˆ†æ"></a>æ–¹æ³•åˆ†æ</h4><p>â€‹     <strong>å…³æ³¨ç‚¹ä¸€</strong> :   è¿™é‡Œæˆ‘ä»¬ç‚¹å…¥åˆ°    org.mybatis.spring.annotation.MapperScan æ³¨è§£é‡Œé¢æ¥ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª   @Import(MapperScannerRegistrar.class) , äºæ˜¯æˆ‘ä»¬é¡ºæ‰‹è·Ÿè¿›æ¥ :   org.mybatis.spring.annotation.MapperScannerRegistrar ,  ä»åå­—ä¸Šæ¥ï¼Œè¿™ä¸ªç±»å°±åšäº†ä¸€ä¸ªæ‰«æmapperå¹¶ä¸”å°†mapperæ³¨å…¥åˆ°Springå®¹å™¨ä¸­æ¥çš„äº‹æƒ….</p>
<p>â€‹    <strong>å…³æ³¨ç‚¹äºŒ</strong> :   æˆ‘ä»¬ä»å¼•å…¥è¿›æ¥çš„ä¾èµ–æ¥çœ‹,    mybatis-spring-boot-starter-2.1.2.jar  è·Ÿè¿›åˆ° è¿™ä¸ªåŒ…æ¥ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªåŒ…ä¹Ÿæ˜¯å¼•å…¥ä¸€äº›è¿›æ¥.   mybatis/mybatis-spring/spring-boot-starter-jdbc  è¿™ä¸‰ä¸ªä¾èµ–æˆ‘ä»¬åº”è¯¥ä¸æ˜¯å¾ˆé™Œç”Ÿçš„ï¼Œmybatis-spring-boot-autoconfigureä¸»è¦æ¥çœ‹è¿™ä¸ªã€‚    spring.factories çš„ä½œç”¨å¤§å®¶å¯ä»¥å»äº†è§£ä¸‹ï¼ŒSpringBootå¾ˆå¤š EnableAutoConfiguration  çš„é…ç½®éƒ½æ˜¯æ”¾å…¥åœ¨è¿™ä¸ªé‡Œé¢çš„ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå»ä¸€å±‚ä¸€å±‚çš„å»è¯»å– spring.factories æ–‡ä»¶çš„å†…å®¹ã€‚  è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹ :   org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration è¿™ä¸ªç±»çš†å¯.</p>
<p>â€‹     MyBatis åœ¨ properties ä¸­çš„é…ç½®æ–‡ä»¶è¯»å– :  org.mybatis.spring.boot.autoconfigure.MybatisProperties</p>
<p>å¯ä»¥çœ‹åˆ°è¯¥ç±»ä¸Šæ˜¯æœ‰: @ConfigurationProperties(prefix = MybatisProperties.MYBATIS_PREFIX)</p>
<p>äºæ˜¯æˆ‘ä»¬ä¸€ä¸‹å­å°±å¤šäº†äºŒä¸ªå…³æ³¨ç‚¹, è¿™é‡Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¹‹å‰çš„  ç¬¨æ–¹æ³•ï¼Œ  å½“ä½ å¯¹æ•´åˆæµç¨‹æ‰§è¡Œä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥åœ¨è¿™äºŒä¸ªå…³æ³¨ç‚¹çš„é‡å†™æ–¹æ³•ä¸Šéƒ½æ‰“ç®—æ–­ç‚¹ï¼Œçœ‹ä¸‹å…¶æ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ‰§è¡Œçš„.    å¼„æ¸…æ¥šäº†æ‰§è¡Œæµç¨‹,å°±å¯ä»¥è·Ÿç€æµç¨‹æ¥ä¸€æ­¥ä¸€æ­¥çš„åˆ†æ. ä»æˆ‘ä»¬æ‰“ä¸Š debug å¼€å§‹ï¼Œå¾€ä¸‹çš„æ‰§è¡Œæµç¨‹å°±æ˜¯ä¸€æ­¥ä¸€æ­¥æ¥çš„ï¼Œé‚£ä¹ˆå°±è·Ÿç€æˆ‘ä»¬debug  çš„æ–¹æ³•æ¥ä¸€æ­¥ä¸€æ­¥çš„åˆ†æ.</p>
<p>org.mybatis.spring.annotation.MapperScannerRegistrar#registerBeanDefinitions() â€”&gt;     org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#MybatisAutoConfiguration  â€”&gt;  org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#afterPropertiesSet  â€”-&gt;    org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory  â€”&gt;   org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionTemplate() â€”-&gt;</p>
<p><strong>org.mybatis.spring.annotation.MapperScannerRegistrar#registerBeanDefinitions() æ–¹æ³•</strong> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * &#123;@inheritDoc&#125;</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">&#x2F;***</span><br><span class="line">*  è¿™é‡Œæ˜¯è·å–å‡ºäº†æ³¨è§£é‡Œé¢å±æ€§çš„å€¼. </span><br><span class="line">*&#x2F;   </span><br><span class="line">  AnnotationAttributes mapperScanAttrs &#x3D; </span><br><span class="line">  AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(MapperScan.class.getName()));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; èƒ½è·å–åˆ°æœ‰æ³¨è§£,ä¸æ˜¯null,å°±ä¼šèµ°åˆ°ä¸‹é¢çš„ä»£ç ä¸­æ¥.    </span><br><span class="line">  if (mapperScanAttrs !&#x3D; null) &#123;</span><br><span class="line">    registerBeanDefinitions(importingClassMetadata, mapperScanAttrs, registry,</span><br><span class="line">        generateBaseBeanName(importingClassMetadata, 0));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line">* </span><br><span class="line">*&#x2F;</span><br><span class="line">  void registerBeanDefinitions(AnnotationMetadata annoMeta, AnnotationAttributes annoAttrs,</span><br><span class="line">      BeanDefinitionRegistry registry, String beanName) &#123;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; åˆ©ç”¨ BeanDefinitionBuilder æ„é€ è€…,ä¼ å…¥äº†ä¸€ä¸ª MapperScannerConfigurer.class</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œçš„ builderé‡Œé¢æ˜¯æœ‰ä¸€ä¸ª bd çš„,é‡Œé¢çš„beanClasså°±æ˜¯ MapperScannerConfigurer      </span><br><span class="line">    BeanDefinitionBuilder builder &#x3D; BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);</span><br><span class="line">    builder.addPropertyValue(&quot;processPropertyPlaceHolders&quot;, true);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œè·å– @MapperScan æ³¨è§£çš„å±æ€§, å¦‚æœå±æ€§æ˜¯æœ‰å€¼çš„è¯,å°±ä¼šè®¾ç½®åˆ° builder ä¸­æ¥. </span><br><span class="line">    Class&lt;? extends Annotation&gt; annotationClass &#x3D; annoAttrs.getClass(&quot;annotationClass&quot;);</span><br><span class="line">    if (!Annotation.class.equals(annotationClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;annotationClass&quot;, annotationClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; markerInterface &#x3D; annoAttrs.getClass(&quot;markerInterface&quot;);</span><br><span class="line">    if (!Class.class.equals(markerInterface)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;markerInterface&quot;, markerInterface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends BeanNameGenerator&gt; generatorClass &#x3D; annoAttrs.getClass(&quot;nameGenerator&quot;);</span><br><span class="line">    if (!BeanNameGenerator.class.equals(generatorClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;nameGenerator&quot;, BeanUtils.instantiateClass(generatorClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends MapperFactoryBean&gt; mapperFactoryBeanClass &#x3D; annoAttrs.getClass(&quot;factoryBean&quot;);</span><br><span class="line">    if (!MapperFactoryBean.class.equals(mapperFactoryBeanClass)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;mapperFactoryBeanClass&quot;, mapperFactoryBeanClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String sqlSessionTemplateRef &#x3D; annoAttrs.getString(&quot;sqlSessionTemplateRef&quot;);</span><br><span class="line">    if (StringUtils.hasText(sqlSessionTemplateRef)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;sqlSessionTemplateBeanName&quot;, annoAttrs.getString(&quot;sqlSessionTemplateRef&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String sqlSessionFactoryRef &#x3D; annoAttrs.getString(&quot;sqlSessionFactoryRef&quot;);</span><br><span class="line">    if (StringUtils.hasText(sqlSessionFactoryRef)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;sqlSessionFactoryBeanName&quot;, annoAttrs.getString(&quot;sqlSessionFactoryRef&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ä¸‹é¢æ˜¯æ ¹æ® value&#x2F;basePackages&#x2F;basePackageClasses æ¥è·å–åŒ…çš„ä¿¡æ¯,</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œä¹Ÿå°±è¯´, æˆ‘ä»¬å¯ä»¥è·Ÿç€è¿™ä¸‰ä¸ªå±æ€§æ¥é…ç½®åŒ…ä¿¡æ¯.      </span><br><span class="line">    List&lt;String&gt; basePackages &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">    basePackages.addAll(</span><br><span class="line">        Arrays.stream(annoAttrs.getStringArray(&quot;value&quot;)).filter(StringUtils::hasText).collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">    basePackages.addAll(Arrays.stream(annoAttrs.getStringArray(&quot;basePackages&quot;)).filter(StringUtils::hasText)</span><br><span class="line">        .collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">    basePackages.addAll(Arrays.stream(annoAttrs.getClassArray(&quot;basePackageClasses&quot;)).map(ClassUtils::getPackageName)</span><br><span class="line">        .collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¦‚æœæ²¡æœ‰è·å–åˆ°åŒ…çš„ä¿¡æ¯,é‚£å°±æ ¹æ®æ³¨è§£æ‰€åœ¨çš„è·¯å¾„æ¥è·å–é»˜è®¤çš„è·¯å¾„.      </span><br><span class="line">    if (basePackages.isEmpty()) &#123;</span><br><span class="line">      basePackages.add(getDefaultBasePackage(annoMeta));</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; å¦‚æœæœ‰lazyInitializationå±æ€§çš„å€¼,å°±è®¾ç½®åˆ° builder ä¸­æ¥. </span><br><span class="line">    String lazyInitialization &#x3D; annoAttrs.getString(&quot;lazyInitialization&quot;);</span><br><span class="line">    if (StringUtils.hasText(lazyInitialization)) &#123;</span><br><span class="line">      builder.addPropertyValue(&quot;lazyInitialization&quot;, lazyInitialization);</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; æ·»åŠ åŒ…çš„å±æ€§</span><br><span class="line">    builder.addPropertyValue(&quot;basePackage&quot;, StringUtils.collectionToCommaDelimitedString(basePackages));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;  getBeanDefinition() åœ¨è¿”å› bd ä¹‹å‰ï¼Œä¼šèµ°ä¸€ä¸ª validate æ–¹æ³•.</span><br><span class="line">&#x2F;&#x2F; org.springframework.beans.factory.support.DefaultListableBeanFactory#registerBeanDefinition</span><br><span class="line">&#x2F;&#x2F; èµ°è¿™ä¸ªæ–¹æ³•æ¥å°† bd ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæ³¨å…¥è¿›å»çš„ beanName çš„å€¼æ˜¯ :  com.iyang.mybatis.springboot.hello.MybatisSpringBootHelloApplication#MapperScannerRegistrar#0</span><br><span class="line">&#x2F;&#x2F; æ³¨å…¥è¿›å»çš„ bd çš„ beanClass : class org.mybatis.spring.mapper.MapperScannerConfigurer </span><br><span class="line">    registry.registerBeanDefinition(beanName, builder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œå¯ä»¥æ€»ç»“ä¸‹ registerBeanDefinitions æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯å°† @MapperScan  çš„æ³¨è§£å±æ€§çš„å€¼ç»™åˆ°  : BeanDefinitionBuilder builder, è¯¥builder  é‡Œé¢æœ‰bd,bdçš„beanClassæ˜¯MapperScannerConfigurerï¼Œæœ€åå°†MapperScannerConfigureræ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</strong></p>
<hr>
<p><strong>MyBatisAutoConfiguration()  æœ‰å‚æ„é€ å‡½æ•°</strong></p>
<p>è¿™é‡Œæˆ‘ä»¬åœ¨ MybatisAutoConfiguration æ„é€ å‡½æ•°ä¸Šæ‰“ä¸Šæ–­ç‚¹, å¯ä»¥æ ¹æ® æ–­ç‚¹æ¥åˆ†æï¼Œèµ°å®ŒğŸ‘†é¢çš„æ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬ç‚¹å‡»èµ°åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹æ¥ï¼Œå°±ä¼šèµ°åˆ° è¿™ä¸ª æœ‰å‚æ„é€ å‡½æ•°.</p>
<p>å¦‚æœå¥½å¥‡çš„è¯ï¼Œå¯ä»¥è·Ÿè¸ªdebug çš„å †æ ˆä¿¡æ¯ï¼Œæ˜¯æ€ä¹ˆèµ°åˆ°è¿™æ­¥æ¥çš„. èµ°åˆ°è¿™ä¸ªæ–¹æ³•æ¥ : finishBeanFactoryInitialization(beanFactory) è¿™æ˜¯æœ€åˆçš„å…¥å£.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public MybatisAutoConfiguration(MybatisProperties properties, ObjectProvider&lt;Interceptor[]&gt; interceptorsProvider,</span><br><span class="line">    ObjectProvider&lt;TypeHandler[]&gt; typeHandlersProvider, ObjectProvider&lt;LanguageDriver[]&gt; languageDriversProvider,</span><br><span class="line">    ResourceLoader resourceLoader, ObjectProvider&lt;DatabaseIdProvider&gt; databaseIdProvider,</span><br><span class="line">    ObjectProvider&lt;List&lt;ConfigurationCustomizer&gt;&gt; configurationCustomizersProvider) &#123;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œéƒ½æ˜¯èµ‹å€¼    </span><br><span class="line">  this.properties &#x3D; properties;</span><br><span class="line">  this.interceptors &#x3D; interceptorsProvider.getIfAvailable();</span><br><span class="line">  this.typeHandlers &#x3D; typeHandlersProvider.getIfAvailable();</span><br><span class="line">  this.languageDrivers &#x3D; languageDriversProvider.getIfAvailable();</span><br><span class="line">  this.resourceLoader &#x3D; resourceLoader;</span><br><span class="line">  this.databaseIdProvider &#x3D; databaseIdProvider.getIfAvailable();</span><br><span class="line">  this.configurationCustomizers &#x3D; configurationCustomizersProvider.getIfAvailable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#afterPropertiesSet()æ–¹æ³•</strong></p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯å¯¹é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨è¿›è¡Œæ£€éªŒ.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">  checkConfigFileExists();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æ£€éªŒé…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span><br><span class="line">  private void checkConfigFileExists() &#123;</span><br><span class="line">    if (this.properties.isCheckConfigLocation() &amp;&amp; StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">      Resource resource &#x3D; this.resourceLoader.getResource(this.properties.getConfigLocation());</span><br><span class="line">      Assert.state(resource.exists(),</span><br><span class="line">          &quot;Cannot find config location: &quot; + resource + &quot; (please add config file or check your Mybatis configuration)&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory æ–¹æ³•</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; è¿™é‡Œè¯´ä¸‹ @ConditionalOnMissingBean çš„ä½œç”¨,å½“beanä¸å­˜åœ¨çš„æ—¶å€™ï¼Œåˆ™å®ä¾‹åŒ–è¿™ä¸ªbean.</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œä¼šä¼ å…¥ dataSource è¿›æ¥.</span><br><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception &#123;</span><br><span class="line">&#x2F;&#x2F; åˆ›å»º sqlSessionBean å¯¹è±¡.    </span><br><span class="line">  SqlSessionFactoryBean factory &#x3D; new SqlSessionFactoryBean();</span><br><span class="line">&#x2F;&#x2F; è®¾ç½® dataSource &amp; SpringBootVFS.class      </span><br><span class="line">  factory.setDataSource(dataSource);</span><br><span class="line">  factory.setVfs(SpringBootVFS.class);</span><br><span class="line">&#x2F;&#x2F; è·å–åˆ° MyBatis çš„é…ç½®æ–‡ä»¶å±æ€§,å¦‚æœæœ‰çš„è¯,å°±ä¼šè®¾ç½®åˆ° configLocationå±æ€§æ¥.    </span><br><span class="line">  if (StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">    factory.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation()));</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œä» properties ä¸­è·å– configuration,æ²¡æœ‰å€¼å°±ä¼šæ˜¯null.    </span><br><span class="line">  applyConfiguration(factory);</span><br><span class="line">  if (this.properties.getConfigurationProperties() !&#x3D; null) &#123;</span><br><span class="line">    factory.setConfigurationProperties(this.properties.getConfigurationProperties());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¦‚æœæœ‰æ’ä»¶,å°±ä¼šè®¾ç½®æ’ä»¶.    </span><br><span class="line">  if (!ObjectUtils.isEmpty(this.interceptors)) &#123;</span><br><span class="line">    factory.setPlugins(this.interceptors);</span><br><span class="line">  &#125;</span><br><span class="line">  if (this.databaseIdProvider !&#x3D; null) &#123;</span><br><span class="line">    factory.setDatabaseIdProvider(this.databaseIdProvider);</span><br><span class="line">  &#125;</span><br><span class="line">&#x2F;&#x2F; åŒ…çš„ååˆ«è®¾ç½®    </span><br><span class="line">  if (StringUtils.hasLength(this.properties.getTypeAliasesPackage())) &#123;</span><br><span class="line">    factory.setTypeAliasesPackage(this.properties.getTypeAliasesPackage());</span><br><span class="line">  &#125;</span><br><span class="line">  if (this.properties.getTypeAliasesSuperType() !&#x3D; null) &#123;</span><br><span class="line">    factory.setTypeAliasesSuperType(this.properties.getTypeAliasesSuperType());</span><br><span class="line">  &#125;</span><br><span class="line">  if (StringUtils.hasLength(this.properties.getTypeHandlersPackage())) &#123;</span><br><span class="line">    factory.setTypeHandlersPackage(this.properties.getTypeHandlersPackage());</span><br><span class="line">  &#125;</span><br><span class="line">  if (!ObjectUtils.isEmpty(this.typeHandlers)) &#123;</span><br><span class="line">    factory.setTypeHandlers(this.typeHandlers);</span><br><span class="line">  &#125;</span><br><span class="line">  if (!ObjectUtils.isEmpty(this.properties.resolveMapperLocations())) &#123;</span><br><span class="line">    factory.setMapperLocations(this.properties.resolveMapperLocations());</span><br><span class="line">  &#125;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œéƒ½æ˜¯é…ç½®å±æ€§çš„è®¾ç½®.    </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è·å– propert å­—æ®µå±æ€§çš„åå­—.    </span><br><span class="line">  Set&lt;String&gt; factoryPropertyNames &#x3D; Stream</span><br><span class="line">      .of(new BeanWrapperImpl(SqlSessionFactoryBean.class).getPropertyDescriptors()).map(PropertyDescriptor::getName)</span><br><span class="line">      .collect(Collectors.toSet());</span><br><span class="line">  Class&lt;? extends LanguageDriver&gt; defaultLanguageDriver &#x3D; this.properties.getDefaultScriptingLanguageDriver();</span><br><span class="line">  if (factoryPropertyNames.contains(&quot;scriptingLanguageDrivers&quot;) &amp;&amp; !ObjectUtils.isEmpty(this.languageDrivers)) &#123;</span><br><span class="line">    &#x2F;&#x2F; Need to mybatis-spring 2.0.2+</span><br><span class="line">    factory.setScriptingLanguageDrivers(this.languageDrivers);</span><br><span class="line">    if (defaultLanguageDriver &#x3D;&#x3D; null &amp;&amp; this.languageDrivers.length &#x3D;&#x3D; 1) &#123;</span><br><span class="line">      defaultLanguageDriver &#x3D; this.languageDrivers[0].getClass();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#x2F;&#x2F; è®¾ç½®é»˜è®¤çš„è„šæœ¬è¯­è¨€è§£æå™¨. è¿™é‡Œæ²¡æœ‰,è®¾ç½®çš„æ˜¯é»˜è®¤çš„null.    </span><br><span class="line">  if (factoryPropertyNames.contains(&quot;defaultScriptingLanguageDriver&quot;)) &#123;</span><br><span class="line">    &#x2F;&#x2F; Need to mybatis-spring 2.0.2+</span><br><span class="line">    factory.setDefaultScriptingLanguageDriver(defaultLanguageDriver);</span><br><span class="line">  &#125;</span><br><span class="line">&#x2F;&#x2F; org.mybatis.spring.SqlSessionFactoryBean#getObject,è¿™é‡Œèµ°åˆ°äº† SqlSessionBean.</span><br><span class="line">&#x2F;&#x2F; è¿™ä¸ªSqlSessionFactoryBeanæ˜¯åœ¨æœ‰ä¹‹å‰ mybatiså’ŒSpring æ•´åˆåˆ†ææœ‰æè¿‡åˆ°çš„,å¯ä»¥å‚è€ƒgetObjectæ–¹æ³•: https:&#x2F;&#x2F;github.com&#x2F;baoyang23&#x2F;mybtatis-analysis&#x2F;tree&#x2F;master&#x2F;mybatis-spring-hello    </span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œä¼šèµ° org.mybatis.spring.SqlSessionFactoryBean#getObject çš„ afterPropertiesSet æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª SqlSessionFactory , è¿™é‡Œè¿”å›çš„ SqlSessionFactory å°±æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.    </span><br><span class="line">  return factory.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ‰€ä»¥è¿™ä¸ªæ–¹æ³• ï¼š å…ˆæ˜¯newäº†ä¸€ä¸ªSqlSessionFactoryBeanå¯¹è±¡ï¼Œå¦‚æœä½ ä»”ç»†çœ‹çš„è¯ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªå¯¹è±¡åœ¨ä¹‹å‰ mybatis-spring æ•´åˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡ xml é…ç½®æ–‡ä»¶é…ç½®è¿›æ¥çš„ï¼Œå¹¶ä¸”åŒæ—¶é€šè¿‡æ ‡ç­¾ç»™èµ‹å€¼äº†datasourceç­‰ä¿¡æ¯ï¼Œ  è€Œè¿™é‡Œæ˜¯é€šè¿‡ä»£ç ï¼Œifç­‰åˆ¤æ–­ï¼Œæ¥å¯¹ SqlSessionFactoryBean çš„å±æ€§è¿›è¡Œsetå€¼çš„. æœ€åä¹Ÿæ˜¯åˆ›å»ºå‡ºä¸€ä¸ª  SqlSessionFactory ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥.</strong></p>
<hr>
<p><strong>org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionTemplate æ–¹æ³•</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæ ¹æ® executorType æ˜¯å¦æœ‰å€¼æ¥åˆ¤æ–­è¦èµ°çš„æ„é€ å‡½æ•°æ–¹æ³•.    </span><br><span class="line">  ExecutorType executorType &#x3D; this.properties.getExecutorType();</span><br><span class="line">  if (executorType !&#x3D; null) &#123;</span><br><span class="line">    return new SqlSessionTemplate(sqlSessionFactory, executorType);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œé»˜è®¤çš„è·å–æ˜¯ SIMPLE è¿™ä¸ª ExecutorType.      </span><br><span class="line">    return new SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; org.mybatis.spring.SqlSessionTemplate#SqlSessionTemplate(org.apache.ibatis.session.SqlSessionFactory, org.apache.ibatis.session.ExecutorType, org.springframework.dao.support.PersistenceExceptionTranslator),æœ€åå¯ä»¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•ä¸­æ¥.</span><br><span class="line"></span><br><span class="line">  public SqlSessionTemplate(SqlSessionFactory sqlSessionFactory, ExecutorType executorType,</span><br><span class="line">      PersistenceExceptionTranslator exceptionTranslator) &#123;</span><br><span class="line">&#x2F;&#x2F; å¯¹sqlSessionFactory å’Œ executorType è¿›è¡Œæ ¡éªŒ</span><br><span class="line">    notNull(sqlSessionFactory, &quot;Property &#39;sqlSessionFactory&#39; is required&quot;);</span><br><span class="line">    notNull(executorType, &quot;Property &#39;executorType&#39; is required&quot;);</span><br><span class="line"></span><br><span class="line">    this.sqlSessionFactory &#x3D; sqlSessionFactory;</span><br><span class="line">    this.executorType &#x3D; executorType;</span><br><span class="line">    this.exceptionTranslator &#x3D; exceptionTranslator;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œé€šè¿‡ JDK çš„ä»£ç æ¥ç”Ÿæˆäº†ä¸€ä¸ª sqlSessionProxy ä»£ç†çš„å¯¹è±¡.      </span><br><span class="line">    this.sqlSessionProxy &#x3D; (SqlSession) newProxyInstance(SqlSessionFactory.class.getClassLoader(),</span><br><span class="line">        new Class[] &#123; SqlSession.class &#125;, new SqlSessionInterceptor());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•æ˜¯å°† SqlSessionTemplate ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­å•¦.</p>
<h4 id="-2"><a href="#-2" class="headerlink" title=""></a></h4><h4 id="ç–‘æƒ‘ç‚¹"><a href="#ç–‘æƒ‘ç‚¹" class="headerlink" title="ç–‘æƒ‘ç‚¹"></a>ç–‘æƒ‘ç‚¹</h4><p>â€‹     å¤§å®¶æœ‰æ²¡æœ‰ç–‘æƒ‘æˆ‘ä»¬å®šä¹‰çš„ mapper æ¥å£ å¥½åƒä»è¿™ä¸ªæµç¨‹åˆ†æä¸‹æ¥ï¼Œå¹¶æ²¡æœ‰æåˆ° ï¼Œé‚£ä¹ˆæ˜¯åœ¨ä¸Šé¢æ—¶å€™è¢«æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥çš„å‘¢ï¼Ÿ</p>
<p>â€‹     registerBeanDefinitions()  è¿™ä¸ªæ–¹æ³• , æ³¨å…¥äº†MapperScannerConfigurer åˆ°  Spring å®¹å™¨ä¸­æ¥äº†ï¼Œå¯ä»¥å›é¡¾ä¸‹ä¹‹å‰ mybatis æ•´åˆ Spring çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ xml é…ç½®äº†è¿™ä¸ªå¯¹è±¡æ³¨å…¥åˆ° spring  å®¹å™¨ä¸­æ¥çš„ã€‚ é‚£ä¹ˆæ³¨å…¥è¿›æ¥çš„,å›è°ƒåˆ°  org.mybatis.spring.mapper.MapperScannerConfigurer#postProcessBeanDefinitionRegistry è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šå°†æ‰«æå¹¶ä¸”å°†æˆ‘ä»¬çš„mapperæ¥å£æ–‡ä»¶ï¼Œç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥çš„.  ç„¶åæ‰«æçš„åŒ…ï¼Œæ˜¯æ ¹æ®@MapperScan è§£ææ³¨è§£çš„æ—¶å€™ï¼Œæ˜¯æœ‰å¯¹æ‰«æçš„åŒ…è¿›è¡Œè§£æçš„.</p>
<h4 id="-3"><a href="#-3" class="headerlink" title=""></a></h4><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>â€‹      å…¶å® SpringBoot æ•´åˆ MyBatis , æˆ‘ä»¬ä»äºŒä¸ªåˆ‡å…¥ç‚¹æ¥åˆ†ææ˜¯æ€ä¹ˆæ•´åˆè¿›æ¥çš„.<br> â€‹      ä¸€æ˜¯ @MapperScan æ³¨è§£ä¸­çš„ @Import(MapperScannerRegistrar.class) å°†  MapperScannerRegistrar ç»™å¯¼å…¥åˆ° Spring å®¹å™¨ä¸­æ¥, ç„¶åMapperSacnnerRegistrar æ¥è®²  org.mybatis.spring.mapper.MapperScannerConfigurer ç»™æ³¨å…¥åˆ° Springä¸­æ¥ï¼Œæ›¿æ¢äº†æˆ‘ä»¬ä¹‹å‰ç”¨ Spring æ•´åˆ Mybatis çš„æ—¶å€™ï¼Œé€šè¿‡xmlé…ç½®æ–‡ä»¶æ•´åˆè¿›æ¥.</p>
<p>â€‹     äºŒæ˜¯åˆ©ç”¨ SpringBoot æä¾›çš„ spring-boot-autoconfigure +  spring.factories() æ¥ é…ç½®è‡ªåŠ¨æ³¨å…¥, è¿™é‡Œæ³¨å…¥äº† MybatisAutoConfiguration é…ç½®ç±». ç„¶åæ³¨å…¥è¿›æ¥çš„ MyBatis é…ç½®ç±»åšäº†ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿ  å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»ä¸­æ˜¯æœ‰åš:   æ³¨å…¥äº† SqlSessionFactory.  SqlSessionFactory åˆæ˜¯æ€ä¹ˆæ³¨å…¥è¿›æ¥çš„å‘¢ï¼Ÿ å¯ä»¥çœ‹åˆ°  org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration#sqlSessionFactory æ–¹æ³•æ˜¯æœ‰å…ˆåˆ›å»ºä¸€ä¸ª org.mybatis.spring.SqlSessionFactoryBean çš„ï¼Œ çœ‹åˆ°  SqlSessionFactoryBean è¿™ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬å°±ä¸éš¾æƒ³èµ· Spring + Mybatis é‡Œé¢çš„ beans.xml  æ˜¯å°†è¯¥å¯¹è±¡æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­æ¥. è¿™é‡Œæ˜¯ç›´æ¥newçš„ï¼Œç„¶åå°†ä¸€äº›é…ç½®å±æ€§å¹¶æ»¡è¶³æ¡ä»¶,ç»™setåˆ°  SqlSessionFactoryBean  ä¸­æ¥ï¼Œæœ€åè°ƒç”¨   org.mybatis.spring.SqlSessionFactoryBean#getObject æ–¹æ³•æ¥è·å–  SqlSessionFactory.</p>
<p>spring.factories æ–‡ä»¶å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration&#x3D;\</span><br><span class="line">org.mybatis.spring.boot.autoconfigure.MybatisLanguageDriverAutoConfiguration,\</span><br><span class="line">org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration</span><br></pre></td></tr></table></figure>



<p>æœ€åä»å†™çš„æ¡ˆä¾‹é‡Œé¢çœ‹, MyBatis æ•´åˆ SpringBoot å…¶å®éƒ½æ˜¯åœ¨ mybatis â€”&gt; MyBatis + Spring  ç­‰ä¸€æ­¥ä¸€æ­¥æ¨å¯¼ä¸Šæ¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸éš¾ç†è§£ï¼Œå¥½çš„æŠ€æœ¯éƒ½æ˜¯åœ¨æœ‰éœ€è¦å’Œæ—¶é—´çš„æ²‰æ·€ä¸‹ä¸€æ­¥ä¸€æ­¥æˆé•¿èµ·æ¥çš„.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lwfby.cn/2020/12/27/mybatis/mybatis-spring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YangL">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YangL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/27/mybatis/mybatis-spring/" itemprop="url">mybatis-spring</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-12-27T22:10:39+08:00">
                2020-12-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MyBatis/" itemprop="url" rel="index">
                    <span itemprop="name">MyBatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  3.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p>â€‹    MyBatis ä¸ Spring æ•´åˆæ“ä½œ.   åœ¨æˆ‘ä»¬å…¥é—¨å­¦ä¹  SSM  ç­‰ä¸œè¥¿çš„æ—¶å€™ï¼Œå°±å‘ç°äº†ä»»ä½•ä¸œè¥¿ï¼Œæœ€åéƒ½æ˜¯é€ƒä¸è¿‡ä¸Springæ•´åˆèµ·æ¥çš„é“è·¯.   ç„¶åè¿™é‡Œçœ‹å®Œ MyBatis æ•´åˆå®Œ Spring  ä¹‹åï¼Œé‚£ä¹ˆä¹‹åä¸€äº›å…¶ä»–çš„ç¬¬ä¸‰æ–¹ï¼Œæ¯”å¦‚axon/redis/apollo/shiro ç­‰è¿™äº›ä¸œè¥¿ï¼Œå¦‚æœè¦æ•´åˆ Spring  çš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ç›¸ä¼¼çš„æ•´åˆæ–¹å¼å‘¢ï¼Ÿ</p>
<p>â€‹    è¿™ä¸ªéœ€è¦æˆ‘ä»¬çœ‹å®Œ MyBatis ä¸ Spring ä¹‹åï¼Œæ¢ç©¶å…¶æ•´åˆçš„æ“ä½œ.</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h4><p>â€‹     åˆ†å‡ ä¸ªæ­¥éª¤ï¼Œæ“ä½œä¸€æŠŠå³å¯,å¸¦ä½ å›åˆ°å“ªä¸ª  SM æ—¶ä»£ï¼Œä¸è¿‡è¿™å›æ˜¯æ²¡æœ‰äº† tomcat çš„.</p>
<p>â€‹     å…ˆæ”¾ä¸Šä¸€ä¸ªå®Œæˆçš„æ•´åˆåœ°å€ :    <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello</a>    å¦‚æœä¸è¦çœ‹ä¸‹é¢æµç¨‹çš„,ä¸€æ­¥è·³è¿‡å³å¯.</p>
<ol>
<li>å…ˆåˆ›å»ºä¸€ä¸ª maven é¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–.  ä¾èµ–å‚è€ƒåœ°å€ :    <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/pom.xml" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/pom.xml</a></li>
<li>dbé…ç½® : <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/db.properties" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/db.properties</a></li>
<li>MyBatisé…ç½®:  <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/mybatis" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/mybatis</a></li>
<li>Spring é…ç½®:  <a href="https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/spring-beans.xml" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/blob/master/mybatis-spring-hello/src/main/resources/spring-beans.xml</a></li>
<li>æœ€å,æ¥ä»½æˆ‘ä»¬ç†Ÿæ‚‰çš„ <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/sql" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src/main/resources/sql</a>  mapper.xml æ–‡ä»¶.</li>
<li>ä¸å¿˜è®°å†æ¥ä¸€ä»½ä»£ç  :   <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-spring-hello/src</a>     è¿™äº›ç›´æ¥è·‘æµ‹è¯•ç±»å³å¯.</li>
</ol>
<p>è·Ÿç€è¿™ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤ï¼Œå°±å¯ä»¥æ­å»ºå®Œä¸€ä¸ªé¡¹ç›®. ç„¶åå–Šä¸Šæˆ‘ä»¬çš„ æ°¸å“¥ï¼Œ æ‰“ä¸Šä¼ è¯´ä¸­çš„ debug , ç–¯ç‹‚çš„è°ƒè¯•çœ‹æ¯æ­¥å¹²äº†ä»€ä¹ˆäº‹.</p>
<p>è¿™ä¸ªçš„æ—¶å€™ï¼Œå¯ä»¥è·‘ä¸‹æµ‹è¯•ç±»ï¼Œæ˜¯okçš„.</p>
<h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>â€‹       è¿™é‡Œæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¼•å…¥çš„ä¾èµ–,æ˜¯ä¸æ˜¯æœ‰ä¸ª mybatis-spring çš„ä¾èµ–. ä»è¿™ä¸ªä¾èµ–ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥ï¼Œå°±æ˜¯é€šè¿‡è¿™ä¸ªä¾èµ–ï¼Œå°† MyBatis å’Œ Spring æ•´åˆèµ·æ¥çš„ã€‚</p>
<p>â€‹       ç„¶åå†æƒ³æƒ³ï¼Œæˆ‘ä»¬é™¤äº†è¿™ä¸ªä¾èµ–çš„è¯ï¼Œè¿˜å†å“ªé‡Œæœ‰ä½¿ç”¨åˆ°ä¸€äº› Spring å’Œ MyBatis çš„ä¸œè¥¿å‘¢ï¼Ÿ  ç„¶åçœ‹åˆ°  spring-beans.xml è¿™ä¸ªxmlé…ç½®, å¯ä»¥çœ‹åˆ° org.mybatis.spring.SqlSessionFactoryBean  ç»™æ³¨å…¥åˆ° bean é‡Œé¢æ¥äº†.org.mybatis.spring.mapper.MapperScannerConfigurerä¹Ÿæ˜¯ç»™æ³¨å…¥åˆ°  bean é‡Œé¢æ¥äº†. å¹¶ä¸”äºŒè€…éƒ½æœ‰é€šè¿‡æ¥è¿›è¡Œå±æ€§è®¾ç½®å€¼æ“ä½œ.</p>
<p>â€‹        é‚£ä¹ˆ,æˆ‘ä»¬å°±åŸºäºè¿™äºŒä¸ªç±»çš„æºç å¼€å§‹é˜…è¯».</p>
<p>â€‹    <strong>SqlSessionFactoryBean (org.mybatis.spring.SqlSessionFactoryBean)</strong></p>
<p>è¿™é‡Œ SqlSessionFactoryBean æ˜¯å®ç°äº†å¾ˆå¤šæ¥å£,è¿™äº›æ¥å£éƒ½æ˜¯Springçš„.</p>
<p>FactoryBean å·¥å‚bean,ç‚¹è¿›å»å¯ä»¥çœ‹åˆ°,å…¶æœ‰æ–¹æ³•getObject()/getObjectTypeç­‰æ–¹æ³•è·å–beançš„,ç„¶ååŠ ä¸Šæ³›å‹,ä¹Ÿå°±æ˜¯è¿™é‡Œè·å–çš„ getObjectå°±æ˜¯æ³›å‹.</p>
<p>InitializingBean:  afterPropertiesSet åˆå§‹åŒ– bean çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•.</p>
<p>ApplicationEvent:   Springçš„äº‹ä»¶ä¼ æ’­æœºåˆ¶ï¼Œå°±æ˜¯ä½¿ç”¨çš„è¿™ç§æ–¹å¼.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**  å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»å®ç°äº† Spring è¿™ä¸ªå¤šæ¥å£,é‚£ä¹ˆå°±æœ‰ä¸ªé—®é¢˜,å®ç°äº†è¿™ä¹ˆå¤šæ¥å£çš„æ–¹æ³•,åˆ°åº•æ˜¯å“ªä¸ªæ–¹æ³•å…ˆæ‰§è¡Œçš„å‘¢ï¼Ÿ å¦‚æœä½ å¯¹Springæºç å¾ˆç†Ÿæ‚‰çš„è¯,æ˜¯æœ‰å¯èƒ½æ¸…æ¥šçš„,ä½†æ˜¯è¿˜æ˜¯ä¼šæœ‰ç‚¹ç»•çš„. </span><br><span class="line">è¿™é‡Œæˆ‘ä»¬ç»™ getObject&#x2F;afterPropertiesSet&#x2F;onApplicationEventè¿™ä¸‰ä¸ªæ–¹æ³•æ‰“ä¸Šæ–­ç‚¹æ¥è¿›è¡Œdebug,</span><br><span class="line">debugæ¯èµ°çš„ä¸€æ­¥,å°±æ˜¯æ‰§è¡Œçš„å…ˆåé¡ºåºã€‚å¦‚æœä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰æºç çš„æ‰§è¡Œé¡ºåº,è¿™ç§ç¬¨æ–¹æ³•å…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„.</span><br><span class="line">*</span><br><span class="line">* æ‰€ä»¥è¿™é‡Œdebugçš„æ‰§è¡Œé¡ºåºæ˜¯ : afterPropertiesSet --&gt; getObject  ---&gt; onApplicationEvent</span><br><span class="line">* äºæ˜¯æˆ‘ä»¬å°±è·Ÿç€è¿™ä¸ªé¡ºåºæ¥é˜…è¯».</span><br><span class="line">* æ³¨æ„åœ¨è°ƒç”¨è¿™äº›æ–¹æ³•ä¹‹å‰,&lt;property&gt;æ ‡ç­¾çš„å€¼éƒ½æ˜¯å·²ç»èµ‹å€¼è¿›æ¥äº†çš„,æ˜¯é€šè¿‡åå°„èµ°çš„set æ–¹æ³•è¿›æ¥çš„.</span><br><span class="line">*&#x2F;</span><br><span class="line">public class SqlSessionFactoryBean</span><br><span class="line">    implements FactoryBean&lt;SqlSessionFactory&gt;, InitializingBean, ApplicationListener&lt;ApplicationEvent&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å®ç°FactoryBean æ–¹æ³•,è¿™é‡Œæ˜¯å®ç°äº†è¯¥æ¥å£çš„ä¸‰ä¸ªæ–¹æ³•. å…¶å®è¿™é‡Œçš„ isSingleæ˜¯å¯ä»¥ä¸ç”¨å®ç°çš„</span><br><span class="line">&#x2F;&#x2F; å› ä¸ºæ¥å£æ˜¯ç”¨ default æ¥ä¿®é¥°çš„.</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * è¯¥æ–¹æ³•æ˜¯åˆ¤æ–­å¹¶ä¸”å†æ¬¡ç¡®è®¤ SqlSessionFactoryæ˜¯ä¸æ˜¯æœ‰äº†. å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šè°ƒç”¨afterPropertiesæ¥åˆå§‹åŒ–.</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   *&#x2F;</span><br><span class="line">  @Override</span><br><span class="line">  public SqlSessionFactory getObject() throws Exception &#123;</span><br><span class="line">    if (this.sqlSessionFactory &#x3D;&#x3D; null) &#123;</span><br><span class="line">      afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return this.sqlSessionFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Class&lt;? extends SqlSessionFactory&gt; getObjectType() &#123;</span><br><span class="line">    return this.sqlSessionFactory &#x3D;&#x3D; null ? SqlSessionFactory.class : this.sqlSessionFactory.getClass();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public boolean isSingleton() &#123;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; InitializingBean å®ç°çš„æ–¹æ³•</span><br><span class="line">  @Override</span><br><span class="line">  public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">&#x2F;&#x2F; å…ˆå¯¹ dataSource&#x2F;sqlSessionFactoryBuilderè¿›è¡Œénullçš„åˆ¤æ–­.</span><br><span class="line">    notNull(dataSource, &quot;Property &#39;dataSource&#39; is required&quot;);</span><br><span class="line">    notNull(sqlSessionFactoryBuilder, &quot;Property &#39;sqlSessionFactoryBuilder&#39; is required&quot;);</span><br><span class="line">    state((configuration &#x3D;&#x3D; null &amp;&amp; configLocation &#x3D;&#x3D; null) || !(configuration !&#x3D; null &amp;&amp; configLocation !&#x3D; null),</span><br><span class="line">        &quot;Property &#39;configuration&#39; and &#39;configLocation&#39; can not specified with together&quot;);</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæ„å»ºå‡º ä¸€ä¸ª sqlSessionFactoryå·¥å‚æ¥,æƒ³æƒ³æˆ‘ä»¬æœ€åˆå†çœ‹å•ä¸ªMyBatisé¡¹ç›®çš„æ—¶å€™,æ˜¯ä¸æ˜¯ä¹Ÿæœ‰ä¸€ä¸ªè·å–SqlSessionFactroyçš„æ–¹æ³•,ç„¶åä»sqlSessionFactoryä¼šè¯ä¸­è·å–å‡ºSqlSessionæ¥.</span><br><span class="line">    this.sqlSessionFactory &#x3D; buildSqlSessionFactory();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ApplicationListenerå®ç°æ–¹æ³•</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * failFast æ—¶ture å¹¶ä¸”ä¼ è¿‡æ¥çš„ eventæ˜¯ ContextRefreshedEventçš„è¯,å°±ä¼šè¿›æ¥.</span><br><span class="line">   *  è¿™é‡Œç›®å‰éƒ½æ˜¯è°ƒç”¨getæ–¹æ³•,æ²¡æœ‰å¾ˆä»”ç»†çœ‹å‡ºå…¶ä½œç”¨.</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   *&#x2F;</span><br><span class="line">  @Override</span><br><span class="line">  public void onApplicationEvent(ApplicationEvent event) &#123;</span><br><span class="line">    if (failFast &amp;&amp; event instanceof ContextRefreshedEvent) &#123;</span><br><span class="line">      &#x2F;&#x2F; fail-fast -&gt; check all statements are completed</span><br><span class="line">      this.sqlSessionFactory.getConfiguration().getMappedStatementNames();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>org.mybatis.spring.SqlSessionFactoryBean#buildSqlSessionFactory</strong></p>
<p>è¯¥æ–¹æ³•éœ€è¦å•ç‹¬æ‹¿å‡ºæ¥è¯´ä¸‹,å› ä¸ºå†…å®¹è¿˜æ˜¯æ¯”è¾ƒå¤šçš„.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Build a &#123;@code SqlSessionFactory&#125; instance.</span><br><span class="line"> *</span><br><span class="line"> * The default implementation uses the standard MyBatis &#123;@code XMLConfigBuilder&#125; API to build a</span><br><span class="line"> * &#123;@code SqlSessionFactory&#125; instance based on a Reader. Since 1.3.0, it can be specified a &#123;@link Configuration&#125;</span><br><span class="line"> * instance directly(without config file).</span><br><span class="line"> *</span><br><span class="line"> * @return SqlSessionFactory</span><br><span class="line"> * @throws Exception</span><br><span class="line"> *           if configuration is failed</span><br><span class="line"> *&#x2F;</span><br><span class="line">protected SqlSessionFactory buildSqlSessionFactory() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">  final Configuration targetConfiguration;</span><br><span class="line"></span><br><span class="line">  XMLConfigBuilder xmlConfigBuilder &#x3D; null;</span><br><span class="line">    </span><br><span class="line"> &#x2F;&#x2F; è¿™é‡Œåˆ†ä¸ºconfiguration&#x2F; configLocation &#x2F; éå‰äºŒè€…(å¯ä»¥ç†è§£ä¸ºé»˜è®¤çš„).</span><br><span class="line"> &#x2F;&#x2F; ä¸‰ç§å¤„ç†æ–¹å¼.   </span><br><span class="line">  if (this.configuration !&#x3D; null) &#123;</span><br><span class="line">    targetConfiguration &#x3D; this.configuration;</span><br><span class="line">    if (targetConfiguration.getVariables() &#x3D;&#x3D; null) &#123;</span><br><span class="line">      targetConfiguration.setVariables(this.configurationProperties);</span><br><span class="line">    &#125; else if (this.configurationProperties !&#x3D; null) &#123;</span><br><span class="line">      targetConfiguration.getVariables().putAll(this.configurationProperties);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else if (this.configLocation !&#x3D; null) &#123;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œå°±æ˜¯æˆ‘ä»¬é…ç½®çš„æƒ…å†µ </span><br><span class="line">&#x2F;&#x2F; org.apache.ibatis.builder.xml.XMLConfigBuilder#XMLConfigBuilder(java.io.InputStream, java.lang.String, java.util.Properties),å¯ä»¥çœ‹åˆ°è¿™ä¸ªç†Ÿæ‚‰çš„æ“ä½œ,ä¹Ÿå°±æ˜¯æˆ‘ä»¬å•ä¸ªè§£æ MyBatisçš„æ—¶å€™æœ‰è¿›è¡Œåˆ†æè¿‡çš„.      </span><br><span class="line">    xmlConfigBuilder &#x3D; new XMLConfigBuilder(this.configLocation.getInputStream(), null, this.configurationProperties);</span><br><span class="line">&#x2F;&#x2F; è·å–å‡º configuration é…ç½®ä¿¡æ¯.      </span><br><span class="line">    targetConfiguration &#x3D; xmlConfigBuilder.getConfiguration();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    LOGGER.debug(</span><br><span class="line">        () -&gt; &quot;Property &#39;configuration&#39; or &#39;configLocation&#39; not specified, using default MyBatis Configuration&quot;);</span><br><span class="line">    targetConfiguration &#x3D; new Configuration();</span><br><span class="line">    Optional.ofNullable(this.configurationProperties).ifPresent(targetConfiguration::setVariables);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œé‡‡ç”¨ Optional,å¦‚æœobjectFactoryä¸æ˜¯nullçš„è¯,å°±ä¼šè°ƒç”¨targetConfigurationçš„ setObjectFactoryæ–¹æ³•.ä¸‹é¢è¿™äºŒä¸ªæ˜¯åŒç†.</span><br><span class="line">  Optional.ofNullable(this.objectFactory).ifPresent(targetConfiguration::setObjectFactory);</span><br><span class="line">  Optional.ofNullable(this.objectWrapperFactory).ifPresent(targetConfiguration::setObjectWrapperFactory);</span><br><span class="line">  Optional.ofNullable(this.vfs).ifPresent(targetConfiguration::setVfsImpl);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œå¦‚æœæœ‰é…ç½®typeAliasesPackageè¿™ä¸ªå‚æ•°çš„è¯,å°±ä¼šå¯¹è¯¥åŒ…ä¸‹è¿›è¡Œæ‰«æ,è¿›è¡Œä¸€ç³»åˆ—çš„è¿‡æ»¤,</span><br><span class="line">&#x2F;&#x2F; å¦‚æœéƒ½æ»¡è¶³æ¡ä»¶çš„è¯,targetConfiguration.getTypeAliasRegistry()::registerAliaså°±ä¼šæ³¨å†Œåˆ°è¿™é‡Œ. </span><br><span class="line">  if (hasLength(this.typeAliasesPackage)) &#123;</span><br><span class="line">    scanClasses(this.typeAliasesPackage, this.typeAliasesSuperType).stream()</span><br><span class="line">        .filter(clazz -&gt; !clazz.isAnonymousClass()).filter(clazz -&gt; !clazz.isInterface())</span><br><span class="line">        .filter(clazz -&gt; !clazz.isMemberClass()).forEach(targetConfiguration.getTypeAliasRegistry()::registerAlias);</span><br><span class="line">  &#125;</span><br><span class="line">&#x2F;&#x2F; æ˜¯å¦æœ‰typeAliasesè¿™ä¸ªå‚æ•°,å¦‚æœæœ‰çš„è¯,ä¹Ÿæ˜¯å¯ä»¥çœ‹åˆ°æ˜¯æ³¨å†Œåˆ°ä¸Šé¢å“ªä¸€æ­¥çš„é‡Œé¢æ¥.</span><br><span class="line">  if (!isEmpty(this.typeAliases)) &#123;</span><br><span class="line">    Stream.of(this.typeAliases).forEach(typeAlias -&gt; &#123;</span><br><span class="line">      targetConfiguration.getTypeAliasRegistry().registerAlias(typeAlias);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered type alias: &#39;&quot; + typeAlias + &quot;&#39;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;åˆ¤æ–­æ˜¯å¦æœ‰æ’ä»¶,å¦‚æœæœ‰æ’ä»¶çš„è¯,ä¹Ÿä¼šæ·»åŠ åˆ°configurationä¸­æ¥.    </span><br><span class="line">  if (!isEmpty(this.plugins)) &#123;</span><br><span class="line">    Stream.of(this.plugins).forEach(plugin -&gt; &#123;</span><br><span class="line">      targetConfiguration.addInterceptor(plugin);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered plugin: &#39;&quot; + plugin + &quot;&#39;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (hasLength(this.typeHandlersPackage)) &#123;</span><br><span class="line">    scanClasses(this.typeHandlersPackage, TypeHandler.class).stream().filter(clazz -&gt; !clazz.isAnonymousClass())</span><br><span class="line">        .filter(clazz -&gt; !clazz.isInterface()).filter(clazz -&gt; !Modifier.isAbstract(clazz.getModifiers()))</span><br><span class="line">        .forEach(targetConfiguration.getTypeHandlerRegistry()::register);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!isEmpty(this.typeHandlers)) &#123;</span><br><span class="line">    Stream.of(this.typeHandlers).forEach(typeHandler -&gt; &#123;</span><br><span class="line">      targetConfiguration.getTypeHandlerRegistry().register(typeHandler);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered type handler: &#39;&quot; + typeHandler + &quot;&#39;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  targetConfiguration.setDefaultEnumTypeHandler(defaultEnumTypeHandler);</span><br><span class="line"></span><br><span class="line">  if (!isEmpty(this.scriptingLanguageDrivers)) &#123;</span><br><span class="line">    Stream.of(this.scriptingLanguageDrivers).forEach(languageDriver -&gt; &#123;</span><br><span class="line">      targetConfiguration.getLanguageRegistry().register(languageDriver);</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Registered scripting language driver: &#39;&quot; + languageDriver + &quot;&#39;&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  Optional.ofNullable(this.defaultScriptingLanguageDriver)</span><br><span class="line">      .ifPresent(targetConfiguration::setDefaultScriptingLanguage);</span><br><span class="line"></span><br><span class="line">  if (this.databaseIdProvider !&#x3D; null) &#123;&#x2F;&#x2F; fix #64 set databaseId before parse mapper xmls</span><br><span class="line">    try &#123;</span><br><span class="line">      targetConfiguration.setDatabaseId(this.databaseIdProvider.getDatabaseId(this.dataSource));</span><br><span class="line">    &#125; catch (SQLException e) &#123;</span><br><span class="line">      throw new NestedIOException(&quot;Failed getting a databaseId&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Optional.ofNullable(this.cache).ifPresent(targetConfiguration::addCache);</span><br><span class="line">&#x2F;&#x2F; è¿™è¿™ä¹‹å‰,éƒ½æ˜¯å¯¹ä¸€äº›é…ç½®ä¿¡æ¯çš„è¯»å–,å¦‚æœæœ‰çš„è¯,å°±ä¼šè¿›è¡Œç›¸åº”çš„èµ‹å€¼ä¹‹ç±»çš„æ“ä½œ.</span><br><span class="line">    </span><br><span class="line">  if (xmlConfigBuilder !&#x3D; null) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">&#x2F;&#x2F; æœ€åè¿™é‡Œçš„ parse è§£ææ–¹æ³•,æ˜¯å’Œå•ä¸ª Mybatisçš„è§£è¯»æ˜¯ä¸€æ ·çš„.        </span><br><span class="line">      xmlConfigBuilder.parse();</span><br><span class="line">      LOGGER.debug(() -&gt; &quot;Parsed configuration file: &#39;&quot; + this.configLocation + &quot;&#39;&quot;);</span><br><span class="line">    &#125; catch (Exception ex) &#123;</span><br><span class="line">      throw new NestedIOException(&quot;Failed to parse config resource: &quot; + this.configLocation, ex);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è¿™é‡Œå¯ä»¥çœ‹äº‹åŠ¡å·¥å‚,æ˜¯ä½¿ç”¨äº†mybatis-springåŒ…ä¸‹çš„.</span><br><span class="line">  targetConfiguration.setEnvironment(new Environment(this.environment,</span><br><span class="line">      this.transactionFactory &#x3D;&#x3D; null ? new SpringManagedTransactionFactory() : this.transactionFactory,</span><br><span class="line">      this.dataSource));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæ˜¯å¤„ç† mapper.xml æ–‡ä»¶çš„é…ç½®,å¦‚æœåœ¨è¿™é‡Œæ˜¯æœ‰é…ç½®çš„è¯,é‚£ä¹ˆä¹Ÿæ˜¯ä¼šè¢«è§£æåˆ°çš„.    </span><br><span class="line">  if (this.mapperLocations !&#x3D; null) &#123;</span><br><span class="line">    if (this.mapperLocations.length &#x3D;&#x3D; 0) &#123;</span><br><span class="line">      LOGGER.warn(() -&gt; &quot;Property &#39;mapperLocations&#39; was specified but matching resources are not found.&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      for (Resource mapperLocation : this.mapperLocations) &#123;</span><br><span class="line">        if (mapperLocation &#x3D;&#x3D; null) &#123;</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">          XMLMapperBuilder xmlMapperBuilder &#x3D; new XMLMapperBuilder(mapperLocation.getInputStream(),</span><br><span class="line">              targetConfiguration, mapperLocation.toString(), targetConfiguration.getSqlFragments());</span><br><span class="line">          xmlMapperBuilder.parse();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">          throw new NestedIOException(&quot;Failed to parse mapping resource: &#39;&quot; + mapperLocation + &quot;&#39;&quot;, e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">          ErrorContext.instance().reset();</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.debug(() -&gt; &quot;Parsed mapper file: &#39;&quot; + mapperLocation + &quot;&#39;&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    LOGGER.debug(() -&gt; &quot;Property &#39;mapperLocations&#39; was not specified.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#x2F;&#x2F;org.apache.ibatis.session.defaults.DefaultSqlSessionFactory,æœ€ååˆ°è¿™é‡Œä¹Ÿæ˜¯newäº†ä¸€ä¸ªmybatisåŒ…ä¸‹çš„é»˜è®¤SqlSessionFactoryç±».</span><br><span class="line">  return this.sqlSessionFactoryBuilder.build(targetConfiguration);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•ç»™äººæ„Ÿè§‰, å…ˆæ˜¯åˆ¤æ–­ä¸€äº›é…ç½®ä¿¡æ¯æ˜¯ä¸æ˜¯æœ‰å€¼ï¼Œå¦‚æœæ˜¯æœ‰å€¼çš„è¯ï¼Œå°±ä¼šè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚æœ€åè°ƒç”¨æˆ‘ä»¬åœ¨çœ‹å•ä¸ª mybatis çš„ parse è§£ææ–¹æ³•,æœ€ånewäº†ä¸€ä¸ªé»˜è®¤çš„sqlSessionFactoryå·¥å‚ç±»å‡ºæ¥.</p>
<p><strong>MapperScannerConfigurer(org.mybatis.spring.mapper.MapperScannerConfigurer)</strong></p>
<p>æ¥ç€çœ‹,spring-beans.xml é‡Œé¢çš„ç¬¬äºŒä¸ªé…ç½®.</p>
<p>å¯ä»¥çœ‹åˆ°è¯¥ç±»ï¼Œä¹Ÿæ˜¯å®ç°äº† spring çš„å¾ˆå¤šæ¥å£.</p>
<p>BeanDefinitionRegistryPostProcessor :  æ³¨å†ŒBeanDefinitionåˆ°Springå®¹å™¨ä¸­æ¥.</p>
<p>ApplicationContextAware :  è·å– ApplicationContext</p>
<p>BeanNameAware :   è®¾ç½® beanNameåå­—.</p>
<p>è¿™é‡Œä¹Ÿå¯ä»¥æŒ‰ç…§ä¸Šé¢çš„ç¬¨æ–¹æ³•ï¼Œä¸€æ¬¡å¯¹é‡å†™çš„æ–¹æ³•æ‰“ä¸Šæ–­ç‚¹. ç„¶åå¼€å¯æˆ‘ä»¬çš„debugæ¥çœ‹çœ‹æ–¹æ³•çš„æ‰§è¡Œé¡ºåº.</p>
<p>å…¶æ‰§è¡Œé¡ºåº :   setBeanName   â€”&gt;  setApplicationContext â€”&gt;  afterPropertiesSet  â€”&gt;  postProcessBeanDefinitionRegistry ,  è·Ÿç€è¿™å››ä¸ªæ–¹æ³•æ‰§è¡Œçš„é¡ºåºæ¥çœ‹.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public class MapperScannerConfigurer</span><br><span class="line">    implements BeanDefinitionRegistryPostProcessor, InitializingBean, ApplicationContextAware, BeanNameAware &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>èµ‹å€¼ç»™ beanName å€¼.   org.mybatis.spring.mapper.MapperScannerConfigurer#0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setBeanName(String name) &#123;</span><br><span class="line">  this.beanName &#x3D; name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç„¶åè¿™é‡Œæ˜¯ç»™åˆ° ApplicationContext. è¿™ä¹Ÿå°±è¯´è¿™ä¸ªç±»ç°åœ¨æœ‰äº† ApplicationContext,å¯ä»¥æ ¹æ®contextæä¾›çš„apiæ¥è¿›è¡Œç›¸åº”çš„æ“ä½œ.</span><br><span class="line">  @Override</span><br><span class="line">  public void setApplicationContext(ApplicationContext applicationContext) &#123;</span><br><span class="line">    this.applicationContext &#x3D; applicationContext;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æ£€éªŒé…ç½®åŒ…çš„å€¼ä¸èƒ½ä¸ºnull.</span><br><span class="line">  @Override</span><br><span class="line">  public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">    notNull(this.basePackage, &quot;Property &#39;basePackage&#39; is required&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   * å¯ä»¥æ„Ÿå—åˆ°è¿™ä¸ªæ–¹æ³•, åœ¨æ‹¿åˆ°äº†BeanDefinitionRegistryçš„æƒ…å†µä¸‹,å¾€é‡Œé¢æ³¨å†Œbd.</span><br><span class="line">   * @since 1.0.2</span><br><span class="line">   *&#x2F;</span><br><span class="line">  @Override</span><br><span class="line">  public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    if (this.processPropertyPlaceHolders) &#123;</span><br><span class="line">      processPropertyPlaceHolders();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¿™æ®µæ˜¯åˆ›å»ºäº†ä¸€ä¸ª ClassPathMapperScanner å¯¹è±¡,ç„¶åå¾€é‡Œé¢setå±æ€§.      </span><br><span class="line">    ClassPathMapperScanner scanner &#x3D; new ClassPathMapperScanner(registry);</span><br><span class="line">    scanner.setAddToConfig(this.addToConfig);</span><br><span class="line">    scanner.setAnnotationClass(this.annotationClass);</span><br><span class="line">    scanner.setMarkerInterface(this.markerInterface);</span><br><span class="line">    scanner.setSqlSessionFactory(this.sqlSessionFactory);</span><br><span class="line">    scanner.setSqlSessionTemplate(this.sqlSessionTemplate);</span><br><span class="line">    scanner.setSqlSessionFactoryBeanName(this.sqlSessionFactoryBeanName);</span><br><span class="line">    scanner.setSqlSessionTemplateBeanName(this.sqlSessionTemplateBeanName);</span><br><span class="line">    scanner.setResourceLoader(this.applicationContext);</span><br><span class="line">    scanner.setBeanNameGenerator(this.nameGenerator);</span><br><span class="line">    scanner.setMapperFactoryBeanClass(this.mapperFactoryBeanClass);</span><br><span class="line">      </span><br><span class="line">    if (StringUtils.hasText(lazyInitialization)) &#123;</span><br><span class="line">      scanner.setLazyInitialization(Boolean.valueOf(lazyInitialization));</span><br><span class="line">    &#125;</span><br><span class="line">    if (StringUtils.hasText(defaultScope)) &#123;</span><br><span class="line">      scanner.setDefaultScope(defaultScope);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">&#x2F;&#x2F; å¯¹registeré‡Œçš„ä¿¡æ¯è¿›è¡Œè¿‡æ»¤      </span><br><span class="line">    scanner.registerFilters();</span><br><span class="line">&#x2F;&#x2F; org.springframework.context.annotation.ClassPathBeanDefinitionScanner#scan</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œä¸»è¦çœ‹æ‰«æçš„æ–¹æ³•. æ ¹æ®,æ¥åˆ‡å‰²æˆ‘ä»¬å†™çš„ basePackage ä¿¡æ¯.æ‰«æç±»çš„ä¿¡æ¯,æœ€åè¿˜æ˜¯å€Ÿç”¨äº† org.springframework.context.annotation.ClassPathBeanDefinitionScanner#doScan æ¥è¿›è¡Œæ‰«æçš„. &#x2F;&#x2F;  doScan(basePackages) æ˜¯å¯¹ xml è¿›è¡Œæ‰«æçš„.</span><br><span class="line">&#x2F;&#x2F; AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry); æ˜¯å¯¹æ³¨è§£è¿›è¡Œæ‰«æçš„.</span><br><span class="line">&#x2F;&#x2F; æœ€åè¿”å›æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­çš„ bean ä¸ªæ•°</span><br><span class="line">&#x2F;&#x2F; æ‰€ä»¥å¦‚æœæˆ‘ä»¬é…ç½®äº†ä¸‹é¢çš„æ ‡ç­¾,é‚£ä¹ˆåœ¨è¿™é‡Œéƒ½ä¼šè¢«æ‰«æåˆ°å¹¶ä¸”æ³¨å†Œåˆ°Springå®¹å™¨ä¸­.</span><br><span class="line">&#x2F;&#x2F;     &lt;bean class&#x3D;&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">&#x2F;&#x2F;        &lt;property name&#x3D;&quot;basePackage&quot; value&#x3D;&quot;com.iyang.sm.mapper&quot; &gt;&lt;&#x2F;property&gt;</span><br><span class="line">&#x2F;&#x2F;    &lt;&#x2F;bean&gt;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯:  org.mybatis.spring.mapper.ClassPathMapperScanner#processBeanDefinitions</span><br><span class="line">&#x2F;&#x2F;   definition.setBeanClass(this.mapperFactoryBeanClass);  è¿™é‡Œçš„è¿™è¡Œä»£ç ,æ˜¯ç»™bdçš„beanClassç»™æ¢æˆäº† MapperFactoryBean.class , </span><br><span class="line">&#x2F;&#x2F;  definition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName);     &#x2F;&#x2F; è¿™å¥ä»£ç ,å°† beanClassName ç»™åˆ° dbä¹‹å, ç„¶åå°±æ‰ç”¨ beanClassNameæ¥newä¸€ä¸ª MapperFactoryBean å¯¹è±¡æ¥, æ‰€ä»¥è¿™é‡Œå¹¶ä¸æ˜¯ä½¿ç”¨æ— å‚æ„é€ å‡½æ•°.</span><br><span class="line">&#x2F;&#x2F; ä¹Ÿè®¸ä¼šé—®,æ€ä¹ˆè¯å®æ²¡æœ‰èµ°æ— å‚æ•°æ„é€ å‡½æ•°å‘¢ ? è€Œæ˜¯å»èµ°çš„ set æ–¹æ³•å‘¢ ? </span><br><span class="line">&#x2F;&#x2F; å†ä¸èƒ½åŠ¨æºç çš„æƒ…å†µä¸‹, é¢å¯¹è¿™ç§æƒ…å†µæƒ…å†µæœ€å¥½çš„åŠæ³•å°±æ˜¯, åœ¨æ— å‚æ„é€ å‡½æ•°ä¸Šæ‰“ä¸Šæ–­ç‚¹.</span><br><span class="line">&#x2F;&#x2F; å¦‚æœæ²¡èµ°åˆ°æ–­ç‚¹ä¸Š,é‚£å°±è¯´æ˜ä¸æ˜¯èµ°çš„æ— å‚æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–çš„.      </span><br><span class="line">    scanner.scan(</span><br><span class="line">        StringUtils.tokenizeToStringArray(this.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åˆ°è¿™é‡Œ, å¯ä»¥çœ‹åˆ° MyBatis ä¸ Spring æ•´åˆçš„è¿‡ç¨‹å°±å·²ç»å®Œæˆäº†.</p>
<p>æˆ‘ä»¬è¿™é‡Œæ˜¯ä¸»è¦å¯¹ SqlSessionFactoryBean å’Œ MapperScannerConfigurer æ¥è¿›è¡Œåˆ†æçš„,  å¯ä»¥å¾ˆæ˜æ˜¾çš„æ„Ÿè§‰åˆ°,æˆ‘ä»¬æ˜¯é…ç½®å¥½è¿™äºŒä¸ªbeanå,å°±å¯ä»¥ä½¿ç”¨äº†.  ç€é‡çœ‹ç¬¬äºŒä¸ª,   org.mybatis.spring.mapper.MapperScannerConfigurer è¿™ä¸ªbean,å°±æ˜¯åšäº†å¦‚ä½•å°† MyBatis çš„ mapperæ¥å£æ–‡ä»¶ç»™åŠ è½½åˆ° Spring ä¸­æ¥çš„.   <strong>é‚£ä¹ˆè¿™é‡Œæˆ‘åœ¨æƒ³, å¦‚æœæœ‰å¤©æˆ‘è‡ªå·±å¼€å‘å‡ºä¸€ä¸ªå¥½ç”¨çš„æ¡†æ¶æ¥,è¦ä¸ Spring è¿›è¡Œæ•´åˆçš„è¯,æ˜¯ä¸æ˜¯ä¹Ÿè¿™æ ·æ•´åˆå°±å¯ä»¥äº†ï¼Ÿ</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- é…ç½®sqlSessionFactoryï¼ŒSqlSessionFactoryBeanæ˜¯ç”¨æ¥äº§ç”ŸsqlSessionFactoryçš„ --&gt;</span><br><span class="line">&lt;bean id&#x3D;&quot;sqlSessionFactory&quot; class&#x3D;&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">    &lt;!-- åŠ è½½mybatisçš„å…¨å±€é…ç½®æ–‡ä»¶ï¼Œæ”¾åœ¨classpathä¸‹çš„mybatisæ–‡ä»¶å¤¹ä¸­äº† --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;configLocation&quot; value&#x3D;&quot;mybatis&#x2F;SqlMapConfig.xml&quot; &#x2F;&gt;</span><br><span class="line">    &lt;!-- åŠ è½½æ•°æ®æºï¼Œä½¿ç”¨ä¸Šé¢é…ç½®å¥½çš„æ•°æ®æº --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;dataSource&quot; ref&#x3D;&quot;dataSource&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--  é…ç½®æ‰«æ MyBatis æ¥å£çš„åŒ… --&gt;</span><br><span class="line">&lt;bean class&#x3D;&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;basePackage&quot; value&#x3D;&quot;com.iyang.sm.mapper&quot; &gt;&lt;&#x2F;property&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br></pre></td></tr></table></figure>

<h4 id="-2"><a href="#-2" class="headerlink" title=""></a></h4><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>â€‹    å¯ä»¥çœ‹åˆ°  MyBatis ä¸ Spring æ•´åˆå,  å¯¹äºè§£æ MyBatis çš„ mapper  é…ç½®æ–‡ä»¶ç­‰ï¼Œéƒ½æ˜¯èµ°çš„ä¹‹å‰å•ä¸ª mybatis çš„é€»è¾‘, æ˜¯æ²¡æœ‰ä»€ä¹ˆå˜åŒ–çš„.   ä¸»è¦çš„æ˜¯å°† , SqlSessionFactory å’Œ  Mapper.class(æ¥å£ç±») ç»™æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­.ç„¶åæ¥å£çš„è¯, æ˜¯æ€ä¹ˆä½¿ç”¨çš„ä»£ç†ç±»æ¥è¿›è¡Œå®ä¾‹åŒ–å®Œå, å°†å¯¹è±¡ç»™æ³¨å…¥åˆ°  Spring å®¹å™¨ä¸­çš„å‘¢ ï¼Ÿ è¿™é‡Œçœ‹  org.mybatis.spring.mapper.MapperScannerConfigurer  åšçš„äº‹æƒ…å°±æ˜ç™½äº†.</p>
<p>â€‹    ä¸è¿‡åœ¨çœ‹ mybatis ä¸ Spring æ•´åˆçš„æ—¶å€™, è¿˜æ˜¯å»ºè®®è¦æœ‰å¯¹  BeanDefinitionRegistryPostProcessor  /  InitializingBean /   ApplicationContextAware  /  BeanNameAware æœ‰ä¸€å®šçš„äº†æ¥.  å°±æ˜¯æœ‰äº†äº†è§£å, ä½ å°±ä¼šå¾ˆæ˜æ˜¾çš„æ„Ÿå—åˆ°ï¼Œ  mybatis ä¸ºä»€ä¹ˆæ˜¯å®ç°è¿™ä¸ªæ¥å£ï¼Œå®ç°è¿™ä¸ªæ¥å£å¹¶ä¸”é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨åé¢æ˜¯ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨çš„. æ„æ€ä¹Ÿå°±æ˜¯ï¼Œä½ è‡³å°‘å¾—æ˜ç™½ç‚¹ Spring  å¯¹å¤–æä¾›çš„ä¸€äº›æ‰©å±•ç‚¹ï¼Œæ‰èƒ½å¾ˆå¥½çš„ç†è§£è¿™äº›ä¸œè¥¿.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lwfby.cn/2020/12/27/mybatis/mybatis-local-cache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YangL">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YangL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/27/mybatis/mybatis-local-cache/" itemprop="url">mybatis-local-cache</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-12-27T22:10:14+08:00">
                2020-12-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MyBatis/" itemprop="url" rel="index">
                    <span itemprop="name">MyBatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  3.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  14
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p>â€‹    ç¼“å­˜è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨è®¸å¤šåœ°æ–¹éƒ½æœ‰çš„ï¼Œåˆ©ç”¨åˆ°å¥½çš„è¯ï¼Œå¯¹ç³»ç»Ÿçš„å¾ˆå¤šåœ°æ–¹æŸ¥è¯¢æ˜¯æœ‰å¾ˆå¤§çš„æå‡çš„.  å¯ä»¥çœ‹åˆ°,MyBatis ä¹Ÿæ˜¯æœ‰  cache çš„ï¼Œé‚£MyBatis æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªç¼“å­˜çš„å‘¢ï¼Ÿ åœ¨  INSERT/UPDATE/DELETE/SELECTä¸­,æ˜¯ä¸æ˜¯åªæœ‰SELECTçš„æ—¶å€™ç”¨åˆ°äº†ç¼“å­˜ï¼Œå¦‚æœæ˜¯  INSERT/UPDATE/DELETE æ˜¯å¦ä¼šå¯¹ç¼“å­˜æœ‰å½±å“ï¼Ÿ</p>
<p>â€‹    å¯ä»¥çœ‹ç»“æœæ¥åˆ†æï¼Œç„¶åè·Ÿè¿›æºç æ¥ä»”ç»†åˆ†æ.</p>
<p>â€‹    MyBatis æ˜¯åˆ†ä¸º ä¸€çº§ç¼“å­˜ å’Œ äºŒçº§ç¼“å­˜çš„. é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å…ˆä»ä¸€çº§ç¼“å­˜å¼€å§‹.</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="ä¸€çº§ç¼“å­˜"><a href="#ä¸€çº§ç¼“å­˜" class="headerlink" title="ä¸€çº§ç¼“å­˜"></a>ä¸€çº§ç¼“å­˜</h4><p>â€‹     æ¡ˆä¾‹ä»£ç  :</p>
<p>â€‹     è¿™é‡Œæˆ‘ä»¬æ˜¯æ‰“å°çš„æŸ¥è¯¢sqlçš„è¯­å¥ï¼Œå†ç¬¬äºŒæ¬¡å†æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ˜¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream &#x3D; Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line"></span><br><span class="line">SqlSessionFactory sqlSessionFactory &#x3D; new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">SqlSession session &#x3D; sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper &#x3D; session.getMapper(BlogMapper.class);</span><br><span class="line">TbBlog tbBlog &#x3D; blogMapper.selectBlog(1);</span><br><span class="line">System.out.println(blogMapper.selectBlog(1));</span><br><span class="line">System.out.println(tbBlog);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç»“æœå¯ä»¥çœ‹åˆ°,ç¬¬äºŒæ¬¡å¹¶æ²¡æœ‰å†æ‰“å°å‡º sql è¯­å¥æ¥.</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, 6565</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br><span class="line">TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br></pre></td></tr></table></figure>



<p>æ¡ˆä¾‹äºŒ :  æˆ‘ä»¬å†ç¬¬äºŒæ¬¡æŸ¥è¯¢ä¹‹å‰ åŠ å…¥ ä¸€ä¸ªadd æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream &#x3D; Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line"></span><br><span class="line">SqlSessionFactory sqlSessionFactory &#x3D; new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">SqlSession session &#x3D; sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper &#x3D; session.getMapper(BlogMapper.class);</span><br><span class="line">TbBlog tbBlog &#x3D; blogMapper.selectBlog(1);</span><br><span class="line"></span><br><span class="line">System.out.println(blogMapper.addBlog(&quot;GavinYang&quot;));</span><br><span class="line">System.out.println(blogMapper.selectBlog(1));</span><br><span class="line">System.out.println(tbBlog);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; çœ‹ç»“æœ,å¯ä»¥çœ‹åˆ°å½“ä¸­é—´ç©¿æ’ä¸€ä¸ª insert çš„sqlè¯­å¥,é‚£ä¹ˆåœ¨ç¬¬äºŒæ¬¡æŸ¥è¯¢çš„æ—¶å€™,å°±ä¼šæ‰§è¡Œsqlè¯­å¥.</span><br><span class="line">&#x2F;&#x2F; é‚£ä¹ˆä¹Ÿå°±è¯´ï¼Œè¿™ä¸ªæ—¶å€™ç¼“å­˜æ˜¯å¤±æ•ˆäº†.</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, 6565</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: insert into tb_blog (name) values(?) </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: GavinYang(String)</span><br><span class="line">&lt;&#x3D;&#x3D;    Updates: 1</span><br><span class="line">1</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, 6565</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br><span class="line">TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br></pre></td></tr></table></figure>



<p>æ¡ˆä¾‹ä¸‰ :  ä½¿ç”¨äºŒä¸ª SqlSession  æ¡ˆä¾‹</p>
<p>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ° , åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™è¿˜å‡ºç°äº†è„æ•°æ®.</p>
<p>è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€çº§ç¼“å­˜æ˜¯åªåœ¨ SqlSession ä¸­å­˜åœ¨çš„,ä¹Ÿå°±æ˜¯æ•°æ®åº“ä¼šè¯å†…éƒ¨å…±äº«çš„.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream &#x3D; Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">SqlSessionFactory sqlSessionFactory &#x3D; new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line"></span><br><span class="line">SqlSession openSession1 &#x3D; sqlSessionFactory.openSession();</span><br><span class="line">SqlSession openSession2 &#x3D; sqlSessionFactory.openSession();</span><br><span class="line">BlogMapper blogMapper1 &#x3D; openSession1.getMapper(BlogMapper.class);</span><br><span class="line">BlogMapper blogMapper2 &#x3D; openSession2.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;blogMapper1 è¯»å–æ•°æ® &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">System.out.println(&quot;blogMapper2 è¯»å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">System.out.println(blogMapper1.updateHashCode(&quot;PeterWong&quot;));</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;blogMapper1 è¯»å–æ•°æ® &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">System.out.println(&quot;blogMapper2 è¯»å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹åˆ° log æ‰“å°å‡ºæ¥çš„å†…å®¹</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, 6565</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">blogMapper1 è¯»å–æ•°æ® TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br><span class="line">Created connection 433287555.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@19d37183]</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, 6565</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">blogMapper2 è¯»å–æ•°æ®TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: update tb_blog set name &#x3D; ? where id &#x3D; 1; </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: PeterWong(String)</span><br><span class="line">&lt;&#x3D;&#x3D;    Updates: 1</span><br><span class="line">1</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, PeterWong</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">blogMapper1 è¯»å–æ•°æ® TbBlog&#123;id&#x3D;1, name&#x3D;&#39;PeterWong&#39;&#125;</span><br><span class="line">blogMapper2 è¯»å–æ•°æ®TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¯´äº†ä¸‰é¢çš„è¿™ä¸‰ç§æƒ…å†µ, å…·ä½“çš„æ‰§è¡Œæµç¨‹å¯ä»¥æˆ‘ä»¬å¯ä»¥ç°åœ¨ æ¡ˆä¾‹ä¸€é‡Œé¢å¯¹ç¬¬äºŒæ¬¡ query è¿›è¡Œ debug åˆ†ææ“ä½œ.    å½“æˆ‘ä»¬debugåˆ°  org.apache.ibatis.executor.BaseExecutor#query(org.apache.ibatis.mapping.MappedStatement, java.lang.Object, org.apache.ibatis.session.RowBounds,  org.apache.ibatis.session.ResultHandler,  org.apache.ibatis.cache.CacheKey, org.apache.ibatis.mapping.BoundSql)  çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°  org.apache.ibatis.executor.BaseExecutor#localCache åªæœ‰ä¸€ä¸ª ç¼“å­˜çš„å€¼çš„ ï¼Œ æ ¹æ® getObject æ–¹æ³•å¯ä»¥è·Ÿè¿›åˆ° org.apache.ibatis.cache.impl.PerpetualCache#cache  ä¸­æ¥,</p>
<p>ä¼ å…¥è¿›æ¥çš„ key å€¼æ˜¯ :   -1896651191:1062027004:com.iyang.mybatis.mapper.BlogMapper.selectBlog:0:2147483647:select * from tb_blog where id = ?:1:development  ç„¶åä» cache ä¸­è·å–å‡ºå€¼æ¥, æ‰€ä»¥è¿™é‡Œå°±æ²¡æœ‰èµ°  query çš„æŸ¥è¯¢è¯­å¥.</p>
<p>è¿™æ˜¯å‘½ä¸­ç¼“å­˜çš„æƒ…å†µ.</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹, åœ¨ç¬¬äºŒæ¬¡ query ä¹‹å‰å¦‚æœæ‰§è¡Œäº†ä¸€ä¸ª add æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆå°±å‘½ä¸­ä¸äº†äº†å‘¢ï¼Ÿ</p>
<p>è¿™é‡Œå¯ä»¥å¤§è‡´çŒœæµ‹ä¸‹ï¼Œåœ¨æ‰§è¡Œå®Œ add æ–¹æ³•åï¼Œæ˜¯ä¸æ˜¯ç»™ cache ç»™æ¸…é™¤æ‰äº†ï¼Œç„¶åå†å»æŸ¥è¯¢çš„æ—¶å€™ï¼Œå°±æŸ¥è¯¢ä¸åˆ°äº†.</p>
<p>äºæ˜¯æˆ‘ä»¬åœ¨ add æ–¹æ³•ä¸Šè¿›è¡Œ debug æŸ¥çœ‹ä¸‹ :</p>
<p>æœ€åæˆ‘ä»¬ debug è·Ÿè¿›åˆ°è¿™é‡Œ :  org.apache.ibatis.executor.BaseExecutor#clearLocalCache å°±å¯ä»¥å‘ç°</p>
<p>è¿™é‡Œæ˜¯æœ‰äºŒä¸ª clear æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ¸…é™¤æ–¹æ³•.</p>
<p>localCache.clear()   â€”-&gt;     org.apache.ibatis.cache.impl.PerpetualCache#clear   å¯¹åº”çš„å°±æ˜¯è¿™é‡Œçš„æ¸…æ¥šæ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ HashMap çš„clear æ–¹æ³•è¿›è¡Œæ¸…é™¤.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localCache.clear();</span><br><span class="line">localOutputParameterCache.clear();</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¿™é‡Œå¯ä»¥çœ‹å‡ºåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ query ä¹‹å‰ï¼Œå¦‚æœæ˜¯æœ‰ insert/update/delete ç­‰æ–¹æ³•çš„è¯ï¼Œå°±ä¼šå»é‡ç½®è¿™äºŒä¸ªåœ°æ–¹çš„ç¼“å­˜çš„.</p>
<p>MyBatis çš„ä¸€çº§ç¼“å­˜çš„æ˜¯è·Ÿéš  SqlSession çš„ï¼Œè¿™é‡Œæ˜¯å¯ä»¥æ ¹æ®ç®€å•çš„æ¡ˆä¾‹æ•ˆæœçœ‹å‡ºæ¥çš„.</p>
<p>ä¸€çº§ç¼“å­˜åªæ˜¯ä½¿ç”¨äº†ä¸€ä¸ª HashMap , æœ€åæ¸…é™¤ç¼“å­˜çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯è°ƒç”¨ HashMap çš„clear æ–¹æ³•</p>
<p>æœ€åä»æ¡ˆä¾‹ä¸‰å¯ä»¥çœ‹å‡ºæ¥ï¼Œå½“å¤šä¸ª  SqlSession çš„æ—¶å€™ï¼Œç”±äºå„è‡ªæœ‰å­˜æœ‰å„è‡ªçš„ç¼“å­˜ï¼Œæ‰€ä»¥æ˜¯å¾ˆå®¹æ˜“å¼•èµ·è„æ•°æ®çš„, å°†ç¼“å­˜çº§åˆ«è®¾ç½®ä¸º Statement.</p>
<h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><h4 id="äºŒçº§ç¼“å­˜"><a href="#äºŒçº§ç¼“å­˜" class="headerlink" title="äºŒçº§ç¼“å­˜"></a>äºŒçº§ç¼“å­˜</h4><p>â€‹     å¯ä»¥çœ‹åˆ°ä¸€çº§ç¼“å­˜çš„è¯ï¼Œæ˜¯å±€é™äº SqlSession . å¦‚æœè¦å¤šä¸ª sqlSession ä¹‹é—´å…±äº«ç¼“å­˜çš„è¯ï¼Œå°±éœ€è¦å¼€å¯äºŒçº§ç¼“å­˜.   å¼€å¯çš„è¯,æˆ‘ä»¬åœ¨ MyBatis é…ç½®æ–‡ä»¶ä¸­åŠ ä¸Š:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;setting name&#x3D;&quot;logImpl&quot; value&#x3D;&quot;STDOUT_LOGGING&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- å¼€å¯äºŒçº§ç¼“å­˜ --&gt;</span><br><span class="line">    &lt;setting name&#x3D;&quot;cacheEnabled&quot; value&#x3D;&quot;true&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;settings&gt;</span><br></pre></td></tr></table></figure>

<p>â€‹    <strong>æ¡ˆä¾‹ä¸€ :  æ˜¯å¦æäº¤äº‹åŠ¡</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    InputStream mybatisInputStream &#x3D; Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">    SqlSessionFactory sqlSessionFactory &#x3D; new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">    SqlSession sqlSession1 &#x3D; sqlSessionFactory.openSession(true);</span><br><span class="line">    SqlSession sqlSession2 &#x3D; sqlSessionFactory.openSession(true);</span><br><span class="line"></span><br><span class="line">    BlogMapper blogMapper1 &#x3D; sqlSession1.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper2 &#x3D; sqlSession2.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;blogMapper1 è·å–æ•°æ®&quot; + blogMapper1.selectBlog(1));</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; sqlSession1.commit();</span><br><span class="line">    </span><br><span class="line">    System.out.println(&quot;blogMapper2 è·å–æ•°æ®&quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;   ----------------   trueç»“æœ   -----------------------</span><br><span class="line"></span><br><span class="line">Created connection 492079624.</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, 6565</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">blogMapper1 è·å–æ•°æ®TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br><span class="line">Opening JDBC Connection</span><br><span class="line">    </span><br><span class="line">Created connection 433287555.</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, 6565</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">blogMapper2 è·å–æ•°æ®TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ------------   åŠ ä¸Šcommit()æ–¹æ³•ç»“æœ   ---------------</span><br><span class="line"></span><br><span class="line">Created connection 630074945.</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, 6565</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">blogMapper1 è·å–æ•°æ®TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.5</span><br><span class="line">blogMapper2 è·å–æ•°æ®TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹    ä»è¿™é‡Œçœ‹, æ˜¯å¦æäº¤äº‹åŠ¡å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ˜¯ä¼šå½±å“äºŒçº§ç¼“å­˜çš„.</p>
<p><strong>æ¡ˆä¾‹äºŒ :  ä¸­é—´ç©¿æ’æ›´æ–°è¯­å¥</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args)  throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    InputStream mybatisInputStream &#x3D; Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">    SqlSessionFactory sqlSessionFactory &#x3D; new SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">    SqlSession sqlSession1 &#x3D; sqlSessionFactory.openSession(false);</span><br><span class="line">    SqlSession sqlSession2 &#x3D; sqlSessionFactory.openSession(false);</span><br><span class="line">    SqlSession sqlSession3 &#x3D; sqlSessionFactory.openSession(false);</span><br><span class="line"></span><br><span class="line">    BlogMapper blogMapper1 &#x3D; sqlSession1.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper2 &#x3D; sqlSession2.getMapper(BlogMapper.class);</span><br><span class="line">    BlogMapper blogMapper3 &#x3D; sqlSession3.getMapper(BlogMapper.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper1 æŸ¥è¯¢å‡ºæ¥çš„æ•°æ® : &quot; + blogMapper1.selectBlog(1));</span><br><span class="line">    sqlSession1.commit();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : &quot; + blogMapper2.selectBlog(1));</span><br><span class="line"></span><br><span class="line">    System.out.println(blogMapper3.updateHashCode(&quot;GavinYang&quot;));</span><br><span class="line">    sqlSession3.commit();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot; blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : &quot; + blogMapper2.selectBlog(1));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;  ------------------  æ‰“å°ç»“æœ ------</span><br><span class="line"></span><br><span class="line">Created connection 630074945.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@258e2e41]</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, 6565</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line"> blogMapper1 æŸ¥è¯¢å‡ºæ¥çš„æ•°æ® : TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.5</span><br><span class="line"> blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : TbBlog&#123;id&#x3D;1, name&#x3D;&#39;6565&#39;&#125;</span><br><span class="line"></span><br><span class="line">Created connection 603443293.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@23f7d05d]</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: update tb_blog set name &#x3D; ? where id &#x3D; 1; </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: GavinYang(String)</span><br><span class="line">&lt;&#x3D;&#x3D;    Updates: 1</span><br><span class="line">1</span><br><span class="line">Committing JDBC Connection [com.mysql.jdbc.JDBC4Connection@23f7d05d]</span><br><span class="line">Cache Hit Ratio [com.iyang.mybatis.mapper.BlogMapper]: 0.3333333333333333</span><br><span class="line">Opening JDBC Connection</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">Created connection 707976812.</span><br><span class="line">Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@2a32de6c]</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: select * from tb_blog where id &#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 1(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 1, GavinYang</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line"> blogMapper2 æŸ¥è¯¢å‡ºæ¥çš„ç»“æœ : TbBlog&#123;id&#x3D;1, name&#x3D;&#39;GavinYang&#39;&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ˜¯å¯ä»¥çœ‹åˆ°åœ¨æ›´æ–°ä¹‹åå¹¶ä¸” commit äº†äº‹åŠ¡ä¹‹åï¼Œåé¢ç´§è·Ÿçš„ sql æ˜¯å»æŸ¥è¯¢ æ•°æ®åº“äº†çš„.   æ‰€ä»¥è¿™é‡Œæ˜¯å¯ä»¥çœ‹å‡ºæ¥ï¼Œupdateç­‰æ“ä½œæ˜¯ä¼šå» æ¸…ç©ºå¯¹åº”çš„ç¼“å­˜çš„ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æ ¹æ® æ¡ˆä¾‹ä¸€ çš„æƒ…å†µæ¥åˆ†æï¼Œåœ¨å¼€å¯äº† äºŒçº§ç¼“å­˜ çš„æ—¶å€™ï¼Œæ˜¯ä»å“ªé‡Œè·å–å‡ºæ¥çš„æ•°æ®çš„å‘¢ï¼Ÿ</p>
<p>debug è·Ÿè¿›æ¥ :     org.apache.ibatis.executor.CachingExecutor#query(org.apache.ibatis.mapping.MappedStatement, java.lang.Object, org.apache.ibatis.session.RowBounds,  org.apache.ibatis.session.ResultHandler,  org.apache.ibatis.cache.CacheKey, org.apache.ibatis.mapping.BoundSql)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span><br><span class="line">    throws SQLException &#123;</span><br><span class="line">  Cache cache &#x3D; ms.getCache();</span><br><span class="line">  if (cache !&#x3D; null) &#123;</span><br><span class="line">    flushCacheIfRequired(ms);</span><br><span class="line">    if (ms.isUseCache() &amp;&amp; resultHandler &#x3D;&#x3D; null) &#123;</span><br><span class="line">      ensureNoOutParams(ms, boundSql);</span><br><span class="line">      @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">&#x2F;&#x2F; debug åˆ°è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°,å°±å·²ç»è¿”å›äº†æˆ‘ä»¬éœ€è¦çš„æ•°æ®.        </span><br><span class="line">      List&lt;E&gt; list &#x3D; (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">      if (list &#x3D;&#x3D; null) &#123;</span><br><span class="line">        list &#x3D; delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">        tcm.putObject(cache, key, list); &#x2F;&#x2F; issue #578 and #116</span><br><span class="line">      &#125;</span><br><span class="line">      return list;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>org.apache.ibatis.executor.CachingExecutor#tcm  è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ getObject  æ–¹æ³•è·å–åˆ°äº†æˆ‘ä»¬éœ€è¦çš„å€¼, è·Ÿè¿›æ¥åˆä»  org.apache.ibatis.cache.decorators.TransactionalCache çš„ getObject  è·å–å‡ºæˆ‘ä»¬çš„å€¼, æœ€åä»   org.apache.ibatis.cache.decorators.TransactionalCache#delegate è·å–å‡ºå€¼,  è¿”å›å›æ¥çš„.</p>
<p>org.apache.ibatis.cache.decorators.TransactionalCache#getObject</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">  &#x2F;&#x2F; issue #116</span><br><span class="line">&#x2F;&#x2F; ä»ç¼“å­˜ä¸­è·å–å‡ºå€¼.    </span><br><span class="line">  Object object &#x3D; delegate.getObject(key);</span><br><span class="line">  if (object &#x3D;&#x3D; null) &#123;</span><br><span class="line">&#x2F;&#x2F; å¦‚æœè·å–å‡ºæ¥æ˜¯null,ä¹Ÿå°±æ˜¯ç¼“å­˜ä¸­æ²¡æœ‰çš„è¯,org.apache.ibatis.cache.decorators.TransactionalCache#entriesMissedInCache å°±æ·»åŠ åˆ°è¿™ä¸ªé›†åˆä¸­æ¥.      </span><br><span class="line">    entriesMissedInCache.add(key);</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; issue #146</span><br><span class="line">&#x2F;&#x2F; commit åéœ€è¦ clear çš„è¯ï¼Œå°±ä¼šè¿”å› null.</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæƒ³ä¸‹è¿™ä¸ªå˜é‡ä¼šä¸ä¼šå’Œæˆ‘é—¨æ¡ˆä¾‹äºŒä¸­çš„ update æ“ä½œæœ‰å…³ç³»å‘¢ï¼Ÿ</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œå† updateåå† debug å‘ç°,  delegate ä¸­è·å–å‡ºæ¥çš„æ˜¯ null ,ä¹Ÿå°±æ˜¯ç¡®å®æ˜¯è·å–ä¸åˆ°ç¼“å­˜äº†</span><br><span class="line">&#x2F;&#x2F; å’Œè¿™ä¸ªå‚æ•°æ²¡å…³ç³».    </span><br><span class="line">  if (clearOnCommit) &#123;</span><br><span class="line">    return null;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return object;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyBatis äºŒçº§ç¼“å­˜ä¸é€‚åº”äºé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨å¤šè¡¨æŸ¥è¯¢çš„æƒ…å†µ. ä¸€èˆ¬æˆ‘ä»¬æ˜¯å•è¡¨çš„ cache, ç”±äº mybatis çš„äºŒçº§ç¼“å­˜æ˜¯åŸºäº  namespace çš„, å¤šè¡¨æŸ¥è¯¢è¯­å¥æ‰€åœ¨çš„ namespace æ— æ³•æ„Ÿåº”åˆ°å…¶ä»–çš„ namespace  ä¸­çš„è¯­å¥å¯¹å¤šè¡¨ä¸­è®¾è®¡ä¿®æ”¹ï¼Œå°±ä¼šå¼•å‘è„æ•°æ®.  è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨ cache-ref æ¥åšå¤„ç†ï¼Œä½†æ˜¯è¿™æ ·çš„è¯,ç¼“å­˜çš„é¢—ç²’åº¦å°±å˜ç²—äº†.</p>
<p>æ‰§è¡Œæµç¨‹ :  å¦‚æœå¼€å¯äº†äºŒçº§ç¼“å­˜çš„è¯ï¼Œ MyBatis ä¼šå…ˆèµ°äºŒçº§ç¼“å­˜ï¼Œå¦‚æœäºŒçº§ç¼“å­˜æ²¡æœ‰çš„è¯ï¼Œå°±ä¼šå»ä¸€çº§ç¼“å­˜çœ‹çœ‹ï¼Œå¦‚æœéƒ½æ²¡æœ‰çš„è¯ï¼Œå°±å»æŸ¥è¯¢æ•°æ®åº“.</p>
<p>äºŒçº§ç¼“å­˜ :  ç”¨  org.apache.ibatis.executor.CachingExecutor è£…é¥°äº†   org.apache.ibatis.executor.BaseExecutor çš„å­ç±», å§”æ‰˜å…·ä½“èŒè´£ç»™ delegate  ä¹‹å‰ï¼Œå®ç°äº†äºŒçº§ç¼“å­˜çš„æŸ¥è¯¢å’Œå†™å…¥åŠŸèƒ½.</p>
<h4 id="-2"><a href="#-2" class="headerlink" title=""></a></h4><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æœ€åçœ‹ ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œéƒ½æ˜¯åˆ©ç”¨çš„ HashMap è¿™ç§æ¥åšåˆ°æœ¬åœ°ç¼“å­˜ï¼Œ åªæ˜¯äºŒçº§ç¼“å­˜çš„ä½œç”¨èŒƒå›´æ¯”èµ·ä¸€çº§ç¼“å­˜çš„è¯ï¼Œæ˜¯è¦å¤§çš„ï¼Œå¹¶ä¸”ä¹Ÿåˆ©ç”¨äº†ä¸€äº› è£…é¥°è€… ç­‰è®¾è®¡æ¨¡å¼æ¥è®¾è®¡äºŒçº§ç¼“å­˜çš„.</p>
<p>å¦‚æœæ˜¯éƒ¨ç½²çš„åˆ†å¸ƒå¼é¡¹ç›®çš„è¯ï¼Œé‚£ä¹ˆè¿˜æ˜¯ å¾—åˆ‡æ¢åˆ° redis è¿™ç§ç¼“å­˜æ¥äº†ï¼Œ æœ¬åœ°åˆ©ç”¨ HashMap è¿™ç§ç¼“å­˜æ»¡è¶³ä¸äº†çš„.</p>
<p>æ–‡çŒ®å‚è€ƒåœ°å€ : <a href="https://tech.meituan.com/2018/01/19/mybatis-cache.html" target="_blank" rel="noopener">https://tech.meituan.com/2018/01/19/mybatis-cache.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lwfby.cn/2020/12/25/mybatis/mybatis-mapper-xml-read/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YangL">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YangL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/25/mybatis/mybatis-mapper-xml-read/" itemprop="url">mybatis-mapper-xml-read</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-12-25T00:36:37+08:00">
                2020-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MyBatis/" itemprop="url" rel="index">
                    <span itemprop="name">MyBatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  3.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  15
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p> MyBatisæ˜¯å¦‚ä½•å¯¹ Mapper æ–‡ä»¶ä¸­çš„sqlè¿›è¡Œå¤„ç†å‘¢ï¼Ÿ è™½ç„¶ä¸Šç¯‡è§£æ mybatis-config.xml æ˜¯æœ‰è¿›è¡Œè¯´æ˜çš„, ä½†æ˜¯åº”è¯¥æ‹¿å‡ºæ¥å•ç‹¬ä»”ç»†è§£æä¸‹. å› ä¸ºè¿™ä¸ªé‡Œé¢æ¶‰åŠåˆ°åŠ¨æ€sql, åŠ ä¸Šmapperæ–‡ä»¶è‡ªèº«ä¹Ÿæœ‰å¾ˆå¤šæ ‡ç­¾å†…å®¹,ç„¶åMyBatisæ˜¯æ€ä¹ˆè¯»å–å‡ºè¿™äº›å†…å®¹çš„å‘¢ï¼Ÿè¯»å–å‡ºæ¥å,åˆæ˜¯åšäº†æ€ä¹ˆæ ·çš„å¤„ç†, ç„¶åè¾¾åˆ°äº†sqlé‚£ç§æ‰§è¡Œæ•ˆæœçš„å‘¢ï¼Ÿ</p>
<p> æ„æ€ä¹Ÿå°±æ˜¯,Mapper + åŠ¨æ€sql , å†…å®¹è¿˜æ˜¯æœ‰ç‚¹å¤šçš„, å¹¶ä¸”ä¹Ÿå¾ˆé‡è¦, æ˜¯éå¸¸æœ‰å¿…è¦æ‹¿å‡ºæ¥å•ç‹¬çš„ä»”ç»†è®²è§£ä¸‹çš„.</p>
<h4 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h4><p> åœ¨ä¹‹å‰å¯¹æ ‡ç­¾çš„è¿›è¡Œè§£æçš„æ—¶å€™,æ˜¯æœ‰å¯¹ æ ‡ç­¾è¿›è¡Œä¸€ä¸ªåˆæ­¥çš„è§£æ. ç„¶åé‡Œé¢å…¶å®æ˜¯å¾ˆå¤šå†…å®¹è¿˜æ²¡å¡«è¡¥å¾ˆè¯¦ç»†,æ‰€ä»¥ç‰¹æ„è®°å½•ä¸‹å¯¹ è¯¦ç»†æ“ä½œçš„. é‚£ä¹ˆï¼Œä¸‹æ–‡å°±å¼€å§‹æ“ä½œå§.</p>
<p> <strong>org.apache.ibatis.builder.xml.XMLMapperBuilder#parse</strong></p>
<p>ä¸»è¦æ¥çœ‹è¿™æ®µè§£æçš„ä»£ç  :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public void parse() &#123;</span><br><span class="line">    </span><br><span class="line">&#x2F;&#x2F; åˆ©ç”¨ org.apache.ibatis.session.Configuration çš„ loadedResources</span><br><span class="line">&#x2F;&#x2F; æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯å·²ç»åŠ è½½è¿‡äº†çš„.    </span><br><span class="line">  if (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">    configurationElement(parser.evalNode(&quot;&#x2F;mapper&quot;));</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæ·»åŠ åˆ° loadedResources ä¸­æ¥,ä¹Ÿå°±æ˜¯ç”¨æ¥æ§åˆ¶æ˜¯ä¸æ˜¯å·²ç»è§£æè¿‡äº†çš„.      </span><br><span class="line">    configuration.addLoadedResource(resource);</span><br><span class="line">    bindMapperForNamespace();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¿™ä¸‰ä¸ªæ–¹æ³•ç»™æˆ‘ä¸€ç§å¥½åƒè§£æé‚£ç§æ²¡æœ‰è¿˜æ²¡è§£æå®Œçš„ ? è¿™ä¸ªåœ°æ–¹æœ‰å¾…å®Œå–„.    </span><br><span class="line">  parsePendingResultMaps();</span><br><span class="line">  parsePendingCacheRefs();</span><br><span class="line">  parsePendingStatements();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; configurationElement æ–¹æ³•,</span><br><span class="line">&#x2F;&#x2F; å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä¸­,å¾ˆå¤šæ ‡ç­¾(namespace&#x2F;parameterMa&#x2F;resultMap&#x2F;sql)</span><br><span class="line">&#x2F;&#x2F; è¿˜æœ‰ä¸‹é¢çš„select&#x2F;insert&#x2F;update&#x2F;delete</span><br><span class="line">&#x2F;&#x2F; è¿™äº›ç†Ÿæ‚‰çš„æ ‡ç­¾</span><br><span class="line">  private void configurationElement(XNode context) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      String namespace &#x3D; context.getStringAttribute(&quot;namespace&quot;);</span><br><span class="line">      if (namespace &#x3D;&#x3D; null || namespace.equals(&quot;&quot;)) &#123;</span><br><span class="line">        throw new BuilderException(&quot;Mapper&#39;s namespace cannot be empty&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">&#x2F;&#x2F; å°† namespace èµ‹å€¼è¿›å»,ä¹Ÿå°±æ˜¯å½“å‰æ­£åœ¨è§£æçš„ namespace.        </span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">        </span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæ˜¯å¯¹ç¼“å­˜æ ‡ç­¾è¿›è¡Œè§£æ.        </span><br><span class="line">      cacheRefElement(context.evalNode(&quot;cache-ref&quot;));</span><br><span class="line">      cacheElement(context.evalNode(&quot;cache&quot;));</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; è§£æ parameterMapæ ‡ç­¾        </span><br><span class="line">      parameterMapElement(context.evalNodes(&quot;&#x2F;mapper&#x2F;parameterMap&quot;));</span><br><span class="line">        </span><br><span class="line">&#x2F;&#x2F;         </span><br><span class="line">      resultMapElements(context.evalNodes(&quot;&#x2F;mapper&#x2F;resultMap&quot;));</span><br><span class="line">      sqlElement(context.evalNodes(&quot;&#x2F;mapper&#x2F;sql&quot;));</span><br><span class="line">      buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error parsing Mapper XML. The XML location is &#39;&quot; + resource + &quot;&#39;. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p> <strong>resultMapElements æ–¹æ³• :</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; è¿™é‡Œçš„ list æ˜¯ xml æ–‡ä»¶ä¸­çš„æ‰€æœ‰ &lt;resultMap&gt; æ ‡ç­¾æ–‡ä»¶.</span><br><span class="line">private void resultMapElements(List&lt;XNode&gt; list) &#123;</span><br><span class="line">  for (XNode resultMapNode : list) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">&#x2F;&#x2F;  æœ‰ç‚¹å¥½å¥‡,è¯¥æ–¹æ³•è¿”å›çš„ ResultMap è¿™è¾¹å¥½åƒå¹¶æ²¡æœ‰å‚æ•°,æœ‰ç‚¹å°´å°¬.</span><br><span class="line">&#x2F;&#x2F;  ä¸è¿‡æ˜¯å·²ç»å­˜å‚¨åœ¨ org.apache.ibatis.session.Configuration#resultMaps ä¸­.       </span><br><span class="line">      resultMapElement(resultMapNode);</span><br><span class="line">    &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">      &#x2F;&#x2F; ignore, it will be retried</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">&#x2F;&#x2F; æœ€åè·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•ä¸­æ¥.</span><br><span class="line">  private ResultMap resultMapElement(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings, Class&lt;?&gt; enclosingType) &#123;</span><br><span class="line">    ErrorContext.instance().activity(&quot;processing &quot; + resultMapNode.getValueBasedIdentifier());</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; è·å–å‡º type , è¿™é‡Œæˆ‘ä»¬è·å–å‡ºæ¥çš„ type æ˜¯ TbBlog.    </span><br><span class="line">    String type &#x3D; resultMapNode.getStringAttribute(&quot;type&quot;,</span><br><span class="line">        resultMapNode.getStringAttribute(&quot;ofType&quot;,</span><br><span class="line">            resultMapNode.getStringAttribute(&quot;resultType&quot;,</span><br><span class="line">                resultMapNode.getStringAttribute(&quot;javaType&quot;))));</span><br><span class="line">&#x2F;&#x2F; å…ˆåˆ¤æ–­ org.apache.ibatis.type.TypeAliasRegistry#typeAliases ä¸­æœ‰æ²¡æœ‰,</span><br><span class="line">&#x2F;&#x2F; å¦‚æœæ²¡æœ‰çš„è¯,å°±ä¼šè‡ªå·±newä¸€ä¸ªå‡ºæ¥.    </span><br><span class="line">    Class&lt;?&gt; typeClass &#x3D; resolveClass(type);</span><br><span class="line">    if (typeClass &#x3D;&#x3D; null) &#123;</span><br><span class="line">&#x2F;&#x2F; TODO,å¦‚æœæ²¡æœ‰è¯?        </span><br><span class="line">      typeClass &#x3D; inheritEnclosingType(resultMapNode, enclosingType);</span><br><span class="line">    &#125;</span><br><span class="line">    Discriminator discriminator &#x3D; null;</span><br><span class="line">    List&lt;ResultMapping&gt; resultMappings &#x3D; new ArrayList&lt;&gt;(additionalResultMappings);</span><br><span class="line">    </span><br><span class="line"> &#x2F;&#x2F; è·å–è¯¥ &lt;resultMap&gt; ä¸‹çš„å­æ ‡ç­¾</span><br><span class="line">&#x2F;&#x2F; é‚£ä¹ˆè¿™é‡Œä¹Ÿå°±æ˜¯è·å– &lt;id&gt; å’Œ &lt;result&gt; è¿™äºŒä¸ª.    </span><br><span class="line">    List&lt;XNode&gt; resultChildren &#x3D; resultMapNode.getChildren();</span><br><span class="line">    for (XNode resultChild : resultChildren) &#123;</span><br><span class="line">&#x2F;&#x2F; åˆ†ä¸º constructor &#x2F; discriminator &#x2F; å…¶ä»– è¿™ä¸‰ç±»æƒ…å†µ        </span><br><span class="line">      if (&quot;constructor&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">        processConstructorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">      &#125; else if (&quot;discriminator&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">        discriminator &#x3D; processDiscriminatorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> &#x2F;&#x2F; éå‰äºŒè€…æƒ…å†µ.         </span><br><span class="line">        List&lt;ResultFlag&gt; flags &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        if (&quot;id&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">         &#x2F;&#x2F; å¦‚æœæ ‡ç­¾æ˜¯idçš„è¯,å°±ä¼šç»™flagsæ·»åŠ ResultFlag.ID.</span><br><span class="line">          flags.add(ResultFlag.ID);</span><br><span class="line">        &#125;</span><br><span class="line">  &#x2F;&#x2F;  å°†è¿”å›å›æ¥çš„ ResultMapping æ·»åŠ è¿›æ¥.       </span><br><span class="line">        resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œè·å–çš„æ˜¯ &lt;resultMap&gt; æ ‡ç­¾çš„ id å­—æ®µ.    </span><br><span class="line">    String id &#x3D; resultMapNode.getStringAttribute(&quot;id&quot;,</span><br><span class="line">            resultMapNode.getValueBasedIdentifier());</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œè¿˜å¯ä»¥ä½¿ç”¨ extends å±æ€§, ä¸æ˜¯çœ‹åˆ°è¿™é‡Œ, éƒ½å¥½å¥‡è¿˜æœ‰è¿™ç§æ ‡ç­¾.    </span><br><span class="line">    String extend &#x3D; resultMapNode.getStringAttribute(&quot;extends&quot;);</span><br><span class="line">    Boolean autoMapping &#x3D; resultMapNode.getBooleanAttribute(&quot;autoMapping&quot;);</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œ new äº†ä¸€ä¸ª ResultMapResolver å¯¹è±¡.   </span><br><span class="line">    ResultMapResolver resultMapResolver &#x3D; new ResultMapResolver(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping);</span><br><span class="line">    try &#123;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæœ€åå°±æ˜¯ new äº†ä¸€ä¸ª ResultMap å¯¹è±¡, è¯¥å¯¹è±¡çš„ id æ˜¯ namespace + æ–¹æ³•ID æ‹¼æ¥.</span><br><span class="line">&#x2F;&#x2F; ç„¶åå°†è¯¥å¯¹è±¡ç»™æ·»åŠ åˆ°  org.apache.ibatis.session.Configuration#resultMaps ä¸­æ¥,</span><br><span class="line">&#x2F;&#x2F; key å°±æ˜¯å…¶id, æœ€åå°±æ˜¯æ ¹æ® local &#x2F; global æ¥åˆ†åˆ«è¿›è¡ŒäºŒç§æƒ…å†µæ£€æŸ¥.        </span><br><span class="line">      return resultMapResolver.resolve();</span><br><span class="line">    &#125; catch (IncompleteElementException  e) &#123;</span><br><span class="line">      configuration.addIncompleteResultMap(resultMapResolver);</span><br><span class="line">      throw e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;  buildResultMappingFromContext æ–¹æ³•</span><br><span class="line">&#x2F;&#x2F; è¯¥æ–¹æ³•æ˜¯å¯¹ resultMap ä¸­çš„å­—æ®µè¿›è¡Œè§£æ.</span><br><span class="line">  private ResultMapping buildResultMappingFromContext(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags) &#123;</span><br><span class="line">    String property;</span><br><span class="line">    if (flags.contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">      property &#x3D; context.getStringAttribute(&quot;name&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      property &#x3D; context.getStringAttribute(&quot;property&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    String column &#x3D; context.getStringAttribute(&quot;column&quot;);</span><br><span class="line">    String javaType &#x3D; context.getStringAttribute(&quot;javaType&quot;);</span><br><span class="line">    String jdbcType &#x3D; context.getStringAttribute(&quot;jdbcType&quot;);</span><br><span class="line">    String nestedSelect &#x3D; context.getStringAttribute(&quot;select&quot;);</span><br><span class="line">    String nestedResultMap &#x3D; context.getStringAttribute(&quot;resultMap&quot;, () -&gt;</span><br><span class="line">      processNestedResultMappings(context, Collections.emptyList(), resultType));</span><br><span class="line">    String notNullColumn &#x3D; context.getStringAttribute(&quot;notNullColumn&quot;);</span><br><span class="line">    String columnPrefix &#x3D; context.getStringAttribute(&quot;columnPrefix&quot;);</span><br><span class="line">    String typeHandler &#x3D; context.getStringAttribute(&quot;typeHandler&quot;);</span><br><span class="line">    String resultSet &#x3D; context.getStringAttribute(&quot;resultSet&quot;);</span><br><span class="line">    String foreignColumn &#x3D; context.getStringAttribute(&quot;foreignColumn&quot;);</span><br><span class="line">    boolean lazy &#x3D; &quot;lazy&quot;.equals(context.getStringAttribute(&quot;fetchType&quot;, configuration.isLazyLoadingEnabled() ? &quot;lazy&quot; : &quot;eager&quot;));</span><br><span class="line">      </span><br><span class="line">&#x2F;&#x2F; è·å– javaType , typeHandler , jdbcType ç­‰å¯¹è±¡.      </span><br><span class="line">    Class&lt;?&gt; javaTypeClass &#x3D; resolveClass(javaType);</span><br><span class="line">    Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass &#x3D; resolveClass(typeHandler);</span><br><span class="line">    JdbcType jdbcTypeEnum &#x3D; resolveJdbcType(jdbcType);</span><br><span class="line">&#x2F;&#x2F; org.apache.ibatis.builder.MapperBuilderAssistant#buildResultMapping(java.lang.Class&lt;?&gt;, java.lang.String, java.lang.String, java.lang.Class&lt;?&gt;, org.apache.ibatis.type.JdbcType, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.Class&lt;? extends org.apache.ibatis.type.TypeHandler&lt;?&gt;&gt;, java.util.List&lt;org.apache.ibatis.mapping.ResultFlag&gt;, java.lang.String, java.lang.String, boolean)</span><br><span class="line">&#x2F;&#x2F; å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼ é€’è¿›æ¥çš„å‚æ•°è¿˜æ˜¯å¾ˆå¤šçš„.</span><br><span class="line">&#x2F;&#x2F; æœ€åè¿”å› ResultMapping å¯¹è±¡,ä¹Ÿå°±æ˜¯è¯´è¿™ä¹ˆå¤šå‚æ•°&amp;buildResultMappingæ–¹æ³•ä¸­çš„å‚æ•°,</span><br><span class="line">&#x2F;&#x2F;éƒ½è®¾ç½®åˆ°è¯¥å¯¹è±¡ä¸­æ¥äº†.     </span><br><span class="line">    return builderAssistant.buildResultMapping(resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect, nestedResultMap, notNullColumn, columnPrefix, typeHandlerClass, flags, resultSet, foreignColumn, lazy);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>SqlElement æ–¹æ³•</strong></p>
<p>è¯¥æ–¹æ³•å¯ä»¥å¾ˆæ˜æ˜¾çš„æ„Ÿå—åˆ°æ˜¯å¯¹ æ ‡ç­¾è¿›è¡Œè§£æçš„.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private void sqlElement(List&lt;XNode&gt; list) &#123;</span><br><span class="line"> &#x2F;&#x2F; configuration è·å–å‡ºæ¥ dataBaseIdæ˜¯null,è·³è¿‡æ­¤æ–¹æ³•  </span><br><span class="line">  if (configuration.getDatabaseId() !&#x3D; null) &#123;</span><br><span class="line">    sqlElement(list, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">&#x2F;&#x2F;    </span><br><span class="line">  sqlElement(list, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æœ‰ç‚¹å¥½å¥‡å†™ä»£ç é£æ ¼:  sqlElement(list,configuration.getDatabaseId());</span><br><span class="line">------------------------</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;  sqlElement æ–¹æ³•</span><br><span class="line">  private void sqlElement(List&lt;XNode&gt; list, String requiredDatabaseId) &#123;</span><br><span class="line">    for (XNode context : list) &#123;</span><br><span class="line">        </span><br><span class="line"> &#x2F;&#x2F; è·å– databaseId å’Œ id è¿™äºŒä¸ªå±æ€§çš„å€¼.       </span><br><span class="line">      String databaseId &#x3D; context.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line">      String id &#x3D; context.getStringAttribute(&quot;id&quot;);</span><br><span class="line"> &#x2F;&#x2F;  org.apache.ibatis.builder.MapperBuilderAssistant#applyCurrentNamespace   </span><br><span class="line"> &#x2F;&#x2F; è¯¥æ–¹æ³•æœ€åè¿”å›çš„idçš„å€¼æ˜¯: namespace + id       </span><br><span class="line">      id &#x3D; builderAssistant.applyCurrentNamespace(id, false);</span><br><span class="line">&#x2F;&#x2F;sqlFragments ä¸åŒ…å«è¯¥idå°±è¿”å›true,ä¹Ÿå°±è¯´è¯¥Mapæ˜¯ç¡®å®šæ˜¯å¦å·²ç»è§£æè¿‡äº†çš„.         </span><br><span class="line">      if (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123;</span><br><span class="line">&#x2F;&#x2F; æ·»åŠ åˆ° org.apache.ibatis.builder.xml.XMLMapperBuilder#sqlFragments ä¸­æ¥.          </span><br><span class="line">        sqlFragments.put(id, context);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p> æœ€å è§£æåçš„å€¼,æ˜¯ä½¿ç”¨ namespace + id å­˜æ”¾åœ¨ org.apache.ibatis.builder.xml.XMLMapperBuilder#sqlFragments çš„å±æ€§ä¸­çš„.</p>
<p><strong>buildStatementFromContext() æ–¹æ³• :</strong></p>
<p> è¿™é‡Œæ˜¯å¯¹ select / insert / update / delete æ ‡ç­¾è¿›è¡Œè§£æ.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¯ä»¥çœ‹åˆ° databaseId çš„è·å–ä¸ sql æ ‡ç­¾æ˜¯ä¸€æ ·çš„æ“ä½œ</span><br><span class="line">private void buildStatementFromContext(List&lt;XNode&gt; list) &#123;</span><br><span class="line">  if (configuration.getDatabaseId() !&#x3D; null) &#123;</span><br><span class="line">    buildStatementFromContext(list, configuration.getDatabaseId());</span><br><span class="line">  &#125;</span><br><span class="line">  buildStatementFromContext(list, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•æ¥.</span><br><span class="line">  private void buildStatementFromContext(List&lt;XNode&gt; list, String requiredDatabaseId) &#123;</span><br><span class="line">    for (XNode context : list) &#123;</span><br><span class="line">&#x2F;&#x2F; å…ˆ new äº†ä¸€ä¸ª XMLStatementBuilder å¯¹è±¡, ç´§æ¥ç€å°±è°ƒç”¨è¯¥å¯¹è±¡çš„ è§£æ æ–¹æ³•.        </span><br><span class="line">      final XMLStatementBuilder statementParser &#x3D; new XMLStatementBuilder(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">      try &#123;</span><br><span class="line">        statementParser.parseStatementNode();</span><br><span class="line">      &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteStatement(statementParser);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è§£ææ–¹æ³•</span><br><span class="line">  public void parseStatementNode() &#123;</span><br><span class="line">    String id &#x3D; context.getStringAttribute(&quot;id&quot;);</span><br><span class="line">    String databaseId &#x3D; context.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line">&#x2F;&#x2F; ç”¨ namespace + id ç»„åˆä¸º id</span><br><span class="line">&#x2F;&#x2F; org.apache.ibatis.session.Configuration#mappedStatements</span><br><span class="line">&#x2F;&#x2F; æ¥ç€å°±æ˜¯åˆ¤æ–­åœ¨ mappedStatements ä¸­æ˜¯ä¸æ˜¯æœ‰è¯¥id,å¦‚æœä¸å­˜åœ¨å°±è¿”å›ture,</span><br><span class="line">&#x2F;&#x2F; å­˜åœ¨å°±è¿”å›false,è¿™é‡Œä¹Ÿå°±ä¼šç›´æ¥returnå‡ºå»,ä¹Ÿå°±æ˜¯ä¸ä¼šå¾€åé¢æ‰§è¡Œäº†.      </span><br><span class="line">    if (!databaseIdMatchesCurrent(id, databaseId, this.requiredDatabaseId)) &#123;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; è·å–æ ‡ç­¾åå­—,  select &#x2F; insert&#x2F; update &#x2F;delete.</span><br><span class="line">    String nodeName &#x3D; context.getNode().getNodeName();</span><br><span class="line">&#x2F;&#x2F; è½¬åŒ–ä¸ºå¤§å†™çš„ SELECT      </span><br><span class="line">    SqlCommandType sqlCommandType &#x3D; SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    boolean isSelect &#x3D; sqlCommandType &#x3D;&#x3D; SqlCommandType.SELECT;</span><br><span class="line">&#x2F;&#x2F; æ˜¯å¦åˆ·æ–° cache,ä¹Ÿå°±æ˜¯selectæ˜¯ä¸åˆ·æ–°çš„,é‚£ä¹ˆå…¶ä»–çš„å°±åº”è¯¥æ˜¯è¦åˆ·æ–°çš„.      </span><br><span class="line">    boolean flushCache &#x3D; context.getBooleanAttribute(&quot;flushCache&quot;, !isSelect);</span><br><span class="line">&#x2F;&#x2F; ä½¿ç”¨ä½¿ç”¨ cache,è¿™é‡Œåº”è¯¥æ˜¯ä¸€çº§ç¼“å­˜ï¼Œé»˜è®¤å¼€å¯çš„.      </span><br><span class="line">    boolean useCache &#x3D; context.getBooleanAttribute(&quot;useCache&quot;, isSelect);</span><br><span class="line">&#x2F;&#x2F; ç»“æœæ’åº, å¦‚æœæ²¡æœ‰é…ç½®çš„è¯,é»˜è®¤å°±æ˜¯false.      </span><br><span class="line">    boolean resultOrdered &#x3D; context.getBooleanAttribute(&quot;resultOrdered&quot;, false);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Include Fragments before parsing</span><br><span class="line">&#x2F;&#x2F; åˆ›å»ºäº†ä¸€ä¸ª XMLIncludeTransformer å¯¹è±¡,è¯¥å¯¹è±¡åº”è¯¥æ˜¯è¿›è¡Œè½¬åŒ–çš„.      </span><br><span class="line">    XMLIncludeTransformer includeParser &#x3D; new XMLIncludeTransformer(configuration, builderAssistant);</span><br><span class="line"> &#x2F;&#x2F;  TODO ? è¯¥æ–¹æ³•æœ‰å¾…æ›´æ–°     </span><br><span class="line">    includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è·å– parameterType å±æ€§,å¦‚æœæœ‰çš„è¯,ä¹Ÿä¼šè·å–å‡ºè¯¥å±æ€§å¯¹åº”çš„ Class.    </span><br><span class="line">    String parameterType &#x3D; context.getStringAttribute(&quot;parameterType&quot;);</span><br><span class="line">    Class&lt;?&gt; parameterTypeClass &#x3D; resolveClass(parameterType);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; lang : null,è¿™é‡Œæ˜¯æ²¡æœ‰è®¾ç½®çš„.      </span><br><span class="line">    String lang &#x3D; context.getStringAttribute(&quot;lang&quot;);</span><br><span class="line">    LanguageDriver langDriver &#x3D; getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Parse selectKey after includes and remove them.</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œå¯¹æ˜¯å¦æœ‰ selectKey è¿›è¡Œå¤„ç†.æˆ‘ä»¬è¿™é‡Œç›®å‰æ²¡æœ‰ä½¿ç”¨ selectKey</span><br><span class="line">    processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span><br><span class="line">    KeyGenerator keyGenerator;</span><br><span class="line"> &#x2F;&#x2F; selectBlog!selectKey     </span><br><span class="line">    String keyStatementId &#x3D; id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæ‹¼æ¥ä¸Š namespace :  com.iyang.mybatis.mapper.BlogMapper.selectBlog!selectKey      </span><br><span class="line">    keyStatementId &#x3D; builderAssistant.applyCurrentNamespace(keyStatementId, true);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæ˜¯åˆ¤æ–­æ˜¯å¦æœ‰ ä¸»é”®è‡ªåŠ¨ç”Ÿæˆ. è¿™é‡Œæ˜¯æŸ¥è¯¢è¯­å¥,åº”è¯¥æ˜¯æ²¡æœ‰çš„. </span><br><span class="line">    if (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">      keyGenerator &#x3D; configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      keyGenerator &#x3D; context.getBooleanAttribute(&quot;useGeneratedKeys&quot;,</span><br><span class="line">          configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">          ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; åˆ›å»ºä¸€ä¸ª XMLScriptBuilder å¯¹è±¡,ä½¿ç”¨è¯¥å¯¹è±¡çš„parseScriptNodeæ–¹æ³•æ¥è§£æ</span><br><span class="line">&#x2F;&#x2F; org.apache.ibatis.scripting.xmltags.XMLScriptBuilder#parseScriptNode</span><br><span class="line">&#x2F;&#x2F; è·å–å‡ºsql, æœ‰ä¸ª isDynamic å‚æ•°,æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯åŠ¨æ€sqlè¯­å¥.</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œä¸æ˜¯åŠ¨æ€sql,æœ€ånewäº†ä¸€ä¸ªRawSqlSource.</span><br><span class="line">&#x2F;&#x2F; org.apache.ibatis.builder.SqlSourceBuilder#parse,æˆ‘ä»¬çš„#&#123;id&#125; æ›¿æ¢æˆ ? å°±æ˜¯åœ¨</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œè¿›è¡Œæ›¿æ¢çš„.</span><br><span class="line">&#x2F;&#x2F; å¦‚æœæ˜¯åŠ¨æ€ sql çš„è¯,å°±ä¼šåˆ›å»ºå‡º DynamicSqlSource è¯¥å¯¹è±¡æ¥.</span><br><span class="line">&#x2F;&#x2F; å¯ä»¥çœ‹åˆ° SqlSource ä¸‹é¢æ˜¯æœ‰ å››ä¸ªå®ç°ç±»çš„.</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œè¿”å›çš„ SqlSourceé‡Œé¢æœ‰sqlè¯­å¥çš„,å’Œè¿”å›ç±»å‹çš„.      </span><br><span class="line">    SqlSource sqlSource &#x3D; langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; è·å–å±æ€§.      </span><br><span class="line">    StatementType statementType &#x3D; StatementType.valueOf(context.getStringAttribute(&quot;statementType&quot;, StatementType.PREPARED.toString()));</span><br><span class="line">    Integer fetchSize &#x3D; context.getIntAttribute(&quot;fetchSize&quot;);</span><br><span class="line">    Integer timeout &#x3D; context.getIntAttribute(&quot;timeout&quot;);</span><br><span class="line">    String parameterMap &#x3D; context.getStringAttribute(&quot;parameterMap&quot;);</span><br><span class="line">&#x2F;&#x2F; è·å–è¿”å›ç±»å‹. è·å–å‡ºæ¥çš„ resultTypeClass æ˜¯ class com.iyang.mybatis.pojo.TbBlog      </span><br><span class="line">    String resultType &#x3D; context.getStringAttribute(&quot;resultType&quot;);</span><br><span class="line">    Class&lt;?&gt; resultTypeClass &#x3D; resolveClass(resultType);</span><br><span class="line">    String resultMap &#x3D; context.getStringAttribute(&quot;resultMap&quot;);      </span><br><span class="line">    String resultSetType &#x3D; context.getStringAttribute(&quot;resultSetType&quot;);</span><br><span class="line">    ResultSetType resultSetTypeEnum &#x3D; resolveResultSetType(resultSetType);</span><br><span class="line">    if (resultSetTypeEnum &#x3D;&#x3D; null) &#123;</span><br><span class="line">      resultSetTypeEnum &#x3D; configuration.getDefaultResultSetType();</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; è·å–å±æ€§çš„å€¼      </span><br><span class="line">    String keyProperty &#x3D; context.getStringAttribute(&quot;keyProperty&quot;);</span><br><span class="line">    String keyColumn &#x3D; context.getStringAttribute(&quot;keyColumn&quot;);</span><br><span class="line">    String resultSets &#x3D; context.getStringAttribute(&quot;resultSets&quot;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; åˆ›å»ºä¸€ä¸ª MappedStatement.Builder å¯¹è±¡å‡ºæ¥.</span><br><span class="line">&#x2F;&#x2F; å†é€šè¿‡ builder æ„å»ºå‡ºä¸€ä¸ª MappedStatement å¯¹è±¡æ¥.</span><br><span class="line">&#x2F;&#x2F; æœ€åæ”¾å…¥åˆ° org.apache.ibatis.session.Configuration#mappedStatements ä¸­æ¥.      </span><br><span class="line">    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">        resultSetTypeEnum, flushCache, useCache, resultOrdered,</span><br><span class="line">        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private void processSelectKeyNodes(String id, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver) &#123;</span><br><span class="line">    List&lt;XNode&gt; selectKeyNodes &#x3D; context.evalNodes(&quot;selectKey&quot;);</span><br><span class="line">    if (configuration.getDatabaseId() !&#x3D; null) &#123;</span><br><span class="line">      parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());</span><br><span class="line">    &#125;</span><br><span class="line">    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, null);</span><br><span class="line">    removeSelectKeyNodes(selectKeyNodes);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p> æ€»ç»“ä¸‹ MyBatis è§£æ Mapperçš„xml æ–‡ä»¶æµç¨‹ã€‚ å¯ä»¥æ„Ÿå—åˆ°,å¯¹äºMybatiså¤„ç†Mapper,å¯¹å…¶å­—æ®µå±æ€§éƒ½æ˜¯æŒ¨ä¸ªè§£æçš„,è¿˜æ˜¯ä¸‹äº†å¾ˆå¤§çš„åŠŸå¤«.</p>
<p> å…ˆæ˜¯æœ‰ä¸€ä¸ªé›†åˆæ¥æ§åˆ¶æ˜¯å¦å·²ç»è§£æè¿‡äº†,ç®—æ˜¯ä¸€ç§æ˜¯å¦è§£æçš„å¼€å…³é…ç½®. å¯ä»¥çœ‹åˆ°å…¶å…ˆåçš„è§£æé¡ºåº,</p>
<p>namespace â€“&gt; cache-ref â€“&gt; cache â€”&gt; mapper/parameterMap â€”&gt; mapper/resultMap â€”&gt; mapper/sql â€”&gt; select/insert/update/detele.</p>
<p> å½“è§£æè¿™äº›æ ‡ç­¾çš„æ—¶å€™, åˆä¼šå¯¹æ ‡ç­¾é‡Œé¢çš„å±æ€§è¿›è¡Œè§£æ. è¿™é‡Œ,ä¸»è¦çœ‹ä¸‹æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨åˆ°æœ€å¤šçš„æ ‡ç­¾, MyBatis å¯¹è¿™äº›æ ‡ç­¾è§£æäº†å,å…¶åæœ‰æ˜¯æ€ä¹ˆåˆ©ç”¨çš„å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°ç›®å‰MyBatisæ˜¯å­˜æ”¾åœ¨ä¸€äº›configurationç­‰ç±»ä¿¡æ¯é‡Œé¢,é‚£ä¹ˆç­‰åˆ°çœŸæ­£å»æŸ¥è¯¢sqlè¯­å¥çš„æ—¶å€™, MyBatis åˆæ˜¯æ€ä¹ˆç”¨ä¸Šçš„å‘¢ï¼Ÿ è¿™é‡Œç›®å‰åªè®²äº†å¦‚ä½•è§£æ.</p>
<p> è§£æå®Œäº†ï¼Œæ²¡å¼‚å¸¸ï¼Œé‚£å°±æ˜¯è§£æéƒ½okäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯çœ‹å½“ MyBatis å»æŸ¥è¯¢çš„æ—¶å€™, æ˜¯æ€ä¹ˆåˆ©ç”¨ä¸Šè¿™äº›èµ„æºçš„å‘¢ï¼Ÿæ‰€ä»¥çœ‹æ¥ä¸‹æ¥çš„æ›´æ–°.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lwfby.cn/2020/12/25/mybatis/mybatis-config-xml-read/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YangL">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YangL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/25/mybatis/mybatis-config-xml-read/" itemprop="url">mybatis-config-xml-read</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-12-25T00:35:10+08:00">
                2020-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MyBatis/" itemprop="url" rel="index">
                    <span itemprop="name">MyBatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  4.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  20
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p> å¯¹äºé…ç½®æ–‡ä»¶çš„è§£æ, è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¥½ç†è§£çš„, å°±æ˜¯è¯»å–é…ç½®æ–‡ä»¶, ç„¶ååœ¨ä»£ç éœ€è¦çš„åœ°æ–¹ç»™ä½¿ç”¨åˆ°.</p>
<p> è¿™é‡Œ,å¯ä»¥æ‰©å±•ä¸‹, Spring / SpringBoot ç­‰æ˜¯æ€ä¹ˆè¯»å–é…ç½®æ–‡ä»¶å‘¢ ? å¹¶ä¸”é…ç½®æ–‡ä»¶è¿˜æ˜¯æœ‰ xml / properties/yaml ç­‰æ ¼å¼çš„ ï¼Œ å…¶è¯»å–ä»£ç æ˜¯æ€ä¹ˆå†™çš„ ? ç„¶ååŸºäº é˜¿æ³¢ç½—(æºç¨‹å¼€æº) çš„é…ç½®ä¸­å¿ƒ , å…¶å®ç°é…ç½®åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ ? ç„¶åè¿™é‡Œï¼Œçœ‹äº† Mybatis è¯»å–é…ç½®æ–‡ä»¶, åç»­å†å‡º Spring é…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœäºŒè€…è¯»å–é…ç½®è¿›è¡Œå¯¹æ¯”, ä½ ä¸ªäººæ›´å€¾å‘ä½¿ç”¨ä»£ç å‘¢ ?</p>
<p> æ‰€ä»¥,è¿™é‡Œå°±å¼€å¯è¯»å– Mybatis æ˜¯å¦‚ä½•è§£æé…ç½®æ–‡ä»¶çš„æ“ä½œ.</p>
<h4 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h4><p> è¿™é‡Œçš„é…ç½®æ–‡ä»¶è§£è¯»,æ˜¯æ ¹æ® MyBatiså®˜ç½‘æ¥ä¸€æ­¥ä¸€æ­¥çš„è§£æé˜…è¯». å¦‚æœæœ‰å®˜ç½‘æ²¡æœ‰æ¶‰åŠåˆ°çš„,å‘ç°äº†ä¹Ÿä¼šåœ¨åç»­åŠ ä¸Šå»çš„. è§£æå¤šè¡Œä»£ç , æ‰èƒ½ç†è§£ ä½•ä¸ºä¼˜ç§€.</p>
<p> <strong>æ ‡ç­¾ä¸€ : properties</strong></p>
<p> org.apache.ibatis.builder.xml.XMLConfigBuilder#parseConfiguration â€”&gt; propertiesElement(root.evalNode(â€œpropertiesâ€)) æ–¹æ³•ä¸­æ¥.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; è¿™é‡Œä¼ å…¥è¿›æ¥çš„ XNode çš„å€¼,å°±æ˜¯æˆ‘ä»¬å†™çš„ properties æ ‡ç­¾.</span><br><span class="line">&#x2F;&#x2F; å¯ä»¥çœ‹åˆ° XNodeçš„å±æ€§,nameæ ‡ç­¾çš„åå­—,attributeså°±æ˜¯key&#x2F;valueå±æ€§</span><br><span class="line">&#x2F;&#x2F; æ¯”å¦‚è¿™é‡Œ: key å°±æ˜¯ resource , value å°±æ˜¯ .&#x2F;db.properties.</span><br><span class="line">private void propertiesElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context !&#x3D; null) &#123;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œè°ƒç”¨çš„node.getChildNodes(),å¦‚æœæœ‰ç‚¹è¯,ä¼šéå†æŒ¨ä¸ªè§£æ,æœ€åå°è£…æˆä¸ºkey&#x2F;valueç»“æ„.      </span><br><span class="line">    Properties defaults &#x3D; context.getChildrenAsProperties();</span><br><span class="line">&#x2F;&#x2F; è·å– resource &#x2F; url äºŒè€…çš„å€¼.      </span><br><span class="line">    String resource &#x3D; context.getStringAttribute(&quot;resource&quot;);</span><br><span class="line">    String url &#x3D; context.getStringAttribute(&quot;url&quot;);</span><br><span class="line">&#x2F;&#x2F; å¦‚æœäºŒè€…éƒ½æ˜¯null,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.      </span><br><span class="line">    if (resource !&#x3D; null &amp;&amp; url !&#x3D; null) &#123;</span><br><span class="line">      throw new BuilderException(&quot;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line"> &#x2F;&#x2F; è¿™é‡Œå…ˆå¤„ç†resource,å†å¤„ç†url,ä¹Ÿå°±æ˜¯æœ‰å¯èƒ½urlä¼šè¦†ç›–æ‰resourceçš„å†…å®¹.</span><br><span class="line"> &#x2F;&#x2F; äºŒè€…è¯»å–çš„æ–¹å¼ä¸ä¸€æ ·,å‰è€…æ˜¯æ ¹æ® resourceå¼€å§‹è¯»,urlæ˜¯æ ¹æ®ç»å¯¹è·¯å¾„å¼€å§‹è¯».</span><br><span class="line"> &#x2F;&#x2F; æœ€å defaults é‡Œé¢æ”¾å…¥çš„å…¨éƒ¨æ˜¯ key&#x2F;value å¯¹åº”çš„é”®å€¼å¯¹</span><br><span class="line"> &#x2F;&#x2F; ä¹Ÿå°±æ˜¯db.propertiesä¸­çš„ key &#x2F; value ç›¸å¯¹åº”ièµ·æ¥.     </span><br><span class="line">    if (resource !&#x3D; null) &#123;</span><br><span class="line">      defaults.putAll(Resources.getResourceAsProperties(resource));</span><br><span class="line">    &#125; else if (url !&#x3D; null) &#123;</span><br><span class="line">      defaults.putAll(Resources.getUrlAsProperties(url));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œçœ‹çš„æ˜¯ xml é‡Œé¢æ˜¯ä¸æ˜¯ç›´æ¥æœ‰ porperties é…ç½®.     </span><br><span class="line">&#x2F;&#x2F; å¦‚æœæœ‰çš„è¯,å°±ä¼šputAllè¿›å».      </span><br><span class="line">    Properties vars &#x3D; configuration.getVariables();</span><br><span class="line">    if (vars !&#x3D; null) &#123;</span><br><span class="line">      defaults.putAll(vars);</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; æœ€åå§ defaults,ä¹Ÿå°±æ˜¯propertiesç»™æ”¾å…¥åˆ° BaseBuilder å’Œ Confifurationä¸­å».      </span><br><span class="line">    parser.setVariables(defaults);</span><br><span class="line">    configuration.setVariables(defaults);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------</span><br><span class="line">&#x2F;&#x2F;  å¦‚ä½•è®© Properties vars &#x3D; configuration.getVariables(); æœ‰å€¼å‘¢ ?</span><br><span class="line">&#x2F;&#x2F;  å¦‚æœåªæ˜¯å•ä¸ªçš„ MyBatis é¡¹ç›®çš„è¯, å°±è‡ªå·±æ‰‹åŠ¨newä¸€ä¸ªpropertieså¯¹è±¡</span><br><span class="line">&#x2F;&#x2F;  ç„¶åkeyè¾“å…¥è‡ªå·±è¦è¦†ç›–æ‰çš„keyå°±å¯ä»¥äº†</span><br><span class="line">        Properties dbConfigProperties &#x3D; new Properties();</span><br><span class="line">        dbConfigProperties.setProperty(&quot;jdbc.password&quot;,&quot;GavinYang&quot;);</span><br><span class="line"></span><br><span class="line">        SqlSessionFactory sqlSessionFactory &#x3D; new SqlSessionFactoryBuilder().build(mybatisInputStream,dbConfigProperties);</span><br></pre></td></tr></table></figure>

<p> <strong>æ ‡ç­¾äºŒ : settings</strong></p>
<p> è¿™æ˜¯ MyBatiså¯¹ settings çš„æ“ä½œ.</p>
<p> å…·ä½“çš„ settings ä¸­æ¯é¡¹é…ç½®å‚è€ƒå®˜ç½‘é“¾æ¥ : <a href="https://mybatis.org/mybatis-3/configuration.html#properties" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/configuration.html#properties</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; è§£æ setting ---&gt; è½¬åŒ–ä¸º key &#x2F;value</span><br><span class="line">Properties settings &#x3D; settingsAsProperties(root.evalNode(&quot;settings&quot;));</span><br><span class="line">&#x2F;&#x2F; </span><br><span class="line">loadCustomVfs(settings);</span><br><span class="line">loadCustomLogImpl(settings);</span><br></pre></td></tr></table></figure>

<p>settingsAsProperties æ–¹æ³•</p>
<p> å¯ä»¥çœ‹åˆ°, è¯¥æ–¹æ³•å°±æ˜¯è¿›è¡ŒåŠ è½½,è½¬åŒ–ä¸ºkey/valueé”®å€¼å¯¹ç±»å‹, ç„¶åå¯¹å…¶keyæ£€éªŒæ˜¯å¦åœ¨</p>
<p> Configuration ä¸­éƒ½æœ‰ set æ–¹æ³•.</p>
<p>Notes : ä¸ºäº†éªŒè¯ä¸‹, æˆ‘ä»¬åŠ ä¸Šä¸€ä¸ªæ²¡æœ‰çš„æ ‡ç­¾, å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„å¼‚å¸¸. æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°è¿™ç§å¼‚å¸¸çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥å»æ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯åå­—ä»€ä¹ˆæœ‰é—®é¢˜.</p>
<h3 id="Cause-org-apache-ibatis-builder-BuilderException-Error-parsing-SQL-Mapper-Configuration-Cause-org-apache-ibatis-builder-BuilderException-The-setting-nnnnn-is-not-known-Make-sure-you-spelled-it-correctly-case-sensitive"><a href="#Cause-org-apache-ibatis-builder-BuilderException-Error-parsing-SQL-Mapper-Configuration-Cause-org-apache-ibatis-builder-BuilderException-The-setting-nnnnn-is-not-known-Make-sure-you-spelled-it-correctly-case-sensitive" class="headerlink" title="Cause: org.apache.ibatis.builder.BuilderException: Error parsing SQL Mapper Configuration. Cause: org.apache.ibatis.builder.BuilderException: The setting nnnnn is not known. Make sure you spelled it correctly (case sensitive)."></a>Cause: org.apache.ibatis.builder.BuilderException: Error parsing SQL Mapper Configuration. Cause: org.apache.ibatis.builder.BuilderException: The setting nnnnn is not known. Make sure you spelled it correctly (case sensitive).</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private Properties settingsAsProperties(XNode context) &#123;</span><br><span class="line">  if (context &#x3D;&#x3D; null) &#123;</span><br><span class="line">    return new Properties();</span><br><span class="line">  &#125;</span><br><span class="line"> &#x2F;&#x2F; å¯¹ settings ä¸‹çš„ setting è¿›è¡Œè§£æ å¹¶ä¸” è½¬åŒ–ä¸º key &#x2F; value æ“ä½œ.   </span><br><span class="line">  Properties props &#x3D; context.getChildrenAsProperties();</span><br><span class="line">  &#x2F;&#x2F; Check that all settings are known to the configuration class</span><br><span class="line"> &#x2F;&#x2F; å¯¹ Configuration è¿›è¡Œæ ¡éªŒ, ç¡®è®¤ä¸Šé¢çš„ props ä¸­çš„key åœ¨ Configuration</span><br><span class="line">&#x2F;&#x2F; ä¸­æ˜¯éƒ½æœ‰set æ–¹æ³•çš„,ç›®æµ‹æ˜¯åé¢åå°„éœ€è¦ä½¿ç”¨åˆ°.    </span><br><span class="line">  MetaClass metaConfig &#x3D; MetaClass.forClass(Configuration.class, localReflectorFactory);</span><br><span class="line">  for (Object key : props.keySet()) &#123;</span><br><span class="line">    if (!metaConfig.hasSetter(String.valueOf(key))) &#123;</span><br><span class="line">      throw new BuilderException(&quot;The setting &quot; + key + &quot; is not known.  Make sure you spelled it correctly (case sensitive).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>loadCustomVfs(settings) æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•,ä¸»è¦å°±æ˜¯è¯»å– vfsImpl å¯¹ç”¨çš„value,åˆ‡å‰²ä¸‹,ç„¶åç”¨ classForName æ¥è·å– class,</p>
<p>æœ€åèµ‹å€¼åˆ° configuration ä¸­å». è¿™é‡Œç®—æ˜¯å¯¹ vfs çš„ä¸€ç§è‡ªå®šä¹‰çš„æ‰©å±•,è™½ç„¶ç›®å‰è¿˜ä¸å¤ªæ¸…æ¥švfså…·ä½“ä½œç”¨.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private void loadCustomVfs(Properties props) throws ClassNotFoundException &#123;</span><br><span class="line">  &#x2F;&#x2F; è·å– vfsImpl çš„ value.  </span><br><span class="line">  String value &#x3D; props.getProperty(&quot;vfsImpl&quot;);</span><br><span class="line">  if (value !&#x3D; null) &#123;</span><br><span class="line">   &#x2F;&#x2F; æ ¹æ® , è¿›è¡Œåˆ‡å‰².   </span><br><span class="line">    String[] clazzes &#x3D; value.split(&quot;,&quot;);</span><br><span class="line">    for (String clazz : clazzes) &#123;</span><br><span class="line">      if (!clazz.isEmpty()) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        &#x2F;&#x2F; åå°„,è·å–å‡º Class , æœ€åèµ‹å€¼åˆ° configuration ä¸­å».  </span><br><span class="line">        Class&lt;? extends VFS&gt; vfsImpl &#x3D; (Class&lt;? extends VFS&gt;)Resources.classForName(clazz);</span><br><span class="line">        configuration.setVfsImpl(vfsImpl);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>loadCustomLogImpl(settings) æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">private void loadCustomLogImpl(Properties props) &#123;</span><br><span class="line">  Class&lt;? extends Log&gt; logImpl &#x3D; resolveClass(props.getProperty(&quot;logImpl&quot;));</span><br><span class="line">  &#x2F;&#x2F; å°† log set åˆ° configuration ä¸­å».  </span><br><span class="line">  configuration.setLogImpl(logImpl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line">&#x2F;&#x2F; resolve æœ€åå¦‚æœä¸æ˜¯ null çš„è¯,</span><br><span class="line">org.apache.ibatis.type.TypeAliasRegistry#resolveAlias</span><br><span class="line"></span><br><span class="line"> &#x2F;&#x2F; å°±ä¼šèµ°åˆ°è¿™é‡Œ,è¿™é‡Œå¯ä»¥çœ‹å…ˆæ˜¯åœ¨ typeAliases(HashMap) ä¸­åˆ¤æ–­ä¸‹,å¦‚æœå­˜åœ¨å°±ç›´æ¥è·å–</span><br><span class="line">&#x2F;&#x2F; å¦‚æœä¸å­˜åœ¨å°±ç”¨ Resources.ClassForNameæ¥æ“ä½œ</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œçš„ HashMapå°±ç±»ä¼¼äº,è®°å½•ä¹‹å‰æ˜¯å¦å·²ç»åŠ è½½äº†æˆ–è€…é¢„çƒ­.</span><br><span class="line">&#x2F;&#x2F; å¦‚æœæ˜¯ç”¨æ¥åšcacheçš„è¯, é‚£å°±åº”è¯¥æœ€åä¼šåœ¨ return ä¹‹å‰ç»§ç»­æŠŠå€¼ç»™æ”¾å…¥è¿›å».    </span><br><span class="line">  public &lt;T&gt; Class&lt;T&gt; resolveAlias(String string) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      if (string &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; issue #748</span><br><span class="line">      String key &#x3D; string.toLowerCase(Locale.ENGLISH);</span><br><span class="line">      Class&lt;T&gt; value;</span><br><span class="line">      if (typeAliases.containsKey(key)) &#123;</span><br><span class="line">        value &#x3D; (Class&lt;T&gt;) typeAliases.get(key);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        value &#x3D; (Class&lt;T&gt;) Resources.classForName(string);</span><br><span class="line">      &#125;</span><br><span class="line">      return value;</span><br><span class="line">    &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">      throw new TypeException(&quot;Could not resolve type alias &#39;&quot; + string + &quot;&#39;.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------</span><br><span class="line">&#x2F;&#x2F; å¦‚æœæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰å®šä¹‰çš„è¯,è¿™é‡Œé»˜è®¤æ˜¯null,ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šsetè¿›å».    </span><br><span class="line">  public void setLogImpl(Class&lt;? extends Log&gt; logImpl) &#123;</span><br><span class="line">    if (logImpl !&#x3D; null) &#123;</span><br><span class="line">      this.logImpl &#x3D; logImpl;</span><br><span class="line">      LogFactory.useCustomLogging(this.logImpl);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ‡ç­¾ä¸‰ :</strong></p>
<p> å…³äºåˆ«åçš„é…ç½®.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</span><br><span class="line">private void typeAliasesElement(XNode parent) &#123;</span><br><span class="line">  if (parent !&#x3D; null) &#123;</span><br><span class="line">   &#x2F;&#x2F; å¯¹ typeAliases ä¸‹çš„å­æ ‡ç­¾è¿›è¡Œè¿­ä»£.</span><br><span class="line">   &#x2F;&#x2F; åˆ†ä¸ºæ˜¯ package å’Œé package   </span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">      if (&quot;package&quot;.equals(child.getName())) &#123;</span><br><span class="line">       &#x2F;&#x2F; è·å–ä½ è¾“å…¥çš„åŒ…   </span><br><span class="line">        String typeAliasPackage &#x3D; child.getStringAttribute(&quot;name&quot;);</span><br><span class="line">        configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> &#x2F;&#x2F; &lt;typeAlias type&#x3D;&quot;com.iyang.mybatis.pojo.TbBlog&quot; alias&#x3D;&quot;TbBlog&quot; &#x2F;&gt;</span><br><span class="line"> &#x2F;&#x2F; è¿™é‡Œå°±æ˜¯å¯¹è¿™ç§è¿›è¡Œè§£æçš„         </span><br><span class="line">        String alias &#x3D; child.getStringAttribute(&quot;alias&quot;);</span><br><span class="line">        String type &#x3D; child.getStringAttribute(&quot;type&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">          Class&lt;?&gt; clazz &#x3D; Resources.classForName(type);</span><br><span class="line">   &#x2F;&#x2F; å¦‚æœæ²¡å†™åˆ«å,å°±åªä¼ å…¥ clazz.         </span><br><span class="line">          if (alias &#x3D;&#x3D; null) &#123;</span><br><span class="line">            typeAliasRegistry.registerAlias(clazz);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">   &#x2F;&#x2F; å†™äº†åˆ«å,å°±åˆ«åå’Œclazzä¸€èµ·ä¼ å…¥è¿›æ¥.           </span><br><span class="line">            typeAliasRegistry.registerAlias(alias, clazz);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">          throw new BuilderException(&quot;Error registering typeAlias for &#39;&quot; + alias + &quot;&#39;. Cause: &quot; + e, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯æ ¹æ® packageName æ¥ registerè¿›æ¥çš„.    </span><br><span class="line">  public void registerAliases(String packageName, Class&lt;?&gt; superType) &#123;</span><br><span class="line">    &#x2F;&#x2F; new ä¸€ä¸ªè§£æå™¨å·¥å…·ç±»</span><br><span class="line">    ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil &#x3D; new ResolverUtil&lt;&gt;();</span><br><span class="line">    &#x2F;&#x2F; è·å–åŒ…çš„path,ç„¶åè·å–è¯¥åŒ…ä¸‹çš„æ–‡ä»¶,å¦‚æœæ–‡ä»¶æ˜¯.classç»“å°¾çš„è¯</span><br><span class="line">    &#x2F;&#x2F; æœ€ååœ¨ ResolverUtil ä¸­matchessæ˜¯æœ‰è¯¥åŒ…ä¸‹çš„å…¨åç§°.</span><br><span class="line">    resolverUtil.find(new ResolverUtil.IsA(superType), packageName);</span><br><span class="line">    &#x2F;&#x2F; è¿™é‡Œè¿”å›çš„æ˜¯ä¸Šä¸€æ­¥è¯´çš„ matches</span><br><span class="line">    Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; typeSet &#x3D; resolverUtil.getClasses();</span><br><span class="line">    for (Class&lt;?&gt; type : typeSet) &#123;</span><br><span class="line">      &#x2F;&#x2F; Ignore inner classes and interfaces (including package-info.java)</span><br><span class="line">      &#x2F;&#x2F; Skip also inner classes. See issue #6</span><br><span class="line">      &#x2F;&#x2F; å¦‚æœä¸æ˜¯æ¥å£,ä¸æ˜¯å†…éƒ¨ç±»ç­‰æ¡ä»¶çš„è¯,å°±èµ°  registerAlias æ–¹æ³•</span><br><span class="line">      if (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !type.isMemberClass()) &#123;</span><br><span class="line"> &#x2F;&#x2F; å…ˆè·å–ç±»åå­—,åˆ¤æ–­è¯¥ç±»ä¸Šæœ‰æ²¡æœ‰ @Alias æ³¨è§£,å¦‚æœæœ‰æ³¨è§£çš„è¯,å°±ç”¨æ³¨è§£çš„å€¼ä½œä¸ºç¼©å†™çš„.</span><br><span class="line"> &#x2F;&#x2F; æœ€ååˆ¤æ–­æ˜¯ä¸æ˜¯null,æ˜¯nullå°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.æœ€åå°†ä¸Šé¢è·å–å‡ºæ¥çš„ç¼©å†™åå­—,è½¬åŒ–ä¸ºå¤§å†™.</span><br><span class="line"> &#x2F;&#x2F; å¦‚æœæ­¤æ—¶ typeAliases æ˜¯å·²ç»æœ‰äº†è¯¥å€¼çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.å¦åˆ™å°±æ”¾å…¥åˆ°typeAliasesæ¥</span><br><span class="line"> &#x2F;&#x2F; private final Map&lt;String, Class&lt;?&gt;&gt; typeAliases &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"> &#x2F;&#x2F; å¯ä»¥çœ‹åˆ° typeAliases æ˜¯ä¸€ä¸ªHashMap,å¹¶ä¸”å…¶å­˜å‚¨çš„Key&#x2F;Valueè¿˜æ˜¯è›®æ˜æ˜¾çš„.         </span><br><span class="line">        registerAlias(type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ‡ç­¾å››</strong></p>
<p> æ‰©å±•çš„ demo å¯ä»¥å‚è€ƒ MyBatiså®˜ç½‘ : <a href="https://mybatis.org/mybatis-3/configuration.html" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/configuration.html</a></p>
<p> ç„¶åçœ‹ MyBatis æ˜¯å¦‚ä½•å°†æ’ä»¶ç»™åˆ©ç”¨ä¸Šçš„å‘¢ ?</p>
<p> é¦–å…ˆåœ¨ mybatis-config.xml ä¸­é…ç½®å¥½æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ plugin</p>
<p> è¿™é‡Œä»¥æˆ‘é…ç½®äº†äºŒä¸ªæ’ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;</span><br><span class="line">    &lt;plugin interceptor&#x3D;&quot;com.iyang.mybatis.plugins.ExamplePlugin&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;name&quot; value&#x3D;&quot;GavinYang&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;age&quot; value&#x3D;&quot;22&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;hobby&quot; value&#x3D;&quot;lwf&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;plugin&gt;</span><br><span class="line"></span><br><span class="line">    &lt;plugin interceptor&#x3D;&quot;com.iyang.mybatis.plugins.QuerySqlPlugin&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property name&#x3D;&quot;name&quot; value&#x3D;&quot;GavinYang&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;plugin&gt;</span><br><span class="line">&lt;&#x2F;plugins&gt;</span><br></pre></td></tr></table></figure>

<p>// å¤„ç† plugin çš„ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void pluginElement(XNode parent) throws Exception &#123;</span><br><span class="line">  &#x2F;&#x2F; è¿™é‡Œä¼ å…¥è¿›æ¥çš„å°±æ˜¯ &lt;plugins&gt;æ•´ä¸ªæ ‡ç­¾å†…å®¹.  </span><br><span class="line">  if (parent !&#x3D; null) &#123;</span><br><span class="line">   &#x2F;&#x2F; è·å– &lt;plugins&gt; ä¸‹çš„ &lt;plugin&gt; é›†åˆ,è¿›è¡Œè¿­ä»£å¤„ç†.   </span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">     &#x2F;&#x2F; è·å–æ’ä»¶çš„ å…¨é™å®šåå­—.   </span><br><span class="line">      String interceptor &#x3D; child.getStringAttribute(&quot;interceptor&quot;);</span><br><span class="line">     &#x2F;&#x2F; è·å–æˆ‘ä»¬å®šä¹‰åœ¨ plugin ä¸‹çš„ properties.   </span><br><span class="line">      Properties properties &#x3D; child.getChildrenAsProperties();</span><br><span class="line">&#x2F;&#x2F; resolveClassæ˜¯æœ€åæ³¨å†Œåˆ°typeAliasRegistryæ¥.    </span><br><span class="line">&#x2F;&#x2F; å®ä¾‹åŒ–,è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨å®šä¹‰çš„Pluginä¸­,æ— å‚æ„é€ å‡½æ•°æ‰“å°å‡ºæ¥çš„å†…å®¹äº†.        </span><br><span class="line">      Interceptor interceptorInstance &#x3D; (Interceptor) resolveClass(interceptor).getDeclaredConstructor().newInstance();</span><br><span class="line">&#x2F;&#x2F; å°† properties èµ‹å€¼ç»™  interceptorInstance</span><br><span class="line">&#x2F;&#x2F; ä¹Ÿå°±æ˜¯æ”¾å…¥åˆ° interceptorInstance æ¥.        </span><br><span class="line">      interceptorInstance.setProperties(properties);</span><br><span class="line">&#x2F;&#x2F; org.apache.ibatis.plugin.InterceptorChain</span><br><span class="line">&#x2F;&#x2F; è¿™æ˜¯æ˜¯å°†interceptorInstanceæ·»åŠ åˆ°InterceptorChainçš„interceptorsä¸­æ¥.        </span><br><span class="line">      configuration.addInterceptor(interceptorInstance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> å¯ä»¥çœ‹åˆ° MyBatisåœ¨åŠ è½½pluginçš„æ—¶å€™,æ˜¯åˆ©ç”¨äº†åå°„æ¥newå‡ºä¸€ä¸ªå¯¹è±¡æ¥,å¹¶ä¸”æ³¨å†Œåˆ° typeAliasRegistry ä¸­æ¥. è¿™é‡Œä¸»è¦æ˜¯è§£æ plugin çš„é…ç½®, åé¢åœ¨æ‰§è¡Œsqlçš„æ—¶å€™,éƒ½æ˜¯å¦‚ä½•ä½¿ç”¨åˆ°è¿™äº› plugin çš„å‘¢ ? è‚¯å®šæ˜¯æœ‰ä¸€ä¸ªä»InterceptorChainä¸­è·å–interceptorsæ¥,ç„¶åè¿›è¡Œå¤„ç†.</p>
<p><strong>æ ‡ç­¾äº” : &lt; objectFactory &gt;</strong></p>
<p>objectFactory çš„å¤„ç†æ–¹å¼æ˜¯å’Œ æ ‡ç­¾å››ç›¸ä¼¼çš„,åªæ˜¯æœ€ååœ¨ä½¿ç”¨åœºæ™¯æ˜¯æœ‰ç‚¹ä¸åŒçš„.</p>
<p>ä»£ç ä¸Šçš„æ“ä½œä¹Ÿæ˜¯ç±»ä¼¼çš„.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private void objectFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context !&#x3D; null) &#123;</span><br><span class="line">    String type &#x3D; context.getStringAttribute(&quot;type&quot;);</span><br><span class="line">    Properties properties &#x3D; context.getChildrenAsProperties();</span><br><span class="line">    ObjectFactory factory &#x3D; (ObjectFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">    factory.setProperties(properties);</span><br><span class="line">    configuration.setObjectFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ‡ç­¾äº” :</strong></p>
<p>è¯¥æ ‡ç­¾åœ¨ MyBatis å®˜ç½‘æ˜¯æ²¡æœ‰demo, æˆ‘æ˜¯æ ¹æ®ä»£ç æ¥é¡ºè—¤æ‘¸ç“œå†™çš„ä¸€ä¸ª.</p>
<p> å‚è€ƒ : org.apache.ibatis.reflection.wrapper.DefaultObjectWrapperFactory è¿™ä¸ªæºç ,æ¥æ¨¡ä»¿å†™çš„ä¸€ä¸ª.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</span><br><span class="line">private void objectWrapperFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context !&#x3D; null) &#123;</span><br><span class="line">   &#x2F;&#x2F; è·å– é…ç½®æ–‡ä»¶ä¸­çš„typeå€¼   </span><br><span class="line">    String type &#x3D; context.getStringAttribute(&quot;type&quot;);</span><br><span class="line"> &#x2F;&#x2F; å…ˆæ³¨å†Œåˆ°  typeAliasRegistry æ¥,ç„¶åå®ä¾‹åŒ–è¿™ä¸ªç±».</span><br><span class="line"> &#x2F;&#x2F; æˆ‘ä»¬åœ¨è‡ªå·±å®šä¹‰çš„ç±»ä¸­,å†™ä¸€ä¸ªæ— å‚æ„é€ å‡½æ•°,å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‰“å°çš„å†…å®¹äº†.     </span><br><span class="line">    ObjectWrapperFactory factory &#x3D; (ObjectWrapperFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">&#x2F;&#x2F; æœ€åèµ‹å€¼åˆ° confifuration ä¸­æ¥.      </span><br><span class="line">    configuration.setObjectWrapperFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ‡ç­¾å…­ : &lt; reflectorFactory &gt;</strong></p>
<p>å¤„ç†æ–¹å¼å’Œä¸Šé¢ç±»ä¼¼.</p>
<p>è¿™é‡Œæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ª com.iyang.mybatis.factory.GavinReflectorFactory æ¥ç»§æ‰¿DefaultReflectorFactory,åœ¨æ— å‚æ•°æ„é€ å‡½æ•°ä¸­æ‰“å°ä¸‹å†…å®¹, ç„¶ådebugè·Ÿè¿›.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void reflectorFactoryElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context !&#x3D; null) &#123;</span><br><span class="line">    String type &#x3D; context.getStringAttribute(&quot;type&quot;);</span><br><span class="line">    ReflectorFactory factory &#x3D; (ReflectorFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">    configuration.setReflectorFactory(factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ‡ç­¾ä¸ƒ :</strong></p>
<p>environments æ ‡ç­¾éƒ½æ˜¯æ”¾å…¥ä¸€äº› db çš„é…ç½®ä¿¡æ¯ç­‰.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;environments default&#x3D;&quot;development&quot;&gt;</span><br><span class="line">    &lt;environment id&#x3D;&quot;development&quot;&gt;</span><br><span class="line">        &lt;!-- äº‹åŠ¡ --&gt;</span><br><span class="line">        &lt;transactionManager type&#x3D;&quot;JDBC&quot;&#x2F;&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- DB è¿æ¥é…ç½® --&gt;</span><br><span class="line">        &lt;dataSource type&#x3D;&quot;POOLED&quot;&gt;</span><br><span class="line">            &lt;property name&#x3D;&quot;driver&quot; value&#x3D;&quot;$&#123;jdbc.driver&#125;&quot; &#x2F;&gt;</span><br><span class="line">            &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;jdbc.url&#125;&quot; &#x2F;&gt;</span><br><span class="line">            &lt;property name&#x3D;&quot;username&quot; value &#x3D; &quot;$&#123;jdbc.username&#125;&quot; &#x2F;&gt;</span><br><span class="line">            &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;jdbc.password&#125;&quot; &#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;dataSource&gt;</span><br><span class="line">    &lt;&#x2F;environment&gt;</span><br><span class="line">&lt;&#x2F;environments&gt;</span><br><span class="line">private void environmentsElement(XNode context) throws Exception &#123;</span><br><span class="line">  if (context !&#x3D; null) &#123;</span><br><span class="line">    if (environment &#x3D;&#x3D; null) &#123;</span><br><span class="line">&#x2F;&#x2F; è·å– default å¯¹åº”å­—æ®µçš„å€¼         </span><br><span class="line">      environment &#x3D; context.getStringAttribute(&quot;default&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œçš„ getChildren è·å–çš„æ˜¯ &lt;environments&gt; --&gt; &lt;environment&gt;ä¸‹çš„å­æ ‡ç­¾      </span><br><span class="line">    for (XNode child : context.getChildren()) &#123;</span><br><span class="line">      String id &#x3D; child.getStringAttribute(&quot;id&quot;);</span><br><span class="line">&#x2F;&#x2F; ç¡®ä¿ id å’Œ  ä¸Šä¸€æ­¥çš„environment çš„å€¼æ˜¯ç›¸åŒçš„,å°±ä¼šè¿”å›true.      </span><br><span class="line">      if (isSpecifiedEnvironment(id)) &#123;</span><br><span class="line">&#x2F;**</span><br><span class="line">*  è·å–å‡º transactionManager å¯¹åº”çš„æ ‡ç­¾.</span><br><span class="line">*  ç„¶åæ ¹æ® JBDC(é…ç½®æ–‡ä»¶ä¸­çš„å€¼),ç„¶åä» typeAliasRegistryä¸­è·å–å‡ºæ¥ï¼Œ</span><br><span class="line">*  è°ƒç”¨åå°„æ¥ å®ä¾‹åŒ– è¿™ä¸ªå¯¹è±¡. </span><br><span class="line">*  æœ€åè¿˜æ˜¯å¯ä»¥é…ç½® properties,ä¼šè¢«setåˆ°txFactoryä¸­å»çš„.</span><br><span class="line">*  ä½†æ˜¯ JdbcTransactionFactory å¥½åƒæ²¡æœ‰é‡å†™ setProperties æ–¹æ³•.</span><br><span class="line">*&#x2F;          </span><br><span class="line">        TransactionFactory txFactory &#x3D; transactionManagerElement(child.evalNode(&quot;transactionManager&quot;));</span><br><span class="line">&#x2F;&#x2F; å…ˆè·å–  dataSource å­—æ®µ</span><br><span class="line">&#x2F;**</span><br><span class="line">*  å…ˆè·å–typeçš„å€¼,ç„¶åå†è·å– propertiesçš„æ ‡ç­¾å­—æ®µå€¼.</span><br><span class="line">*  æ ¹æ®æˆ‘ä»¬çš„é…ç½® : org.apache.ibatis.datasource.pooled.PooledDataSourceFactory,åº”è¯¥ä¼šè·å–å‡ºè¿™ä¸ªå¯¹è±¡.è¯¥å¯¹è±¡å…¶å†…éƒ¨æ˜¯æœ‰ä¸€ä¸ª,org.apache.ibatis.datasource.pooled.PooledDataSourceçš„,é‡Œé¢æœ‰éƒ¨åˆ†é»˜è®¤å€¼çš„.</span><br><span class="line">*æœ€åå°†  properties è°ƒç”¨ org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory#setPropertiesæ–¹æ³•,</span><br><span class="line">æœ€åæ˜¯å°† properties é‡Œé¢çš„key&#x2F;value éƒ½è®¾ç½®åˆ° MetaObject metaDataSource &#x3D; SystemMetaObject.forObject(dataSource);æ¥äº†.</span><br><span class="line">*&#x2F;</span><br><span class="line">        DataSourceFactory dsFactory &#x3D; dataSourceElement(child.evalNode(&quot;dataSource&quot;));</span><br><span class="line">&#x2F;&#x2F; ä»  PooledDataSourceFactory ä¸­è·å– datasource å±æ€§.         </span><br><span class="line">        DataSource dataSource &#x3D; dsFactory.getDataSource();</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œé‡‡ç”¨é“¾å¼ç¼–ç¨‹,ä¹Ÿå°±æ˜¯å°†id&#x2F;txFactory&#x2F;dataSource éƒ½ç»™setåˆ° Environment.Builderæ¥äº†.         </span><br><span class="line">        Environment.Builder environmentBuilder &#x3D; new Environment.Builder(id)</span><br><span class="line">            .transactionFactory(txFactory)</span><br><span class="line">            .dataSource(dataSource);</span><br><span class="line">  &#x2F;&#x2F;    environmentBuilder.build() ä¹Ÿå°±æ˜¯new äº†ä¸€ä¸ª Environment </span><br><span class="line">  &#x2F;&#x2F; æœ€å èµ‹å€¼åˆ° configuration ä¸­æ¥äº†.        </span><br><span class="line">        configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> è§£æ environments ,åˆ©ç”¨ typeAliasRegistry ä¸­å·²ç»æ³¨å†Œå¥½äº†çš„ä¿¡æ¯,ç„¶åæ ¹æ®åå­—ç¼©å†™(æ¯”å¦‚JDBC)è¿™ç§,æ¥è·å–classå¯¹è±¡, ç”¨ åå°„æ¥ new ä¸€æ³¢å¯¹è±¡å‡ºæ¥,çœŸæ˜¯ç¾æ»‹æ»‹. æ¥ç€å°±æ˜¯è§£æ äº‹åŠ¡/JDBCè¿æ¥é…ç½®ä¿¡æ¯ç­‰, æœ€åå°†ä¿¡æ¯ä¿å­˜åˆ° DataSource ä¸­æ¥. åæ‰‹å†æ¥ä¸€æ³¢ é“¾å¼ç¼–ç¨‹ æ¥newå¯¹è±¡å‡ºæ¥, æœ€åå°±æ˜¯ä¸€ä¸ª Environment å¯¹è±¡å‡ºæ¥,ç»™set åˆ° configuration ä¸­æ¥.</p>
<p><strong>æ ‡ç­¾å…«</strong></p>
<p> åˆ°è¿™é‡Œ,å¯ä»¥çœ‹åˆ°å¯¹xmlçš„è§£ææ“ä½œ. å…ˆè§£æ æ ‡ç­¾ çš„å€¼å‡ºæ¥,ç„¶åæ ¹æ®å€¼è¿›è¡Œåˆ†ç±»å¤„ç†æˆ–è€…æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥è¿›è¡Œå¤„ç†.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private void typeHandlerElement(XNode parent) &#123;</span><br><span class="line">  if (parent !&#x3D; null) &#123;</span><br><span class="line">    for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">      &#x2F;&#x2F; å¦‚æœå­æ ‡ç­¾æ˜¯ package   </span><br><span class="line">      if (&quot;package&quot;.equals(child.getName())) &#123;</span><br><span class="line">       &#x2F;&#x2F; è·å–å‡º name å¯¹åº”çš„å€¼.   </span><br><span class="line">        String typeHandlerPackage &#x3D; child.getStringAttribute(&quot;name&quot;);</span><br><span class="line">      &#x2F;&#x2F; æ³¨å†Œåˆ°   typeHandlerRegistry ä¸­æ¥.  </span><br><span class="line">        typeHandlerRegistry.register(typeHandlerPackage);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line"> &#x2F;&#x2F; è¿™é‡Œè·å–å‡ºä¸‰ç§å€¼æ¥,   javaType&#x2F;jdbcType&#x2F;  handler    </span><br><span class="line">        String javaTypeName &#x3D; child.getStringAttribute(&quot;javaType&quot;);</span><br><span class="line">        String jdbcTypeName &#x3D; child.getStringAttribute(&quot;jdbcType&quot;);</span><br><span class="line">        String handlerTypeName &#x3D; child.getStringAttribute(&quot;handler&quot;);</span><br><span class="line">        Class&lt;?&gt; javaTypeClass &#x3D; resolveClass(javaTypeName);</span><br><span class="line">        JdbcType jdbcType &#x3D; resolveJdbcType(jdbcTypeName);</span><br><span class="line">        Class&lt;?&gt; typeHandlerClass &#x3D; resolveClass(handlerTypeName);</span><br><span class="line">  &#x2F;&#x2F; åˆ†ä¸º  javaTypeClass æ˜¯ä¸æ˜¯ null çš„æƒ…å†µ       </span><br><span class="line">        if (javaTypeClass !&#x3D; null) &#123;</span><br><span class="line">         &#x2F;&#x2F; åŸºäº javaTypeClass æ˜¯ä¸æ˜¯ nullçš„æƒ…å†µ,å†åˆ¤æ–­ jdbcType æ˜¯ä¸æ˜¯null  </span><br><span class="line">          if (jdbcType &#x3D;&#x3D; null) &#123;</span><br><span class="line">            typeHandlerRegistry.register(javaTypeClass, typeHandlerClass);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            typeHandlerRegistry.register(javaTypeClass, jdbcType, typeHandlerClass);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">&#x2F;&#x2F; è¿™æ˜¯æ ¹æ®   handlerTypeName æ³¨å†Œåˆ° typeHandlerRegistry ä¸­æ¥.           </span><br><span class="line">          typeHandlerRegistry.register(typeHandlerClass);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>æ ‡ç­¾ä¹ :</strong></p>
<p> è¯¥æ ‡ç­¾æ˜¯å¯¹æˆ‘ä»¬å¯¹åº”çš„å¯¹è±¡,å…¶sqlè¯­å¥å­˜æ”¾çš„åœ°å€. ä¹Ÿå°±æ˜¯é‡Œé¢æ”¾å…¥çš„æ˜¯äºmapperæ¥å£å¯¹åº”çš„æ–¹æ³•,æŸ¥è¯¢çš„sqlè¯­å¥.</p>
<p> æ¥ä¸‹æ¥çœ‹ä¸‹ MyBatis æ˜¯å¯¹ mappers æ ‡ç­¾çš„å†…å®¹è¿›è¡Œäº†è¯´æ˜è§£æå’Œå¤„ç†.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">      </span><br><span class="line"> <span class="comment">// getChildren è·å–çš„æ˜¯ mappers ä¸‹çš„ mapper æ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœé…ç½®çš„æ˜¯ package.        </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">"package"</span>.equals(child.getName())) &#123;</span><br><span class="line">        String mapperPackage = child.getStringAttribute(<span class="string">"name"</span>);</span><br><span class="line">        configuration.addMappers(mapperPackage);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// è·å–å‡º    resource/url/class è¿™ä¸‰ç±»çš„å€¼.       </span></span><br><span class="line">        String resource = child.getStringAttribute(<span class="string">"resource"</span>);</span><br><span class="line">        String url = child.getStringAttribute(<span class="string">"url"</span>);</span><br><span class="line">        String mapperClass = child.getStringAttribute(<span class="string">"class"</span>);</span><br><span class="line"> <span class="comment">// å¯¹ resource å¤„ç†         </span></span><br><span class="line">        <span class="keyword">if</span> (resource != <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å°† resource èµ‹å€¼ç»™ ErrorContext ä¸­  </span></span><br><span class="line">          ErrorContext.instance().resource(resource);</span><br><span class="line">     <span class="comment">// è¯»å–æ–‡ä»¶.       </span></span><br><span class="line">          InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line"><span class="comment">// ä½¿ç”¨ XMLMapperBuilder æ¥å¯¹è§£æxmlå†…å®¹.            </span></span><br><span class="line">          XMLMapperBuilder mapperParser = <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line"><span class="comment">// url å¤„ç†            </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url != <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">          ErrorContext.instance().resource(url);</span><br><span class="line">          InputStream inputStream = Resources.getUrlAsStream(url);</span><br><span class="line">          XMLMapperBuilder mapperParser = <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());</span><br><span class="line">          mapperParser.parse();</span><br><span class="line"><span class="comment">// mapperClass å¤„ç†            </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">          Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">          configuration.addMapper(mapperInterface);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"A mapper element may only specify a url, resource or class, but not more than one."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line"><span class="comment">// è¿™é‡Œæˆ‘ä»¬è·Ÿè¿› mapperParser.parse() æ–¹æ³•æ¥</span></span><br><span class="line"><span class="comment">// org.apache.ibatis.builder.xml.XMLMapperBuilder</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­ configuration çš„ loadedResources æ˜¯å¦å«æœ‰è¯¥å€¼,å¦‚æœä¸å«æœ‰çš„è¯,å°±ä¼šå»è§£æ.  </span></span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line"><span class="comment">// å¯¹mapper æ ‡ç­¾è¿›è¡Œè§£æ        </span></span><br><span class="line">      configurationElement(parser.evalNode(<span class="string">"/mapper"</span>));</span><br><span class="line">      configuration.addLoadedResource(resource);</span><br><span class="line">      bindMapperForNamespace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parsePendingResultMaps();</span><br><span class="line">    parsePendingCacheRefs();</span><br><span class="line">    parsePendingStatements();</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line"><span class="comment">//   configurationElement æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configurationElement</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="comment">// è·å– namespace       </span></span><br><span class="line">      String namespace = context.getStringAttribute(<span class="string">"namespace"</span>);</span><br><span class="line">      <span class="keyword">if</span> (namespace == <span class="keyword">null</span> || namespace.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Mapper's namespace cannot be empty"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//  MapperBuilderAssistant å°† namespace ç»‘å®šåˆ°è¯¥ç±»çš„å‚æ•°ä¸­æ¥.        </span></span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// è¿™é‡Œçš„ cache-ref / cache éƒ½æ˜¯æš‚æ—¶æ²¡æœ‰é…ç½®çš„.     </span></span><br><span class="line">      cacheRefElement(context.evalNode(<span class="string">"cache-ref"</span>));</span><br><span class="line">      cacheElement(context.evalNode(<span class="string">"cache"</span>));</span><br><span class="line">        </span><br><span class="line"> <span class="comment">//  /mapper/parameterMap ä¹Ÿæ˜¯æš‚æ—¶æ²¡æœ‰é…ç½®çš„  </span></span><br><span class="line">      parameterMapElement(context.evalNodes(<span class="string">"/mapper/parameterMap"</span>));</span><br><span class="line">        </span><br><span class="line"><span class="comment">// resultMap æ˜¯å¯¹å¯¹è±¡å­—æ®µçš„æ˜ å°„</span></span><br><span class="line"><span class="comment">// mapper/sql æ˜¯å¯¹ä¸€äº›å…¬ç”¨çš„sqlè¿›è¡ŒæŠ½å–</span></span><br><span class="line"><span class="comment">// äºŒè€…æš‚æ—¶éƒ½æ²¡æœ‰é…ç½®        </span></span><br><span class="line">      resultMapElements(context.evalNodes(<span class="string">"/mapper/resultMap"</span>));</span><br><span class="line">      sqlElement(context.evalNodes(<span class="string">"/mapper/sql"</span>));</span><br><span class="line"><span class="comment">// è·å– select / insert / update / delete ç­‰ æ ‡ç­¾.        </span></span><br><span class="line">      buildStatementFromContext(context.evalNodes(<span class="string">"select|insert|update|delete"</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error parsing Mapper XML. The XML location is '"</span> + resource + <span class="string">"'. Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾€ä¸‹è·Ÿæ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">      <span class="keyword">final</span> XMLStatementBuilder statementParser = <span class="keyword">new</span> XMLStatementBuilder(configuration, builderAssistant, context, requiredDatabaseId);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        statementParser.parseStatementNode();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">        configuration.addIncompleteStatement(statementParser);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lwfby.cn/2020/12/25/mybatis/mybatis-work-flow-read/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YangL">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YangL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/25/mybatis/mybatis-work-flow-read/" itemprop="url">mybatis-work-flow-read</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-12-25T00:14:54+08:00">
                2020-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MyBatis/" itemprop="url" rel="index">
                    <span itemprop="name">MyBatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  4.5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  20
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ"><a href="#MyBatis-çš„å·¥ç¨‹æµç¨‹åˆ†æ" class="headerlink" title="MyBatis çš„å·¥ç¨‹æµç¨‹åˆ†æ"></a>MyBatis çš„å·¥ç¨‹æµç¨‹åˆ†æ</h4><p>â€‹    MyBatis æ˜¯æˆ‘ä»¬åœ¨å­¦ä¹ Javaæ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯å­¦ä¹ å®ŒJavaWebçš„çŸ¥è¯†å,è¦å­¦ä¹ åˆ°çš„ä¸€ä¸ªORMçš„æ¡†æ¶. æˆ‘ä¹Ÿæ˜¯å­¦ä¹ &amp;ä½¿ç”¨è¿‡åï¼Œå†æ¬¡å¯¹æºç è¿›è¡Œé˜…è¯»çš„. æ‰€ä»¥è¿™ç¯‡æ–‡ç« è®°å½• MyBatis çš„ä¸€ä¸ª work flow.</p>
<p>â€‹    å…ˆæ”¾ä¸Šé¡¹ç›®åœ°å€ : <a href="https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-work-flow" target="_blank" rel="noopener">https://github.com/baoyang23/mybtatis-analysis/tree/master/mybatis-work-flow</a> </p>
<p>â€‹    æœ‰å…´è¶£çš„åŒå­¦,å¯ä»¥cloneä¸‹æ¥çœ‹çœ‹.</p>
<h4 id="æ¡ˆä¾‹ä»£ç "><a href="#æ¡ˆä¾‹ä»£ç " class="headerlink" title="æ¡ˆä¾‹ä»£ç "></a>æ¡ˆä¾‹ä»£ç </h4><p>å…ˆæ”¾ä¸Šæ¡ˆåˆ—çš„ä»£ç , ç„¶åæˆ‘ä»¬å¯ä»¥æŒ¨ä¸ªçš„åˆ†æ.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitHelloMyBatis</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// è¯»å–é…ç½®æ–‡ä»¶.</span></span><br><span class="line">        InputStream mybatisInputStream = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</span><br><span class="line">        <span class="comment">// ä¼ å…¥è¯»å–é…ç½®æ–‡ä»¶çš„æµ,ä½¿ç”¨SqlSessionFactoryBuilderæ¥</span></span><br><span class="line">        <span class="comment">// æ„å»º SqlSessionFactory.</span></span><br><span class="line">        SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br><span class="line">        <span class="comment">// ä» SqlSessionFactory ä¸­è·å–SqlSessionä¼šè¯.</span></span><br><span class="line">        SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»ä¼šè¯ä¸­è·å– Mapper.</span></span><br><span class="line">        BlogMapper blogMapper = session.getMapper(BlogMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒç”¨æŸ¥è¯¢æ–¹æ³•.</span></span><br><span class="line">        TbBlog tbBlog = blogMapper.selectBlog(<span class="number">1</span>);</span><br><span class="line">        System.out.println(tbBlog);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è¿™é‡Œè¯´ä¸‹å¤§è‡´æµç¨‹ : </p>
<ul>
<li>ä½¿ç”¨ Resources æ¥è¯»å– mybatis-config.xmlé…ç½®æ–‡ä»¶, å¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨æˆ–è€…è¯»å–å‡ºæ¥ InputStream æ˜¯ null çš„è¯,ç¨‹åºå°±ä¼šæŠ›å‡º IOException çš„é”™è¯¯æ¥.</li>
<li>è¯»å–é…ç½®æ²¡æœ‰é—®é¢˜,æ¥åˆ° new SqlSessionFactoryBuilder().build(io) æ¥æ„å»ºå‡ºä¸€ä¸ª SqlSessionFactory æ¥, è¿™é‡Œæ„å»ºå‡ºæ¥çš„ SqlSessionFactory è‚¯å®šæ˜¯æœ‰å·²ç»è®²é…ç½®æ–‡ä»¶ç»™å…¨éƒ¨åŠ è½½è¿›å»äº†çš„.</li>
<li>SqlSessionFactory.openSession() ä» SqlSessionFactory ä¸­è·å–ä¸€æ¬¡ä¼šè¯, ç„¶åå¯ä»¥ä»ä¼šè¯ä¸­è·å–å‡ºæ¥å£(BlogMapper)æ¥,è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å¥½å¥‡,æ˜æ˜è¿™å°±æ˜¯ä¸€ä¸ªæ¥å£,ä¹Ÿæ²¡æœ‰å®ç°ç±»,æ€ä¹ˆå°±å¯ä»¥getå‡ºä¸€ä¸ªæ¥å£å¯¹è±¡æ¥?è·å–å‡ºæ¥å£æ¥,ç„¶åå°±å¯ä»¥è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•, æ ¹æ®idæŸ¥è¯¢å‡ºæ•°æ®æ¥.</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°,æ ¹æ®ä»å®˜ç½‘å†™çš„ä¸€ä¸ªåˆ—å­,ä»è¡¨é¢æ¥çœ‹,ä»£ç é‡å¹¶ä¸æ˜¯å¾ˆå¤š. æ‰€ä»¥æ¥ä¸‹æ¥ç‚¹å»æºç ,å»è·Ÿè¿›æºç ä¸­çš„æ¯ä¸ªæ–¹æ³•,åˆ°åº•åšäº†äº›ä»€ä¹ˆäº‹æƒ….</p>
<p><strong>è¯»å–é…ç½®æ–‡ä»¶</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream mybatisInputStream &#x3D; Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br></pre></td></tr></table></figure>

<p>org.apache.ibatis.io.Resources (Class).</p>
<p>å¯ä»¥çœ‹åˆ°MyBatisæºç è¿˜å†™äº†ä¸€ä¸ª ClassLoaderçš„åŒ…è£…ç±»ï¼Œé€šè¿‡ClassLoaderWrapperåŒ…è£…ç±»æ¥è®²é…ç½®æ–‡ä»¶è½¬åŒ–ä¸ºInputSream.</p>
<p>å¦‚æœè¿”å›çš„InputStreamæ˜¯nullï¼Œå°±ä¼šæŠ›å‡ºIOExceptionæ¥.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Returns a resource on the classpath as a Stream object</span><br><span class="line"> *</span><br><span class="line"> * @param loader   The classloader used to fetch the resource</span><br><span class="line"> * @param resource The resource to find</span><br><span class="line"> * @return The resource</span><br><span class="line"> * @throws java.io.IOException If the resource cannot be found or read</span><br><span class="line"> *&#x2F;</span><br><span class="line">private static ClassLoaderWrapper classLoaderWrapper &#x3D; new ClassLoaderWrapper();</span><br><span class="line"></span><br><span class="line">public static InputStream getResourceAsStream(ClassLoader loader, String resource) throws IOException &#123;</span><br><span class="line">  &#x2F;&#x2F; åˆ©ç”¨ ClasssLoaderWrapper.  </span><br><span class="line">  InputStream in &#x3D; classLoaderWrapper.getResourceAsStream(resource, loader);</span><br><span class="line">  if (in &#x3D;&#x3D; null) &#123;</span><br><span class="line">    throw new IOException(&quot;Could not find resource &quot; + resource);</span><br><span class="line">  &#125;</span><br><span class="line">  return in;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>äºæ˜¯æˆ‘ä»¬æ¥ç€çœ‹ ClassLoaderWrapper æ˜¯æ€ä¹ˆ è¯»å–é…ç½®æ–‡ä»¶ &amp; è½¬åŒ–ä¸º InputStream æµçš„.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; è¿™é‡Œè¿”å›çš„æ˜¯ ClassLoaderçš„æ•°ç»„,å¦‚æœå¯¹ClassLoaderä¸æ˜¯å¾ˆäº†è§£çš„è¯,å¯ä»¥å…ˆå»ç™¾åº¦äº†è§£ä¸‹.</span><br><span class="line">ClassLoader[] getClassLoaders(ClassLoader classLoader) &#123;</span><br><span class="line">  return new ClassLoader[]&#123;</span><br><span class="line">      &#x2F;&#x2F; ä¼ é€’è¿›æ¥çš„ </span><br><span class="line">      classLoader,</span><br><span class="line">      &#x2F;&#x2F; é»˜è®¤çš„ ClassLoader</span><br><span class="line">      defaultClassLoader,</span><br><span class="line">      &#x2F;&#x2F; æ ¹æ®å½“å‰çº¿ç¨‹è·å–å‡ºæ¥çš„</span><br><span class="line">      Thread.currentThread().getContextClassLoader(),</span><br><span class="line">      &#x2F;&#x2F; æ ¹æ®å½“å‰ Class è·å–å‡ºæ¥çš„.</span><br><span class="line">      getClass().getClassLoader(),</span><br><span class="line">      &#x2F;&#x2F; ç³»ç»Ÿçš„ClassLoader.</span><br><span class="line">      systemClassLoader&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è·å–åˆ°äº† classLoaderçš„æ•°ç»„,ç„¶åå¯¹å…¶è¿›è¡Œè¿­ä»£.</span><br><span class="line">&#x2F;&#x2F; ä¹Ÿå°±æ˜¯ä½¿ç”¨ ClassLoaderçš„  getResourceAsStream æ–¹æ³•,æ¥è®² mybatis-config.xml</span><br><span class="line">&#x2F;&#x2F; é…ç½®æ–‡ä»¶è½¬åŒ–ä¸º InputStream.</span><br><span class="line">&#x2F;&#x2F; æœ€åå¦‚æœè·å–åˆ°InputStreaméƒ½æ˜¯nullçš„è¯,é‚£ä¹ˆè¿”å›çš„ä¹Ÿå°±æ˜¯nulläº†.</span><br><span class="line">&#x2F;&#x2F; æ ¹æ®ä¸Šé¢çš„è¯´æ³•,è¿”å›çš„å¦‚æœæ˜¯nullçš„è¯,å°±ä¼šå‡º IOExceptionæ¥.</span><br><span class="line">InputStream getResourceAsStream(String resource, ClassLoader[] classLoader) &#123;</span><br><span class="line">    for (ClassLoader cl : classLoader) &#123;</span><br><span class="line">      if (null !&#x3D; cl) &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; try to find the resource as passed</span><br><span class="line">        InputStream returnValue &#x3D; cl.getResourceAsStream(resource);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; now, some class loaders want this leading &quot;&#x2F;&quot;, so we&#39;ll add it and try again if we didn&#39;t find the resource</span><br><span class="line">        if (null &#x3D;&#x3D; returnValue) &#123;</span><br><span class="line">          returnValue &#x3D; cl.getResourceAsStream(&quot;&#x2F;&quot; + resource);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (null !&#x3D; returnValue) &#123;</span><br><span class="line">          return returnValue;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>è‡³æ­¤,MyBatisè¯»å– mybatis-config.xml é…ç½®æ–‡ä»¶ä¹Ÿå°±æ˜¯è§£æå®Œæ¯•,å¯ä»¥çœ‹åˆ°é‡‡ç”¨äº†è‡ªå·±å†™çš„ ClassLoaderWrapperæ¥æ“ä½œçš„, ä¼ é€’ä¸€ç§ ClassLoaderè¿›æ¥,å…¶é»˜è®¤çš„&amp;ç³»ç»Ÿ&amp;çº¿ç¨‹çš„,åŠ ä¸€èµ·ä¹Ÿæ˜¯æœ‰å››ç§. æœ€åæŒ¨ä¸ªè¿›æ¥è¿­ä»£ï¼Œæ»¡è¶³æ¡ä»¶çš„ä¼šè¯»å–æ–‡ä»¶è½¬åŒ–ä¸ºInputStream,å¦‚æœéƒ½æ˜¯nullçš„è¯,ä¹Ÿä¼šè¿”å›null.</strong></p>
<hr>
<p><strong>è·å–SqlSessionFactory &amp; è§£æé…ç½®æ–‡ä»¶</strong></p>
<p>new SqlSessionFactoryBuilder() ä¹Ÿæ˜¯newäº†ä¸€ä¸ª SqlSessionFactoryBuild,ä¸ªäººç†è§£ SqlSessionFactoryBuilder å°±æ˜¯ä¸“ç¨‹ç”¨æ¥æ„å»ºå‡º SqlSessionFactory æ¥çš„,æ¯•ç«Ÿå…¶åé¢æœ‰ä¸€ä¸ª build æ–¹æ³•.</p>
<p>Problem ? è¿™é‡Œæœ‰ä¸ªé—®é¢˜,ä¸ºä»€ä¹ˆä¸å°† SqlSessionFactoryBuilder çš„build æ–¹æ³•,ä¿®æ”¹ä¸ºé™æ€çš„ ? å¦‚æœä¿®æ”¹ä¸ºé™æ€çš„è¯ï¼Œé‚£å°±ä¸ç”¨newäº†,å°±å¯ä»¥ç›´æ¥ SqlSessionFactoryBuilder.build(mybatisInputStream);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SqlSessionFactory sqlSessionFactory &#x3D; new                     SqlSessionFactoryBuilder().build(mybatisInputStream);</span><br></pre></td></tr></table></figure>

<p> <strong>SqlSessionFactory</strong></p>
<p> æ¥ç€æˆ‘ä»¬æ¥åˆ° SqlSessionFactory çš„ build æ–¹æ³•.</p>
<p> è¿™é‡Œåœ¨ finnaly ä¸­, å¯ä»¥çœ‹åˆ° ErrorContext åˆ©ç”¨äº† ThreadLocal , åˆšå¥½è¿™å‘¨å‡ºäº† ThreadLocal çš„è§†é¢‘.</p>
<p> è§†é¢‘åœ°å€ : <a href="https://www.bilibili.com/video/BV1Ga4y1W72w" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1Ga4y1W72w</a></p>
<p> æœ‰å…´è¶£&amp;ä¹äºå­¦ä¹ &amp;åˆ†äº«çš„,å¯ä»¥å…±åŒè¿›æ­¥.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    &#x2F;&#x2F; åˆ©ç”¨ä¼ å…¥è¿›æ¥çš„å‚æ•°,newå‡ºæ¥äº†ä¸€ä¸ª XMLConfigBuilder.</span><br><span class="line">    XMLConfigBuilder parser &#x3D; new XMLConfigBuilder(inputStream, environment, properties);</span><br><span class="line">    return build(parser.parse());</span><br><span class="line">  &#125; catch (Exception e) &#123;</span><br><span class="line">    throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e);</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    &#x2F;&#x2F; è¿™é‡Œå¯¹ ThreadLocal ä¸­è¿›è¡Œ remove() æ“ä½œ   </span><br><span class="line">    ErrorContext.instance().reset();</span><br><span class="line">    try &#123;</span><br><span class="line">      &#x2F;&#x2F; å…³é—­æµ.  </span><br><span class="line">      inputStream.close();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">      &#x2F;&#x2F; Intentionally ignore. Prefer previous error.</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>new XmlConfigBuilder() æ–¹æ³•:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">public XMLConfigBuilder(InputStream inputStream, String environment, Properties props) &#123;</span><br><span class="line">  &#x2F;&#x2F; å…ˆnewä¸€ä¸ªXMLMapperEntityResolver,å†newä¸€ä¸ªXPathParser,ç„¶åå°±èµ°åˆ°ä¸‹é¢çš„æ„é€ å‡½æ•°.</span><br><span class="line">  this(new XPathParser(inputStream, true, props, new XMLMapperEntityResolver()), environment, props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æœ€åè¿˜æ˜¯èµ°åˆ°è¿™ä¸ªæ„é€ æ–¹æ³•ä¸­æ¥.</span><br><span class="line">private XMLConfigBuilder(XPathParser parser, String environment, Properties props) &#123;</span><br><span class="line">  super(new Configuration());</span><br><span class="line">  ErrorContext.instance().resource(&quot;SQL Mapper Configuration&quot;);</span><br><span class="line">  this.configuration.setVariables(props);</span><br><span class="line">  this.parsed &#x3D; false;</span><br><span class="line">  this.environment &#x3D; environment;</span><br><span class="line">  this.parser &#x3D; parser;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line">&#x2F;&#x2F; new XPathParserä»£ç :</span><br><span class="line">    </span><br><span class="line">  public XPathParser(InputStream inputStream, boolean validation, Properties variables, EntityResolver entityResolver) &#123;</span><br><span class="line">    &#x2F;&#x2F; æ™®é€šçš„æ„é€ æ–¹æ³•.</span><br><span class="line">    &#x2F;&#x2F; å¯¹ XPathParserçš„validation&#x2F;entityResolver&#x2F;variables&#x2F;xpath</span><br><span class="line">    &#x2F;&#x2F; çš„å±æ€§è¿›è¡Œèµ‹å€¼æ“ä½œ.</span><br><span class="line">    commonConstructor(validation, variables, entityResolver);</span><br><span class="line">    this.document &#x3D; createDocument(new InputSource(inputStream));</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; createDocument æ–¹æ³•</span><br><span class="line">  private Document createDocument(InputSource inputSource) &#123;</span><br><span class="line">    &#x2F;&#x2F; important: this must only be called AFTER common constructor</span><br><span class="line">    try &#123;</span><br><span class="line">      &#x2F;&#x2F; è¿™é‡Œé€šè¿‡debugçœ‹,è¿”å›çš„å¯¹è±¡æ˜¯DocumentBuilderFactoryImpl</span><br><span class="line">      &#x2F;&#x2F; ä¹Ÿå°±æ˜¯å…¶å®ç°ç±».  </span><br><span class="line">      DocumentBuilderFactory factory &#x3D; DocumentBuilderFactory.newInstance();</span><br><span class="line">     &#x2F;&#x2F; å¯¹ factory çš„ features(HashMap) æ·»åŠ å€¼,   </span><br><span class="line">      factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span><br><span class="line">     &#x2F;&#x2F; å¯¹ factory çš„ validating è¿›è¡Œèµ‹å€¼  </span><br><span class="line">      factory.setValidating(validation);</span><br><span class="line">	 &#x2F;&#x2F; è¿™ä¸‹é¢éƒ½æ˜¯å¯¹ factoryçš„å±æ€§è¿›è¡Œèµ‹å€¼æ“ä½œ.	</span><br><span class="line">      factory.setNamespaceAware(false);</span><br><span class="line">      factory.setIgnoringComments(true);</span><br><span class="line">      factory.setIgnoringElementContentWhitespace(false);</span><br><span class="line">      factory.setCoalescing(false);</span><br><span class="line">      factory.setExpandEntityReferences(true);</span><br><span class="line">		</span><br><span class="line">      &#x2F;&#x2F; å¯ä»¥çœ‹åˆ° return new DocumentBuilderImpl</span><br><span class="line">      &#x2F;&#x2F; æœ€åè¿”å›çš„ä¹Ÿæ˜¯å…¶å®ç°ç±». </span><br><span class="line">      DocumentBuilder builder &#x3D; factory.newDocumentBuilder();</span><br><span class="line">      builder.setEntityResolver(entityResolver);</span><br><span class="line">      &#x2F;&#x2F; è®¾ç½®é”™è¯¯çš„handler,å¯ä»¥çœ‹åˆ°ErrorHandleræ˜¯æ¥å£,è¿™é‡Œæ˜¯åŒ¿åå®ç°çš„</span><br><span class="line">      &#x2F;&#x2F; ä¹Ÿå°±æ˜¯ç›´æ¥newäº†æ¥å£,ç„¶åé‡å†™å…¶æ–¹æ³•.  </span><br><span class="line">      builder.setErrorHandler(new ErrorHandler() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void error(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          throw exception;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void fatalError(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          throw exception;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void warning(SAXParseException exception) throws SAXException &#123;</span><br><span class="line">          &#x2F;&#x2F; NOP</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      &#x2F;&#x2F;   DocumentBuilderImpl çš„ parse è§£ææ–¹æ³•</span><br><span class="line">      return builder.parse(inputSource);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error creating document instance.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">&#x2F;&#x2F;   builder.parse(inputSource)</span><br><span class="line"></span><br><span class="line">    public Document parse(InputSource is) throws SAXException, IOException &#123;</span><br><span class="line">        if (is &#x3D;&#x3D; null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(</span><br><span class="line">                DOMMessageFormatter.formatMessage(DOMMessageFormatter.DOM_DOMAIN,</span><br><span class="line">                &quot;jaxp-null-input-source&quot;, null));</span><br><span class="line">        &#125;</span><br><span class="line">    &#x2F;&#x2F; fSchemaValidator æ˜¯ null ,è·³è¿‡.</span><br><span class="line">        if (fSchemaValidator !&#x3D; null) &#123;</span><br><span class="line">            if (fSchemaValidationManager !&#x3D; null) &#123;</span><br><span class="line">                fSchemaValidationManager.reset();</span><br><span class="line">                fUnparsedEntityHandler.reset();</span><br><span class="line">            &#125;</span><br><span class="line">            resetSchemaValidator();</span><br><span class="line">        &#125;</span><br><span class="line">  &#x2F;&#x2F; ä½¿ç”¨ xml çš„ç›¸å…³ç±»å¯¹ is è¿›è¡Œè§£æ  </span><br><span class="line">        domParser.parse(is);</span><br><span class="line"> &#x2F;&#x2F;  ?   </span><br><span class="line">        Document doc &#x3D; domParser.getDocument();</span><br><span class="line"> &#x2F;&#x2F; ? è¿™äº›è§£æ Document çš„åœ°æ–¹.....   </span><br><span class="line">        domParser.dropDocumentReferences();</span><br><span class="line">        return doc;</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line">&#x2F;&#x2F; æœ€åçœ‹åˆ° this æ„é€ å‡½æ•°.</span><br><span class="line"></span><br><span class="line">  private XMLConfigBuilder(XPathParser parser, String environment, Properties props) &#123;</span><br><span class="line">    &#x2F;** new Configuration() ä¸­,TypeAliasRegistry typeAliasRegistryä¸­çš„ typeAliases,</span><br><span class="line">    *   åœ¨åˆå§‹åŒ–è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™,å°±é»˜è®¤è®¾ç½®äº†ä¸€äº›åˆ«åé…ç½®.</span><br><span class="line">    *   åˆå§‹åŒ–çš„æ—¶å€™,è¿˜æœ‰å¯¹ LanguageDriverRegistry çš„ LANGUAGE_DRIVER_MAP èµ‹å€¼.</span><br><span class="line">    *  çˆ¶ç±» :  BaseBuilderæŠ½è±¡ç±».</span><br><span class="line">    *  ç„¶åè°ƒç”¨superæ–¹æ³•,å°†configurationèµ‹å€¼çˆ¶ç±»çš„configuration</span><br><span class="line">    *  åŒæ—¶å°† configurationçš„typeAliasRegistryå’ŒtypeHandlerRegistryä¹Ÿèµ‹å€¼</span><br><span class="line">    *  ç»™å½“å‰çš„è¿™ä¸ªå¯¹è±¡.</span><br><span class="line">    *   </span><br><span class="line">    *&#x2F;</span><br><span class="line">    super(new Configuration());</span><br><span class="line">    &#x2F;&#x2F; instance() æ–¹æ³•æ˜¯å¾€ ThreadLocalé‡Œé¢å»setäº†ä¸€ä¸ªErrorContext</span><br><span class="line">    &#x2F;&#x2F; æœ€åä¼šåœ¨finnalyä¸­è¿›è¡Œremoveæ‰.</span><br><span class="line">    ErrorContext.instance().resource(&quot;SQL Mapper Configuration&quot;);</span><br><span class="line">    &#x2F;&#x2F; å°† props èµ‹å€¼åˆ° configuration çš„ variable å‚æ•°.</span><br><span class="line">    this.configuration.setVariables(props);</span><br><span class="line">    &#x2F;&#x2F; è¡¨ç¤ºè¿˜æ²¡æœ‰è¢«è§£æ</span><br><span class="line">    this.parsed &#x3D; false;</span><br><span class="line">    this.environment &#x3D; environment;</span><br><span class="line">    this.parser &#x3D; parser;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œ,å°±å¯ä»¥çœ‹åˆ° thisæ„é€ æ–¹æ³•ä»¥åŠå…¶ä¹‹å‰è¿˜æœ‰newå¯¹è±¡çš„æ–¹æ³•,éƒ½å·²ç»èµ°å®Œäº†. è¿™ä¸Šé¢çš„æ–¹æ³•,åŸºæœ¬éƒ½æ˜¯å†ä¸ºåé¢çš„è§£æxmlæ–‡ä»¶åšå‡†å¤‡, å¹¶ä¸”è¿˜æœ‰ä¸€äº›åˆå§‹åŒ–æ•°æ®çš„èµ‹å€¼æ“ä½œ.</p>
<p><strong>Note</strong> : æ³¨æ„è¿™é‡Œçš„ BaseBuilderæ˜¯æŠ½è±¡ç±»,å…¶å®ç°ç±»æ˜¯æœ‰å¥½å‡ ä¸ªçš„. è¿™ç§å†™æ³•,å…¶å®æ˜¯å°†å­ç±»çš„ä¸€äº›commonçš„æ–¹æ³•,å†™å…¥åˆ° BaseBuilderçˆ¶ç±»ä¸­,ç„¶åä¸åŒçš„æ–¹æ³•,éœ€è¦å­ç±»è‡ªå·±å»é‡å†™è¿™ä¸ªæ–¹æ³•å®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘. å½“ç„¶ä¸€äº›å‚æ•°ä¹Ÿæ˜¯å¯ä»¥æ”¾åœ¨æŠ½è±¡ç±»ä¸­.</p>
<p><strong>build(parser.parse())</strong> : è§£æä»£ç .</p>
<p> parser.parse() æ–¹æ³• :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public Configuration parse() &#123;</span><br><span class="line">  &#x2F;&#x2F; ç”¨ parsed æ¥æ§åˆ¶æ˜¯å¦è§£æè¿‡,å¦‚æœå·²ç»è§£æè¿‡äº†,é‚£å°±æŠ›å‡ºå¼‚å¸¸.  </span><br><span class="line">  if (parsed) &#123;</span><br><span class="line">    throw new BuilderException(&quot;Each XMLConfigBuilder can only be used once.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  parsed &#x3D; true;</span><br><span class="line">  &#x2F;&#x2F;   </span><br><span class="line">  parseConfiguration(parser.evalNode(&quot;&#x2F;configuration&quot;));</span><br><span class="line">  return configuration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------</span><br><span class="line">&#x2F;&#x2F; parseConfiguration</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œ debug å¯ä»¥çœ‹åˆ° root æ˜¯ configuration çš„é…ç½®æ–‡ä»¶ä¿¡æ¯.   </span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œå¯ä»¥åˆæ­¥çœ‹åˆ°å®å¯¹ æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶mybatis-config.xmlè¿›è¡Œè§£æ,å¹¶ä¸”åŠ è½½åˆ° configurationä¸­.</span><br><span class="line">&#x2F;&#x2F; åé¢æˆ‘ä»¬è·Ÿç€å®˜ç½‘æ–‡æ¡£ä¸€æ­¥ä¸€æ­¥çš„é˜…è¯»,ä¼šæœ‰ä¸“é—¨å¯¹è§£æé…ç½®çš„æºç è¿›è¡Œåˆ†æ.    </span><br><span class="line">  private void parseConfiguration(XNode root) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      &#x2F;&#x2F;issue #117 read properties first</span><br><span class="line">      &#x2F;&#x2F;   </span><br><span class="line">      propertiesElement(root.evalNode(&quot;properties&quot;));</span><br><span class="line">      Properties settings &#x3D; settingsAsProperties(root.evalNode(&quot;settings&quot;));</span><br><span class="line">      loadCustomVfs(settings);</span><br><span class="line">      loadCustomLogImpl(settings);</span><br><span class="line">      typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</span><br><span class="line">      pluginElement(root.evalNode(&quot;plugins&quot;));</span><br><span class="line">      objectFactoryElement(root.evalNode(&quot;objectFactory&quot;));</span><br><span class="line">      objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</span><br><span class="line">      reflectorFactoryElement(root.evalNode(&quot;reflectorFactory&quot;));</span><br><span class="line">      settingsElement(settings);</span><br><span class="line">      &#x2F;&#x2F; read it after objectFactory and objectWrapperFactory issue #631</span><br><span class="line">      environmentsElement(root.evalNode(&quot;environments&quot;));</span><br><span class="line">      databaseIdProviderElement(root.evalNode(&quot;databaseIdProvider&quot;));</span><br><span class="line">      typeHandlerElement(root.evalNode(&quot;typeHandlers&quot;));</span><br><span class="line">      mapperElement(root.evalNode(&quot;mappers&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>build(parser.parse()) æ–¹æ³•</strong></p>
<p>è¿™é‡Œæ˜¯å¯¹ parser.parse() è°ƒç”¨ç©è¿”å›çš„ Configuration ä¼ å…¥åˆ°æ–°åˆ›å»ºçš„ DefaultSqlSessionFactory å¯¹è±¡ä¸­.</p>
<p>ä¹Ÿå°±æ˜¯è¯´,æˆ‘ä»¬æ‹¿åˆ°çš„ SqlSessionFactory æ˜¯ DefaultSqlSessionFactory.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(Configuration config) &#123;</span><br><span class="line">  return new DefaultSqlSessionFactory(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è·å– SqlSession</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">SqlSession session &#x3D; sqlSessionFactory.openSession();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; org.apache.ibatis.session.defaults.DefaultSqlSessionFactory#openSessionFromDataSource</span><br><span class="line">&#x2F;&#x2F; çœ‹åˆ°è¿™ä¸ªæ–¹æ³•,ç›´æ¥è·Ÿè¿›åˆ°è¿™ä¸ªæ–¹æ³•æ¥.</span><br><span class="line"></span><br><span class="line">  private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) &#123;</span><br><span class="line">    Transaction tx &#x3D; null;</span><br><span class="line">    try &#123;</span><br><span class="line">        </span><br><span class="line">&#x2F;&#x2F; ä» configurationä¸­è·å–å‡ºenvironmentæ¥,è¿™é‡Œçš„ getEnvironmentå¯¹åº”çš„æ˜¯</span><br><span class="line">&#x2F;&#x2F; æ ‡ç­¾çš„ &lt;environment&gt;  é‡Œé¢çš„å†…å®¹</span><br><span class="line">&#x2F;&#x2F; org.apache.ibatis.mapping.Environment</span><br><span class="line">&#x2F;&#x2F; å¯ä»¥çœ‹åˆ°è¿™ä¸ªå¯¹è±¡,idå¯¹åº”mybatis-config.xmlä¸­çš„environment id</span><br><span class="line">&#x2F;&#x2F; datasource å¯¹åº”  environment &gt; dataSource å­—æ®µ.</span><br><span class="line">      final Environment environment &#x3D; configuration.getEnvironment();</span><br><span class="line">&#x2F;&#x2F; æ ¹æ®    environment æ¥è·å– TransactionFactory,ä¹Ÿå°±æ˜¯MyBatisçš„äº‹åŠ¡å·¥å‚.</span><br><span class="line">&#x2F;&#x2F; debug æ˜¯å¯ä»¥çœ‹åˆ°  environment ä¸­æ˜¯æœ‰ä¸€ä¸ªJdbcTransactionFactoryçš„,</span><br><span class="line">&#x2F;&#x2F; å¦‚æœæ²¡ç”¨çš„è¯,å°±ä¼šè‡ªå·±newä¸€ä¸ª ManagedTransactionFactory æ¥.        </span><br><span class="line">      final TransactionFactory transactionFactory &#x3D; getTransactionFactoryFromEnvironment(environment);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; åœ¨ JdbcTransactionFactory ä¸­newå‡ºäº†ä¸€ä¸ª JdbcTransaction</span><br><span class="line">&#x2F;&#x2F; ä¹Ÿå°±æ˜¯newäº†ä¸€ä¸ªJDBCäº‹åŠ¡.</span><br><span class="line">&#x2F;&#x2F; org.apache.ibatis.transaction.jdbc.JdbcTransaction,</span><br><span class="line">&#x2F;&#x2F; å¯ä»¥çœ‹åˆ° JdbcTransaction ä¸­æœ‰commit &#x2F; rollbackçš„æ–¹æ³•,</span><br><span class="line">&#x2F;&#x2F; ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªåœ°æ–¹å°±æ˜¯å¯¹äº‹åŠ¡è¿›è¡Œæ“ä½œçš„åœ°æ–¹        </span><br><span class="line">      tx &#x3D; transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæ˜¯è·å–æ˜¯æ‰§è¡Œå™¨,</span><br><span class="line">&#x2F;&#x2F; å…·ä½“ä»£ç : org.apache.ibatis.session.Configuration#newExecutor(org.apache.ibatis.transaction.Transaction, org.apache.ibatis.session.ExecutorType)</span><br><span class="line">&#x2F;&#x2F; è¿™é‡Œæœ‰ SIMPLE, REUSE, BATCH ,CachingExecutor è¿˜å¯ä»¥åœ¨ plugin ä¸­è‡ªå·±å®šä¹‰.</span><br><span class="line">&#x2F;&#x2F;executor &#x3D; (Executor) interceptorChain.pluginAll(executor); ä»è¿™è¡Œä»£ç å¯ä»¥çœ‹åˆ°,</span><br><span class="line">&#x2F;&#x2F; å…¶å®è¿˜æ˜¯å¯ä»¥è‡ªå·±æ‰©å±•çš„.        </span><br><span class="line">&#x2F;&#x2F;org.apache.ibatis.plugin.InterceptorChain        </span><br><span class="line">      final Executor executor &#x3D; configuration.newExecutor(tx, execType);</span><br><span class="line">&#x2F;&#x2F; æœ€å new å‡ºäº†ä¸€ä¸ªé»˜è®¤çš„ SqlSession ä¼šè¯.</span><br><span class="line">&#x2F;&#x2F; è¯¥ä¼šè¯ä¸­å­˜æœ‰ configuration &#x2F; executor ç­‰æ ¸å¿ƒä¸œè¥¿.        </span><br><span class="line">      return new DefaultSqlSession(configuration, executor, autoCommit);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      closeTransaction(tx); &#x2F;&#x2F; may have fetched a connection so lets call close()</span><br><span class="line">      throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">&#x2F;&#x2F; æœ€åè¿˜æ˜¯ä¸å¿˜è®°å¯¹ä½¿ç”¨è¿‡çš„ThreadLocal è¿›è¡Œremove æ“ä½œ.        </span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤, å¯ä»¥çœ‹åˆ° MyBatis ä»SqlSessionFactoryä¸­è·å–å‡ºæ¥SqlSessionä¼šè¯, ä¹Ÿå¯ä»¥ç†è§£ä¸ºå‡ ä¸ªæ­¥éª¤.</p>
<p>é¦–å…ˆè·å–äº‹åŠ¡å·¥å‚, ç„¶åå†ä»äº‹åŠ¡å·¥å‚ä¸­è·å–ä¸€ä¸ªäº‹åŠ¡æ¥, JdbcTransaction æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹è¿™ä¸ªç±»,é‡Œé¢ä¹Ÿæ˜¯å°è£…äº†å†™ commit / rollbackç­‰æ–¹æ³•. å†æ¥ç€è·å–å‡º æ‰§è¡Œå™¨(Executor),è¿™é‡Œä»ä»£ç å“ªé‡Œçœ‹,æ‰§è¡Œå™¨è¿˜æ˜¯æœ‰å‡ ç§ç±»å‹çš„,ä¹Ÿæ‰§è¡Œè‡ªå®šä¹‰. æœ€ånewäº†ä¸€ä¸ª DefaultSqlSession å›å».</p>
<p><strong>session.getMapper(BlogMapper.class);</strong></p>
<p>æ¥ç€çœ‹,ä¸Šä¸€æ­¥è¿”å›çš„session,æ˜¯æ€ä¹ˆè·å–åˆ°æˆ‘ä»¬å†™çš„Mapperæ¥å£æ–‡ä»¶(Mapperè¿™ç§æ–‡ä»¶,åœ¨è§£æé…ç½®æ–‡ä»¶çš„æ—¶å€™,å…¶å®å°±å·²ç»è§£æåˆ°MyBatisçš„configurationé‡Œé¢å»äº†).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) &#123;</span><br><span class="line"> &#x2F;&#x2F; knownMappers  ä¸­ key æ˜¯æˆ‘ä»¬å®šä¹‰æ¥å£çš„Class,valueæ˜¯MapperProxyFactory,</span><br><span class="line">&#x2F;&#x2F; MapperProxyFactoryä¸­çš„mapperInterfaceä¸­å­˜æ”¾äº†æˆ‘ä»¬çš„æ¥å£class    </span><br><span class="line">  final MapperProxyFactory&lt;T&gt; mapperProxyFactory &#x3D; (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    </span><br><span class="line">&#x2F;&#x2F; å¦‚æœè·å–å‡ºæ¥çš„æ˜¯null,é‚£ä¹ˆMyBatiså°±è®¤ä¸ºä½ ä¼ å…¥è¿›æ¥çš„æ¥å£æ˜¯ä¸å­˜åœ¨çš„,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.    </span><br><span class="line">  if (mapperProxyFactory &#x3D;&#x3D; null) &#123;</span><br><span class="line">    throw new BindingException(&quot;Type &quot; + type + &quot; is not known to the MapperRegistry.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  try &#123;</span><br><span class="line">&#x2F;&#x2F; æ»¡è¶³æ¡ä»¶çš„è¯,è°ƒç”¨newInstanceæ–¹æ³•,ä»æ–¹æ³•åå­—ä¸Šçœ‹,æ˜¯åˆ›å»ºä¸€ä¸ªinstanceçš„å®ä¾‹.      </span><br><span class="line">    return mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">  &#125; catch (Exception e) &#123;</span><br><span class="line">    throw new BindingException(&quot;Error getting mapper instance. Cause: &quot; + e, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------------------------------</span><br><span class="line">&#x2F;&#x2F; mapperProxyFactory.newInstance(sqlSession) ä»£ç </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  public T newInstance(SqlSession sqlSession) &#123;</span><br><span class="line">    &#x2F;&#x2F; new äº†ä¸€ä¸ª MapperProxyå¯¹è±¡.</span><br><span class="line">    final MapperProxy&lt;T&gt; mapperProxy &#x3D; new MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    return newInstance(mapperProxy);</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æœ€åå¯ä»¥çœ‹åˆ°ä½¿ç”¨ Proxy.newProxyInstanceæ–¹æ³•æ¥åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡.</span><br><span class="line">  @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">  protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123;</span><br><span class="line">    return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------</span><br><span class="line">&#x2F;&#x2F; å¦‚æœä½ æ˜¯debugæ¨¡å¼çš„è¯,é‚£ä¹ˆä½ å¯ä»¥çœ‹åˆ°BlogMapperçš„å¯¹è±¡åœ°å€æ± åœ¨ debug ä¸­æ˜¾ç¤ºçš„å€¼.</span><br><span class="line">&#x2F;&#x2F; org.apache.ibatis.binding.MapperProxy@ef9296d    </span><br><span class="line">BlogMapper blogMapper &#x3D; session.getMapper(BlogMapper.class);</span><br></pre></td></tr></table></figure>

<p>ä»SqlSession ä¸­è·å– BlogMapperæˆ‘ä»¬å†™çš„mapperæµç¨‹, å…ˆä» knownMappers ä¸­æ ¹æ®keyè·å–å‡ºæ¥ä¹‹å‰åŠ è½½é…ç½®å·²ç»åŠ è½½å®Œæ¯•çš„ä¿¡æ¯,å¦‚æœæ²¡ç”¨çš„è¯,å°±ä¼šæŠ›å‡ºæ²¡æœ‰çš„å¼‚å¸¸. æœ€åä½¿ç”¨ Proxy.newProxyIntsanceæ¥ç”Ÿæˆçš„ä¸€ä¸ªç±»ä¼¼æ¥å£å®ç°ç±»çš„ä»£ç ,ä¸åŒçš„æ˜¯, åœ¨ new MapperProxy çš„æ—¶å€™,å°±å·²ç»å°†æ¥ä¸‹æ¥éœ€è¦çš„ä¿¡æ¯å…¨éƒ¨ä¼ å…¥è¿›å».</p>
<p><strong>blogMapper.selectBlog(1) æ–¹æ³•</strong></p>
<p>ç«Ÿç„¶ BlogMapperæ˜¯é€šè¿‡Proxy.newInstanceè·å–å‡ºæ¥çš„,é‚£å®ƒæ˜¯æ€ä¹ˆæŸ¥è¯¢çš„æ•°æ®åº“? åˆæ˜¯æ€ä¹ˆå°†å­—æ®µç»™æ˜ å°„åˆ° Objectä¸€ä¸€å¯¹åº”çš„å‘¢ ?</p>
<p> debugä¼šèµ°åˆ° MapperProxyçš„invokeæ–¹æ³•æ¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    if (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">      return method.invoke(this, args);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return cachedInvoker(method).invoke(proxy, method, args, sqlSession);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (Throwable t) &#123;</span><br><span class="line">    throw ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------</span><br><span class="line">&#x2F;&#x2F; é€šè¿‡ invoke æ–¹æ³•, èµ° mapperMethodçš„executeæ–¹æ³•,æ¥åˆ°äº†è¿™é‡Œ.</span><br><span class="line">&#x2F;&#x2F; switch æœ‰ INSERT&#x2F;UPDATE&#x2F;DELETE&#x2F;SELECT&#x2F;FLUSH,å¦‚æœè¿™å‡ ç§æ²¡æœ‰åŒ¹é…åˆ°çš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸æ¥.    </span><br><span class="line">  public Object execute(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    switch (command.getType()) &#123;</span><br><span class="line">            </span><br><span class="line">&#x2F;&#x2F; ä¸éš¾çœ‹åˆ° INSERT&#x2F;UPDATE&#x2F;DELETEéƒ½æ˜¯å…ˆè°ƒç”¨ convertArgsToSqlCommandParam æ–¹æ³•,</span><br><span class="line">&#x2F;&#x2F; ä¹Ÿå°±æ˜¯å…ˆå°†å‚æ•°è½¬åŒ–ä¸ºsql,ç„¶åå°†æ‰§è¡Œçš„ç»“æœ èµ‹å€¼ ç»™ result å‚æ•°.            </span><br><span class="line">      case INSERT: &#123;</span><br><span class="line">        Object param &#x3D; method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result &#x3D; rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case UPDATE: &#123;</span><br><span class="line">        Object param &#x3D; method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result &#x3D; rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case DELETE: &#123;</span><br><span class="line">        Object param &#x3D; method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result &#x3D; rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">&#x2F;&#x2F; å¦‚æœæ˜¯ select è¯­å¥,å¯ä»¥æ ¹æ®è¿”å›å€¼æ¥åˆ†ç±»,å¦‚æœæ˜¯void&amp;&amp;method.hasResultHandler,å°±ä¼šè¿”å›null</span><br><span class="line">&#x2F;&#x2F; å¤šä¸ª &#x2F; Mapç±»å‹  &#x2F;    Cursor ç±»å‹   &#x2F;  æœ€åæŸ¥è¯¢ä¸€ä¸ª        </span><br><span class="line">      case SELECT:</span><br><span class="line">        if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">          executeWithResultHandler(sqlSession, args);</span><br><span class="line">          result &#x3D; null;</span><br><span class="line">        &#125; else if (method.returnsMany()) &#123;</span><br><span class="line">          result &#x3D; executeForMany(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsMap()) &#123;</span><br><span class="line">          result &#x3D; executeForMap(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsCursor()) &#123;</span><br><span class="line">          result &#x3D; executeForCursor(sqlSession, args);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          Object param &#x3D; method.convertArgsToSqlCommandParam(args);</span><br><span class="line">          result &#x3D; sqlSession.selectOne(command.getName(), param);</span><br><span class="line">          if (method.returnsOptional()</span><br><span class="line">              &amp;&amp; (result &#x3D;&#x3D; null || !method.getReturnType().equals(result.getClass()))) &#123;</span><br><span class="line">            result &#x3D; Optional.ofNullable(result);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line"> &#x2F;&#x2F; åˆ·æ–°ä¼šè¯.           </span><br><span class="line">      case FLUSH:</span><br><span class="line">        result &#x3D; sqlSession.flushStatements();</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        throw new BindingException(&quot;Unknown execution method for: &quot; + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; å¦‚æœresult æ˜¯ null, æ–¹æ³•è¿”å›çš„ä¿®é¥°ç¬¦æ˜¯privateå¹¶ä¸” è¿”å›å€¼ä¸æ˜¯voidçš„è¯,å°±ä¼šæŠ›å‡ºå¼‚å¸¸.    </span><br><span class="line">    if (result &#x3D;&#x3D; null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">      throw new BindingException(&quot;Mapper method &#39;&quot; + command.getName()</span><br><span class="line">          + &quot; attempted to return null from a method with a primitive return type (&quot; + method.getReturnType() + &quot;).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°,å…ˆæ˜¯å¯¹ INSERT / UPDATE / DELETE / SELECT è¿›è¡Œåˆ†ç±»å¤„ç†, ç„¶åå¯¹å†åˆ†åˆ«æ ¹æ®ä¸åŒçš„ç±»å‹è¿›è¡Œå¤„ç†. éƒ½æ˜¯å…ˆæœ‰è½¬åŒ–ä¸ºsql,ç„¶åå°†æ‰§è¡Œç»“æœèµ‹å€¼ç»™result.</p>
<p>è‡³äºé‡Œé¢è¯¦ç»†çš„æŸ¥è¯¢æ‰§è¡Œsql,è¿˜æœ‰åŠ¨æ€sql,æ¯æ¬¡ä¼šè¯ç¼“å­˜ç­‰,åé¢çœ‹åˆ°è¯¦ç»†çš„æƒ…å†µå†ä¸€ä¸€è¯´æ˜. è¿™é‡Œåªæ˜¯å¯¹MyBatisçš„åŸºæœ¬å·¥ä½œè¿›è¡Œäº†ä¸€ä¸ªæ¢³ç†. ç„¶ååé¢å†æ ¹æ®åŸºç¡€æ¢³ç†,å†æ¥æŒ¨ä¸ªå‡»ç¢ä»–ä»¬.</p>
<p>è‡³æ­¤, MyBatisçš„å…¥é—¨åˆ†ææµç¨‹æ˜¯ç»“æŸçš„. ç†è§£èµ·æ¥,åº”è¯¥è¿˜ä¸æ˜¯é‚£ä¹ˆéš¾.</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æ ¹æ® com.iyang.mybatis.InitHelloMyBatis , ä¹Ÿå°±æ˜¯å…¥é—¨çš„demoæ¥æ¢³ç†ä¸‹æµç¨‹.</p>
<ol>
<li>è¯»å–é…ç½®æ–‡ä»¶,ä¹Ÿå°±æ˜¯å°†é…ç½®æ–‡ä»¶è¯»å–,è½¬åŒ–ä¸ºinptStreamæµ.</li>
<li>åˆ©ç”¨ SqlSessionFactoryBuilder æ¥ è§£ææµ, èµ·å†…éƒ¨åˆåˆ©ç”¨ BaseBuilder(å…¶åˆå¾ˆå¤šå®ç°ç±»,è¿™é‡Œç”¨çš„XMLConfigBuilder)ä¹Ÿè§£æxmlé…ç½®æ–‡ä»¶. Configuration configuration è¯¥ç±»ä¸­æ˜¯ä¿å­˜ç€xmlé…ç½®æ–‡ä»¶çš„å¾ˆå¤šä¿¡æ¯. ç„¶å DefaultSqlSessionFactory ä¸­æœ‰configurationå­—æ®µ,ä¹Ÿå°±æ˜¯å±æ€§.</li>
<li>ç„¶åä» DefaultSqlSessionFactory ä¸­è·å– SqlSessionæ¥, å¹¶ä¸”ä¹Ÿä¼šæ˜¯å¦å¼€å¯äº‹åŠ¡(å‚è€ƒ:org.apache.ibatis.transaction.jdbc.JdbcTransaction)ç±»,ç„¶åè·å– Executor,Executorä¹Ÿæ˜¯æœ‰å‡ ç§ç§ç±»çš„,ä¹Ÿå¯ä»¥è‡ªå·±è‡ªå®šä¹‰,æœ€åè¿”å›ä¸€ä¸ª DefaultSqlSession æ¥.</li>
<li>ç„¶åä» SqlSession ä¸­è·å–æˆ‘ä»¬çš„æ¥å£Mapper, æœ€åä¹Ÿæ˜¯åˆ©ç”¨ Proxy.newProxyInstance æ¥ç”Ÿæˆçš„æ¥å£,ä¹Ÿå°±æ˜¯ä»£ç†(è¿™é‡Œæ‰“å°å‡ºåœ°å€æ± æˆ–è€…debugçœ‹åœ°å€æ± ,å°±ä¼šå¾ˆæ˜æ˜¾çš„çœ‹åˆ°æ˜¯ä»£ç†å¯¹è±¡).</li>
<li>æœ€åèµ°æŸ¥è¯¢çš„æ–¹æ³•, ä¹Ÿå°±æ˜¯èµ°åˆ°äº† MapperProxy æ¥. å¯ä»¥çœ‹åˆ°MapperProxyé‡Œé¢æ˜¯æœ‰sqlSessionçš„,è€ŒSqlSessionæ˜¯æœ‰ Executor/configuration/autoCommitç­‰ä¿¡æ¯çš„, æœ‰äº†sqlSession,å°±å‰©ä¸‹æ‰§è¡Œsqlå’Œæ˜ å°„sqlæŸ¥è¯¢å‡ºæ¥çš„ç»“æœæ¥äº†(è¿™é‡Œæ˜¯ mapperMethod.execute(sqlSession, args) â€”&gt; org.apache.ibatis.binding.MapperMethod#execute èµ°åˆ°è¿™é‡Œæ¥äº†,è¿™é‡Œä¹‹åå°±ä¼šåˆ†ç±»è¿›è¡Œå¤„ç†,ç„¶åæ˜ å°„sqlè¯­å¥).</li>
<li>è‡³æ­¤,ä¸€ä¸ª MyBatis çš„ HelloWorldåˆ†ææµç¨‹æ˜¯å®Œæ¯•çš„.</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lwfby.cn/2020/11/29/life/%E7%88%AC%E5%B1%B1&%E8%BF%90%E5%8A%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YangL">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YangL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/29/life/%E7%88%AC%E5%B1%B1&%E8%BF%90%E5%8A%A8/" itemprop="url">çˆ¬å±±&è¿åŠ¨</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-11-29T23:25:59+08:00">
                2020-11-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index">
                    <span itemprop="name">ç”Ÿæ´»è®°å½•</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  716
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="çˆ¬å±±"><a href="#çˆ¬å±±" class="headerlink" title="çˆ¬å±±"></a>çˆ¬å±±</h4><p>â€‹    è·ç¦»ä¸Šæ¬¡çˆ¬ä¸Šå¤§æ¢§æ¡ï¼Œåº”è¯¥æ˜¯è¿‡å»äº†ä¸€å¹´äº†. è¯´æ¥ä¹Ÿæ˜¯å¥½å¥‡,è¿™æ¬¡çˆ¬ä¸Šå¤§æ¢§æ¡çš„é“è·¯å’Œå»å¹´çˆ¬ä¸Šå¤§æ¢§æ¡çš„ä¸Šå±±ä¹‹é“ä¸ä¸€æ ·,æ‰€ä»¥æˆ‘ä¹Ÿå¯ä»¥å¾ˆè£…Bçš„è¯´å¥ :  <strong>å®Œæˆä¸€æ ·çš„ä»»åŠ¡æˆ–è€…åšä¸€æ ·ä¸œè¥¿çš„æ—¶å€™,æ–¹å¼æœ‰å¾ˆå¤šç§,ä½ å¯ä»¥å°è¯•å¾ˆå¤šç§,æ‰¾åˆ°æœ€åˆé€‚è‡ªå·±çš„(hhhhhh).</strong></p>
<blockquote>
<p>â€‹     ç”±äºç°åœ¨åœ°é“å¼€é€šäº†,å¯ä»¥ç›´æ¥ååœ°é“åˆ°æ¢§æ¡å±±çš„å…¥å£,ç›¸æ¯”äºä¹‹å‰åªèƒ½ååœ°é“è½¬å…¬äº¤ï¼Œç°åœ¨æœ‰äº†åœ°é“,æ˜¯çœŸçš„æ–¹ä¾¿å¾ˆå¤šå‘€.</p>
<p>â€‹       è·¯çº¿  :   å°æ¢§æ¡ä¸Š â€”&gt; å¤§æ¢§æ¡ â€” &gt; å°æ¢§æ¡ä¸‹.</p>
<p>â€‹       ç”¨æ—¶  :    9:30å¤šå¼€å§‹, ç„¶åå››ç‚¹ä¸‹.  ä¸­é—´è¿˜æœ‰å„ç§ä¼‘æ¯æ—¶é—´ç­‰.</p>
<p>â€‹        </p>
<p>â€‹       æ€»ç»“ :   æ€»ä½“é˜”åˆ«ä¸€å¹´å†ä¸Šå¤§æ¢§æ¡,å†…å¿ƒå¤šå¤šå°‘å°‘è¿˜æ˜¯æœ‰ç‚¹æ³¢åŠ¨çš„,æ¯•ç«Ÿå»å¹´ä¸€èµ·çˆ¬ä¸Šå»çš„äºº,éƒ½æ²¡å†çº¦äº†.æ‰€ä»¥è¿™æ¬¡çˆ¬ä¸Šå»,æ˜¯æˆ‘å’Œæˆ‘è¡¨å§(èŒä¸šçˆ¬å±±ï¼Ÿ). hhhhh. </p>
<p>â€‹                    çˆ¬å°æ¢§æ¡çš„æ—¶å€™,ä¼‘æ¯åˆ°æ¯”è¾ƒå°‘,æ‰€ä»¥åœ¨çˆ¬çš„æ—¶å€™,ä¹Ÿéš¾å…ä¼šå‡ºç°è¡£æœä¸Šéƒ½æ˜¯æ±‰çš„. è¿™ä¹Ÿæ˜¯æˆ‘ä¸æ™“å¾—å¤§çº¦è¿‡äº†å¤šä¹…ä¹‹å,å†å‡ºç°è¿™ç§éƒ½æ˜¯æ±‰çš„æ„Ÿè§‰. ç„¶åå†ä¸Šå¤§æ¢§æ¡çš„æ—¶å€™,è¿™ç§æ„Ÿè§‰å°±æ²¡æœ‰è¿™ä¹ˆå¼ºçƒˆäº†å§.</p>
<p>â€‹                    å¥½æ±‰å¡è¿˜æ˜¯å“ªä¸ªå¥½æ±‰å¡,ç»™äººçœ‹ä¸Šå»ç¬¬ä¸€çœ¼çš„æ„Ÿè§‰å°±å¥½éš¾.å…¶å®ä¸Šè¿‡ä¸€æ¬¡çš„è¯,æˆ‘æ„Ÿè§‰éƒ½è¿˜å¥½. å› ä¸ºä½ çˆ¬å®Œå¥½æ±‰å¡ä¹‹å,å…¶å®åé¢è¿˜æ˜¯æœ‰ä¸€å°æ®µè·ç¦»çš„.</p>
<p>â€‹                   æœ€ååˆ°äº†å±±é¡¶,äººè¿˜æ˜¯è›®å¤šçš„. åº”è¯¥æ¥è¿™å„¿æ‰“å¡çš„äººä¼šæ¯”è¾ƒå±…å¤šå§.</p>
</blockquote>
<h4 id="è¿åŠ¨"><a href="#è¿åŠ¨" class="headerlink" title="è¿åŠ¨"></a>è¿åŠ¨</h4><p>â€‹     è°ˆåˆ°è¿åŠ¨,å°±æƒ³åˆ°æˆ‘ä»å°å…¶å®ä¹Ÿä¸æ˜¯å–œæ¬¢è¿åŠ¨çš„äºº, åå€’æ˜¯ä¸€ä¸ªå–œæ¬¢åƒå–,èƒ½ä¸èµ°çš„è·¯å°±ç»ä¸ä¼šèµ°. è¯´åˆ°è¿åŠ¨,æ„Ÿè§‰ä¹Ÿæ˜¯ä¸€ç§æœºç¼˜å·§åˆçš„æƒ…å†µä¸‹,å¯¼è‡´æˆ‘è¿™æ¬¡ç–¯ç‹‚çš„è·‘æ­¥ä»€ä¹ˆçš„å‘€.</p>
<p>â€‹       </p>
<blockquote>
<p> è¿åŠ¨ä¸ä»…ä»…æ˜¯è·‘æ­¥,ä½†æ˜¯å…ˆé€šè¿‡åšæŒè·‘æ­¥æ¥é”»ç‚¼è‡ªå·±çš„æ„å¿—åŠ›å§.  è¦è‡ªå·±å¯ä»¥åšæŒä¸‹å»,åœ¨æœ‰é™çš„æ—¶é—´å†…,ä¸€ç›´åšæŒä¸‹å»,æœ€å¥½ä¸è¦åšåˆ°åŠé€”è€ŒåºŸ,è¿™æ ·ä¸å¤ªå¥½.</p>
<p>å¸Œæœ›: èƒ½é€šè¿‡è·‘æ­¥æ¥é”»ç‚¼å‡ºè‡ªå·±çš„éŸ§æ€§.  åæœŸæ—¶é—´å°±äº†,èƒ½æ·»åŠ æ›´å¤šçš„å…¶ä»–è¿åŠ¨æ“ä½œ.</p>
<p>æ„Ÿå—:   è·‘æ­¥çš„æ—¶å€™,å¸¦ä¸Šè€³æœº,å°½é‡æ§åˆ¶å‡åŒ€å‘¼å¸,ç„¶åä½ å°±ä¼šå‘ç°,ä½ è·‘åˆ°è¶Šä¹…,åˆ°åé¢çš„å‘¼å¸å¯èƒ½ä¼šæ¯”è¾ƒéš¾æ§åˆ¶ä»€ä¹ˆçš„,è¦ç»å¸¸è·‘,åˆ°åé¢å°±ä¼šæ…¢æ…¢æ§åˆ¶å¥½.  è·‘åˆ°ä¸­é€”çš„æ—¶å€™,å…¶å®è‡ªå·±çš„è„‘å­å°±å·²ç»æ”¾ç©ºäº†å¾ˆå¤šä¸œè¥¿. è¿™ç§æ”¾ç©ºè„‘å­çš„æ„Ÿå—,è¿˜æ˜¯è›®èˆ’æœçš„. </p>
<p><strong>è·‘å®Œè®°å¾—æ‹‰ä¼¸ä¸‹/è·‘å®Œè®°å¾—æ‹‰ä¼¸ä¸‹/è·‘å®Œè®°å¾—æ‹‰ä¼¸ä¸‹</strong></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lwfby.cn/2020/11/25/life/%E4%B9%B0%E8%8F%9C&%E8%B7%91%E6%AD%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YangL">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YangL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/25/life/%E4%B9%B0%E8%8F%9C&%E8%B7%91%E6%AD%A5/" itemprop="url">ä¹°èœ&è·‘æ­¥</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-11-25T23:25:59+08:00">
                2020-11-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index">
                    <span itemprop="name">ç”Ÿæ´»è®°å½•</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  683
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="ä¹°èœ"><a href="#ä¹°èœ" class="headerlink" title="ä¹°èœ"></a>ä¹°èœ</h3><blockquote>
<p>è¯´æ¥ä¹Ÿæ˜¯å¥½ç¬‘ï¼Œç”±äºä»Šå¹´ç–«æƒ…çš„åŸå› ï¼Œå¯¼è‡´ä¸€ä¸ªä¸ä¼šåšé¥­çš„æˆ‘ï¼Œåˆ°ç°åœ¨ä¹Ÿå¯ä»¥åšå‡ºé¥­æ¥äº†,ä¹Ÿæ˜¯å¥‡å¥‡æ€ªæ€ªçš„.</p>
<p>è¿™é‡Œè®°å½•å‰ä¸ä¹…,æˆ‘åœ¨ä¹°èœçš„æ—¶å€™,çœ‹è§ä¸€å“¥ä»¬åœ¨ä¹°é¸¡è›‹çš„æ—¶å€™(è¿™é‡Œå¯ä»¥ä¹°åŒ…è£…å¥½äº†çš„,ä¹Ÿå¯ä»¥ä¹°è‡ªå·±æ‹¿çš„,ä¹Ÿå°±æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„é‚£ç§), ç„¶åæˆ‘çœ‹è§é‚£å“¥ä»¬ä¹°ä¸€ä¸ªä¸€ä¸ªçš„,æ¯ä¸ªéƒ½æ‹¿èµ·æ¥æ‘‡ä¸€ä¸‹,æˆ‘å°±å¥½å¥‡äº†ï¼Œä»–è¯´:  <strong>æ‘‡ä¸€ä¸‹,æ²¡ç”¨é‚£ç§å¾ˆæ•£æˆ–è€…æ¶²ä½“çš„æµåŠ¨çš„è¯,è¿™ä¸ªé¸¡è›‹å°±å¯ä»¥æ”¾åˆ°ä¹…ç‚¹.</strong></p>
</blockquote>
<h3 id="è·‘æ­¥"><a href="#è·‘æ­¥" class="headerlink" title="è·‘æ­¥"></a>è·‘æ­¥</h3><blockquote>
<p>2020-11-25 : è¿™æ˜¯æˆ‘åšæŒè·‘æ­¥çš„ç¬¬åå¤©ï¼Œä»ä¹‹å‰çš„è·¯ç¨‹æ¥çœ‹,æˆ‘ä»ç¬¬ä¸€å¤©çš„2åƒç±³è¿‡æ¸¡åˆ°äº† 2åˆ°4è¿™ä¸‰å¤©çš„ä¸‰åƒå¤šç±³ï¼Œåœ¨è¿‡æ¸¡åˆ°5åˆ°7è¿™ä¸‰å¤©çš„4åƒå¤šç±³, å†åˆ°8åˆ°10è¿™ä¸‰å¤©çš„5åƒå¤šç±³.</p>
<p>ä»è¿™å‡ å¤©è·‘5åƒç±³çš„è¿‡ç¨‹æ¥çœ‹,åœ¨è¿‡æ¸¡åˆ°ç¬¬ä¸‰åƒç±³çš„æ—¶å€™ï¼Œæ˜¯æ¯”è¾ƒéš¾åšæŒä¸‹å»çš„,ä½†æ˜¯ä½ å’¬å’¬ç‰™ï¼Œæƒ³åˆ°ä¸€äº›è®©è‡ªå·±å¾ˆæ„¤æ€’æˆ–è€…å¾ˆå»æœŸå¾…çš„äº‹æƒ…,å†å°±æ˜¯æŠŠæ¡å¥½å‘¼å¸çš„èŠ‚å¥,å…¶ä½™çš„å°±äº¤ç»™è‡ªå·±çš„è…¿åŠ›å•¦.</p>
<p>è·‘å®Œå,ä¸€å®šè¦æ‹‰ä¼¸ä¸‹. æœ€åˆå‡ å¤©æ‹‰ä¼¸çš„æ—¶å€™,è‚¯å®šä¼šæ¯”è¾ƒç—›,æˆ‘åªè¯´: æ…¢æ…¢åšæŒä¸‹æ¥.</p>
</blockquote>
<h3 id="å†™åœ¨æœ€å"><a href="#å†™åœ¨æœ€å" class="headerlink" title="å†™åœ¨æœ€å"></a>å†™åœ¨æœ€å</h3><blockquote>
<p>è¿™æ®µæ—¶é—´,å› ä¸ºä¸€äº›äº‹æƒ…æˆ–è€…ä¸ªäººåŸå› ,æˆ‘æ€»æ˜¯å¾ˆæ¶ˆæ,å…·ä½“åŸå› ä¹Ÿæ²¡æœ‰å¥½è¯´çš„.</p>
<p>äºæ˜¯,ç°åœ¨å†™è¿™ä¸ª,è™½ç„¶æˆ‘æ²¡æœ‰å®Œå…¨ä»é‚£ç§å¾ˆæ‚²ä¼¤çš„æƒ…å†µä¸­èµ°å‡ºæ¥,ä½†æ˜¯è‡³å°‘æˆ‘ä¸ä¼šåƒä¹‹å‰,çœŸçš„æ˜¯,æ¯å¤©éƒ½å—é‚£ç§æƒ…å†µæ‰€å½±å“,æ‰€éš¾å—.</p>
<p>ä»æˆ‘ç°åœ¨,ä¸‹ç­å›æ¥å°±å»è·‘æ­¥,ç„¶ååšé¥­(ç¬¬äºŒå¤©å¸¦å»å…¬å¸åƒ),ç„¶ååšä¸€ç»„Keepï¼Œå®Œå®Œå…¨å…¨çš„å……å®äº†è‡ªå·±å¤§æ™šä¸Šçš„æ—¶å€™.</p>
<p>å¦‚æœæ™šä¸Šæ²¡æ—¶é—´ï¼Œæˆ‘è¿˜ç«‹ä¸‹äº†é‚£ä¹ˆå¤šç›®æ ‡å‘¢ï¼Ÿ</p>
<p>æ¯”å¦‚:  æ¯å‘¨ å½•ä¸€ä¸ª æºç çš„è§†é¢‘(æ‰‹åŠ¨ç‹—å¤´,è™½ç„¶ç°åœ¨è‡ªå·±éƒ½ä¸æ€ä¹ˆæ˜ç™½hhhhh).</p>
<p>â€‹           åšæŒCoding/åšæŒå­¦ä¹ æ–°æŠ€æœ¯/åšæŒå»äº†è§£åº•å±‚</p>
<p>â€‹           åšæŒè·‘æ­¥/åšæŒåšé¥­</p>
<p>â€‹           åšæŒæ‘„å½±(è™½ç„¶ç°åœ¨æ‹å‡ºæ¥çš„éƒ½æ˜¯åºŸç‰‡)</p>
<p>â€‹           å­¦ä¹ è‹±è¯­(è§„åˆ’)</p>
<p>â€‹           å­¦æ™®é€šè¯æ ‡å‡†.</p>
<p>â€‹           æ¯æœˆçœ‹ä¸€æœ¬æ–‡å­¦ä¹¦ç±(<strong>ä¸æ˜¯æŠ€æœ¯ä¹¦ç±,ä¸æ˜¯æŠ€æœ¯ä¹¦ç±,ä¸æ˜¯æŠ€æœ¯ä¹¦ç±</strong>.).</p>
<p>æƒ³ä¹‹å:    å­¦ä¼šæ¸¸æ³³(ç­‰æˆ‘ç˜¦ä¸‹å»,ä¸€å®šè¦å­¦èŠ±å¼).</p>
<p>â€‹                 ç…§ç‰‡çš„åæœŸå¤„ç†</p>
<p>â€‹                è§†é¢‘çš„å‰ªè¾‘å’Œå»æ‚éŸ³(hhhh,è¿™ä¸ªåº”è¯¥ç°åœ¨å°±è¦å­¦ä¹ çš„.).</p>
</blockquote>
<p>æœ€å,æœ›çœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„äººå•Š,æˆ‘ä»¬ä¸€èµ·åŠ æ²¹,ä¸€èµ·å»æœŸå¾…ä¸‹ä¸€ä¸ªæ›´å¥½çš„è‡ªæˆ‘.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lwfby.cn/2020/11/22/life/%E5%85%B3%E4%BA%8E%E5%A4%B1%E6%81%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YangL">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YangL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/22/life/%E5%85%B3%E4%BA%8E%E5%A4%B1%E6%81%8B/" itemprop="url">å¦‚ä½•é¢å¯¹å¤±æ‹</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-11-22T16:26:59+08:00">
                2020-11-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index">
                    <span itemprop="name">ç”Ÿæ´»è®°å½•</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  1.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Why"><a href="#Why" class="headerlink" title="Why ?"></a>Why ?</h3><p>   ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç« å‘¢ï¼Ÿ</p>
<p>   å¯¹æ„Ÿæƒ…å¤ç›˜ï¼Œæ™“å¾—è‡ªå·±çš„é—®é¢˜ï¼Œå‹‡æ•¢çš„å»é¢å¯¹ï¼Œå»é¢å¯¹æœ€çœŸå®çš„è‡ªå·±ã€‚</p>
<blockquote>
<p>   å¯¹ï¼Œä½ æ²¡çœ‹é”™ï¼Œæˆ‘2020-10-24,æ™šä¸Š8ç‚¹åå¤šåˆ†é’Ÿ,æˆ‘åˆ†æ‰‹äº†.</p>
<p>   ç–‘é—®å¥å¼çš„åˆ†æ‰‹.  å¦‚æœæˆ‘è¯´åˆ†æ‰‹å‘¢ï¼Ÿ</p>
<p>   å…¶å®å¤±æœ›å¹¶ä¸æ˜¯ä¸€ç¬é—´æœ‰çš„,ä½†æ˜¯è¯´åˆ†æ‰‹ä»¥åŠè¦åˆ†æ‰‹,æ˜¯å®å®åœ¨åœ¨çš„ä¸€ç¬é—´å°±å¯ä»¥çš„.</p>
<p>  è¿™é‡Œå¯ä»¥è¯´ï¼Œå•æ–¹é¢å…¨éƒ¨éƒ½æ˜¯æˆ‘çš„é—®é¢˜.</p>
<p>  å¦‚æœæˆ‘è¯´ é‚£æ¯ ä¹Œç³–ç›å¥‡æœµ å¾ˆå¥½å–ï¼Ÿä¸å¤šå¯¹ä½ ç…äºŒä¸‹ï¼Ÿ å¤šä¸»åŠ¨è¯´ä¸€äº›è¯é¢˜ ? å¤šå»å…³å¿ƒä¸‹ä½ çš„è¯é¢˜ ? å»ç»™ä½ ä¸»åŠ¨å¤¹èœ ï¼Ÿ  å»â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>
<p>  æœ€åæˆ‘ç°åœ¨ç¼–å†™äº2020-11-22, ç°åœ¨ä¹Ÿæ˜¯å¯¹é‚£æ—¶çš„æˆ‘ä»¥åŠæˆ‘ä»¬æ¥å¤ç›˜ã€‚ é”™è¯¯99%éƒ½æ˜¯æˆ‘,å¦‚æœç¡¬æ˜¯è¯´é‚£1%çš„é”™è¯¯åœ¨å“ª? æˆ‘ä¹Ÿä¼šè¯´ï¼Œåœ¨æˆ‘.  </p>
<p>  p1:  æˆ‘çš„ä¸ä¸»åŠ¨ä»¥åŠåšäº‹æ²¡ä¸»è§(æ€•æ˜¯æœ€åçš„æ²¡ä¸»è§ï¼Œæ˜¯æœ€åæ€æ­»çš„æˆ‘.). </p>
<p>  p2:  é‚£äº›æˆ‘ç…ä½ çš„ç»†èŠ‚,éƒ½æ˜¯æˆ‘å¯¹è‡ªå·±æƒ…ç»ªçš„ä¸æ»¡,æœ€åä¹Ÿç»™ä½ ç•™ä¸‹äº†å¾ˆå¤šä¸å¥½çš„å°è±¡(è¿™é‡Œ,æˆ‘çœŸè¯šç”šè‡³æ¯”è¾ƒå¥¢æ±‚çš„æ±‚ä½ å¿˜è®°è¿™äº›ä¸å¥½,å¦‚æœä»£ä»·æ˜¯å¿˜è®°æˆ‘,é‚£æˆ‘ä¹Ÿæ˜¯OKçš„).</p>
<p>  p3:  å¯¹ä½ ,æˆ‘æƒ³ä¹Ÿè®¸æ²¡æœºä¼šäº†.    ä»¥åï¼Œæˆ‘æ°¸è¿œä¸ä¼šå¤±çº¦äº†.</p>
<p>  p4:  å¦‚æœä¹‹å‰ä¸è§„åˆ’ä»¥å,æˆ‘æƒ³ç°åœ¨ä¹Ÿä¸ä¼šè¿™ä¹ˆéš¾å—â€¦. éš¾å—åˆ°ä»€ä¹ˆåœ°æ­¥æ¥äº†å‘¢ï¼Ÿ æ€»æ˜¯æƒ³åˆ°ä¹Ÿè®¸ä»¥åçš„ä»€ä¹ˆéƒ½æ²¡æ„æ€äº†, æƒ³ç€è¿™è¾ˆå­æ€ä¹ˆè¿‡éƒ½æ˜¯è¿‡. å’Œæœ‹å‹å–é†‰è¿‡å‡ æ¬¡, æƒ³å¾—éƒ½æ˜¯ä½ .  æˆ‘ä¹ŸæŠ½äº†è¿™äº›å¹´æˆ‘æ²¡éƒ½æ²¡æŠ½è¿‡çš„çƒŸ. 2020-10-30 , è¿™å¤©æ™šä¸Šï¼Œæˆ‘åœ¨æ·±åœ³äº”å’Œåœ°é“å£Cå‡ºæ¥å¾€ä¸Šèµ°,äºŒå··åäº”å·çš„å¤©å°ï¼ŒæŠ½äº†ä¸€åŒ…é»„é¹¤æ¥¼.   æŠ½åˆ°æƒ³å,ç”šè‡³æˆ‘å½“æ—¶å°±åœ¨æƒ³,å’¦ï¼Œ å°¼å¤ä¸ä¸€æ¬¡æ‘„å…¥æ€ä¹ˆå¤šï¼Œæˆ‘æ€ä¹ˆè¿˜æ²¡äº‹å‘¢ï¼Ÿ ä¹Ÿæ˜¯å¥½å¥‡. </p>
<p>â€‹        äºæ˜¯ç¬¬äºŒå¤©æˆ‘å°±å»æ‰¾ä½ , å…¶å®æœˆæœ«ä¸æœˆæœ«ï¼Œå°å‘¨å…­ä¸å°å‘¨å…­çš„ï¼Œæˆ‘åˆä¼šæ€ä¹ˆä¸æ™“å¾—å‘¢ï¼Ÿ </p>
<p>â€‹         æˆ‘å°±æ˜¯æƒ³å»çœ‹ä½ ï¼Œå“ªæ€•åŒ†åŒ†ä¸€çœ¼â€¦â€¦â€¦</p>
<p>â€‹        è‡³æ­¤ï¼Œæˆ‘å½“ä½ çš„é¢è¯´çš„æœ€åä¸€å¥èŠ±ï¼Œä¹Ÿæ˜¯: æˆ‘è¿˜çˆ±ä½ .</p>
</blockquote>
<hr>
<h3 id="What"><a href="#What" class="headerlink" title="What?"></a>What?</h3><p>  ä»2020-11-01åï¼Œæˆ‘æ˜¯æ€ä¹ˆè¿‡çš„å‘¢ï¼Ÿ</p>
<p>  è¯´æ¥ä¹Ÿæ˜¯å¥½ç¬‘. </p>
<p>  ä¸å–œæ¬¢ä½ çš„äººï¼Œå¥¹ä¼šè¿ä½ åœ¨10-31 æ™šä¸Šå»å“ªé‡Œç¡è§‰ï¼Ÿå»å“ªé‡Œï¼Ÿå»å“ªé‡Œï¼Ÿå»å“ªé‡Œï¼Ÿéƒ½ä¸ä¼šå…³å¿ƒã€‚</p>
<p>  ä¸è¿‡ï¼Œä¹Ÿå¥½åœ¨æ²¡ç”¨å…³å¿ƒhhhhh</p>
<p>   é‚£å¤œï¼Œæˆ‘åœ¨æ­¦æ±‰ç«™ï¼Œå‘†äº†æ•´æ•´ä¸€å¤œï¼Œå¾€å‰èµ°æœ‰é’Ÿç‚¹æˆ¿ï¼Œæˆ‘æ²¡å»ã€‚ æˆ‘å°±æƒ³æ„Ÿå—ä¸‹ï¼Œé‚£ç§å¿ƒç—›ä»¥åŠæœ€åçš„ç»æœ›ä¼šç»™æˆ‘å¸¦æ¥ä»€ä¹ˆï¼Ÿ å¾ˆé—æ†¾,ä»€ä¹ˆéƒ½æ²¡å¸¦æ¥(æ‰€ä»¥ï¼Œå…„å¼Ÿä»¬æˆ–è€…å§å¦¹ä»¬ï¼Œä¸ç®¡æ€ä¹ˆæ ·ï¼Œé¢å¯¹ä»€ä¹ˆï¼Œéƒ½ä¸è¦åƒæˆ‘è¿™æ ·æŠ˜ç£¨è‡ªå·±çš„è‚‰ä½“.).    å…¶å®é‚£å¤œçš„é£å¥½å†·, æ­¦æ±‰ç«™æ›´å†·, å¯æ˜¯æˆ‘çš„å¿ƒæ¯”è¿™è¿˜å†·â€¦â€¦.</p>
<p>â€‹    äºæ˜¯,æˆ‘åœ¨å®¶ä»¥åŠåœ¨å…¬å¸éƒ½æ˜¯ä¸§åˆ°æ­»ï¼Œéƒ½æ˜¯é‚£ç§æ— ç²¾æ‰“é‡‡ï¼Œç”šè‡³éƒ½æ˜¯é‚£ç§æ²¡çœ‹åˆ°ä¸€ä¸ªäººï¼Œéƒ½æƒ³é—®ï¼Œå¥¹ä¸ºä»€ä¹ˆä¼šè¯´åˆ†æ‰‹çš„è¯ï¼Ÿä¸ºä»€ä¹ˆä¸è‚¯ç­‰æˆ‘ä¸€ä¸ªæœˆï¼Œæˆ‘è¾èŒå›æ¥. æˆ‘è®°å¾—é‚£æ®µæ—¶é—´,æˆ‘å¼€ä¼š,æˆ‘ç”šè‡³å¼€åˆ°åŠä¸€åŠéƒ½å·å·çš„å“­èµ·æ¥ï¼Œæƒ³èµ·æˆ‘å¯¹å¥¹è¯´çš„è‡ªå·±çš„æƒ³æ³•ä»¥åŠæœªæ¥.  åæ¥å‡ å¤©,æˆ‘å¼€ä¼šå°±å¹²è„†å·å·çš„ååˆ°è§’è½ï¼Œæƒ³åˆ°å¥¹ï¼Œæˆ‘å°±çœ¼çœ¶ç»™çº¢èµ·æ¥ç•™ä¸‹äº†çœ¼æ³ª.    å¯æ˜¯å•Šï¼Œæˆ‘æ›´å¸Œæœ›å¥¹è¿‡çš„æ›´å¥½. æ˜¯æˆ‘è‡ªå·±çš„é—®é¢˜ï¼Œå¼„ä¸¢äº†, æ€ªæˆ‘æ€ªæˆ‘æ€ªæˆ‘. ç„¶ååŠ ä¸Šå®¤å‹ä¸åˆç§Ÿï¼Œæˆ‘ä¸€ä¸‹å­é¢å¯¹çš„é—®é¢˜å•Šï¼Œå°±å¤šèµ·æ¥ï¼Œå·¥ä½œä¸Šå †ç§¯äº†å¥½ä¹…çš„æ´»/å¤±æ‹/æ‰¾ç§Ÿæˆ¿/æ¬å®¶/èµ°å‡ºå¤±æ‹, ç„¶åæˆ‘ä¸€ä¸‹å­å°±çˆ†å‘äº†ï¼Œæˆ‘è§‰å¾—æˆ‘ä¸èƒ½è¿™æ ·ï¼Œæˆ‘ä¸èƒ½å°±è¿™æ ·æ²¡ä»»ä½•è¡ŒåŠ¨ï¼Œæˆ‘è¦å»æ‰¾ç§Ÿæˆ¿ï¼Œæˆ‘è¿˜æƒ³æ‰¾ä¸€ä»½å·¥èµ„é«˜çš„å·¥èµ„ï¼Œæˆ‘è¿˜æƒ³â€¦â€¦å‡è‚¥/æŠ¤è‚¤/æ­é…è¡£æœç­‰.</p>
<p>â€‹    è‡³äºæ€ä¹ˆèµ°å‡ºæ¥ï¼Œä½ åœ¨åˆšåˆšåˆ†æ‰‹çš„æ—¶å€™ï¼Œè‚¯å®šä¼šç‰¹åˆ«å¤±è½ä»¥åŠä¸€åº¦ä¸æ™“å¾—è‡ªå·±è¦å¹²ä»€ä¹ˆï¼Œå¦‚æœä½ è¿˜æ°å¥½æ˜¯ä¸€ä¸ªå·¥ä½œè€…çš„è¯ï¼Œé‚£ä½ å°±ä¼šå‘ç°ï¼Œå¦‚æœä½ ä¿æŒè¿™æ ·çš„çŠ¶æ€ï¼Œä½ ä¼šä¸¢å¤±çš„ä¸ä»…ä»…çš„æ˜¯æ—¶é—´ï¼Œè¿˜æœ‰å·¥ä½œ/ç”Ÿæ´»/æˆé•¿ï¼Œé‚£äº›å¯¹ä½ ä¸€åˆ‡æœ‰å¥½çš„ï¼Œä½ éƒ½ä¼šå‘ç°ï¼Œä½ ä¸¢å¤±äº†.</p>
<p>â€‹    æ‰€ä»¥ï¼Œå½“ä½ é€‰æ‹©è‡ªå·±å»å¿™ç¢Œçš„æ—¶å€™ï¼Œå°±æ˜¯æœ€å¥½èµ°å‡ºæ¥çš„æ—¶å€™.</p>
<p>   å»å¿™ç¢Œå§ï¼Œå»æ”¹å˜è‡ªå·±ï¼Œå»å¤ç›˜é‚£äº›è®©å¥¹/ä»–è§‰å¾—å¾ˆæœ‰é—®é¢˜çš„æ€§æ ¼æˆ–ä¹ æƒ¯â€¦</p>
<hr>
<h3 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h3><p>  å†™åœ¨æœ€åï¼Œæˆ‘ä¹Ÿè¦å»è·‘æ­¥äº†ã€‚</p>
<p>  å¯¹äº†ï¼Œå»æ”¹å˜è‡ªå·±ï¼Œå»è®©è‡ªå·±å˜ä¼˜ç§€ã€‚ å»ç­‰å¾…ä¸‹ä¸€ä¸ªèŠ±æµ·çš„æ—¶å€™ï¼Œå»æ‹å¾ˆå¤šç¾ç¾çš„ç›¸ç‰‡ç•™ç»™ä¸‹ä¸€ä¸ªè‡ªå·±.</p>
<p>  ä¸å¿…æ‹…å¿ƒè‡ªå·±èƒ½ä¸èƒ½é‡åˆ°ä¸‹ä¸€ä¸ªä»€ä¹ˆï¼Œä½ è¦æƒ³åˆ°ï¼šæˆ‘è¦æˆä¸ºä»€ä¹ˆæ ·å­çš„ï¼Ÿæˆ‘å»è¦ç­‰å¾…ä¸‹ä¸€æ¬¡èŠ±æµ·ï¼Ÿ</p>
<p>  æœ€åï¼Œç¥å¤§å®¶ä¸è¦å¤±æ‹.</p>
<p>  å¦‚æœçœŸçš„å¤±æ‹äº†ä¹Ÿä¸è¦æ€•ï¼Œå»è®©è‡ªå·±å˜å¼ºï¼Œå˜ä¼˜ç§€.</p>
<p>â€‹                                                                                                     â€”â€”2020-11-22  å†™äºæ·±åœ³åœ°é“å…­å·çº¿å…ƒèŠ¬ç«™</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lwfby.cn/2020/07/05/article_record/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YangL">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YangL">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/05/article_record/" itemprop="url">æ–‡ç« ä»‹ç»</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-07-05T20:46:59+08:00">
                2020-07-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%96%87%E7%AB%A0/" itemprop="url" rel="index">
                    <span itemprop="name">æ–‡ç« </span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  293
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="é¢˜è®°"><a href="#é¢˜è®°" class="headerlink" title="é¢˜è®°"></a>é¢˜è®°</h4><p>â€‹        è¿™æ˜¯é’ˆå¯¹ç›®å‰å·²æœ‰çš„æ–‡ç« è¿›è¡Œè®°å½•è¯´æ˜.   å¾€åå¸Œæœ›æ¯å‘¨æˆ–è€…è‡ªå·±æœ‰ç©ºçš„æ—¶å€™,å°±å¤šå†™ä¸€äº›æ–‡ç« æˆ–è€…ä¸ªäººè®°å½•ã€‚è¿™å…¶ä¸­è‚¯å®šä¹Ÿæ˜¯æœ‰ä¸€å®šçš„é”™è¯¯çš„,å¦‚æœæ˜¯æœ‰é”™è¯¯çš„çš„åœ°æ–¹,è¿˜æ˜¯å¸Œæœ›å„ä½æœ‰å¿ƒäººå¸®æˆ‘æŒ‡å‡ºæ¥,ç„¶åæˆ‘èƒ½å¤Ÿæ›´æ­£.</p>
<p>â€‹       é‚®ç®±åœ°å€ :  <a href="mailto:1411091515@qq.com">1411091515@qq.com</a></p>
<p>â€‹       QQ : 1411091515</p>
<p>å¯ä»¥é€šè¿‡ä»¥ä¸Šæ–¹å¼è”ç³», æ¬¢è¿æŒ‡å‡ºæœ‰é”™è¯¯çš„åœ°æ–¹.</p>
<h4 id="Spring-ç³»åˆ—"><a href="#Spring-ç³»åˆ—" class="headerlink" title="Spring ç³»åˆ—"></a>Spring ç³»åˆ—</h4><p>â€‹       é˜…è¯» Spring å…¶å†…éƒ¨ä»£ç å®ç°çš„è®°å½•</p>
<table>
<thead>
<tr>
<th>Project</th>
<th>åœ°å€</th>
</tr>
</thead>
<tbody><tr>
<td>Spring</td>
<td>Spring<a href="http://www.lwfby.cn/2020/06/27/spring/Spring_Construction/">æ„é€ å‡½æ•°é˜…è¯»</a>                      Springçš„refresh<a href="http://www.lwfby.cn/2020/06/28/spring/Spring_Refresh/">æ–¹æ³•é˜…è¯»</a>                     Spring<a href="http://www.lwfby.cn/2020/07/02/spring/Spring_Custom/">å°æ‰©å±•ä¸€ä¸‹</a></td>
</tr>
</tbody></table>
<h4 id="Javaæºç ç³»åˆ—"><a href="#Javaæºç ç³»åˆ—" class="headerlink" title="Javaæºç ç³»åˆ—"></a>Javaæºç ç³»åˆ—</h4><p>â€‹     Javaçš„é˜…è¯»æ˜¯å¿…ä¸å¯å°‘çš„,é˜…è¯»æ˜¯éå¸¸æœ‰å¿…è¦çš„.</p>
<table>
<thead>
<tr>
<th>Project</th>
<th>åœ°å€</th>
</tr>
</thead>
<tbody><tr>
<td>Javaé›†åˆç¯‡</td>
<td>Vector<a href="http://www.lwfby.cn/2020/04/29/java_list/Vector/">é˜…è¯»è®°å½•</a>                                                                           LinkedList<a href="http://www.lwfby.cn/2020/04/29/java_list/LinkedList_Source/">é˜…è¯»è®°å½•</a>                             <a href="http://www.lwfby.cn/2020/04/30/java_list/ArrayDeque_Source/">ArrayDeque</a>                                                                                 <a href="http://www.lwfby.cn/2020/05/06/java_list/ArrayList_Source/">ArrayList</a>                                                <a href="http://www.lwfby.cn/2020/05/12/java_list/PriorityQueue_source/">PriorityQueue</a>                                                                             <a href="http://www.lwfby.cn/2020/05/22/java_list/HashMap_Source/">HashMap</a></td>
</tr>
<tr>
<td>Java çº¿ç¨‹ç¯‡</td>
<td><a href="http://www.lwfby.cn/2020/06/20/ThreadLocal_source/">ThreadLocal</a>                       <a href="http://www.lwfby.cn/2020/06/20/ReentrantLock_source/">ReentrantLock</a></td>
</tr>
<tr>
<td>Java åå°„ç¯‡</td>
<td><a href="http://www.lwfby.cn/2020/07/01/java_reflect_1/">åå°„å­¦ä¹ </a></td>
</tr>
</tbody></table>
<p>â€‹      </p>
<h4 id="æŠ€æœ¯æ ˆ"><a href="#æŠ€æœ¯æ ˆ" class="headerlink" title="æŠ€æœ¯æ ˆ"></a>æŠ€æœ¯æ ˆ</h4><p>â€‹     å¯¹äºæŠ€æœ¯äººæ¥è¯´, ä¸€ä¸ªå‘å±•æ–¹å‘çš„æŠ€æœ¯æ ˆæ˜¯å¾ˆé‡è¦çš„ã€‚  ä½ æ€»è¦æ²¿ç€æŸä¸ªæ–¹æ³•èµ°æ‰è¡Œ.   ä¸ç®¡æ€ä¹ˆè¯´,ä¸è¾œè´Ÿè‡ªå·±æƒ³åšä»€ä¹ˆçš„è¿™æ®µæ—¶é—´å°±å¯ä»¥äº†å•¦.</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>â€‹       æœŸå¾…æ¯å¤©çš„æˆé•¿éƒ½ä¸ä¸€æ ·.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/timg.jpg"
                alt="YangL" />
            
              <p class="site-author-name" itemprop="name">YangL</p>
              <p class="site-description motion-element" itemprop="description">I kown today that i am i</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/baoyang23" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="1411091515@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YangL</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">64.1k</span>
  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




<div class="powered-by">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <i class="fa fa-user-md"></i>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°:<span id="busuanzi_value_site_uv"></span>
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>
    </span>
</div>

<script>
      var now = new Date(); 
      function createtime() { 
          var grt= new Date("03/12/2019 12:00:00");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´ 
          now.setTime(now.getTime()+250); 
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
          document.getElementById("timeDate").innerHTML = "æœ¬ç«™å·²å®‰å…¨è¿è¡Œ "+dnum+" å¤© "; 
          document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’"; 
      } 
  setInterval("createtime()",250);
  </script>

        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'manual') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":70,"height":120},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
